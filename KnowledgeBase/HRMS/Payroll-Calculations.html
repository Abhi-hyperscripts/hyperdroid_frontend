<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRMS Payroll Calculation Engine | HyperDroid Knowledge Base</title>
    <!-- Import master theme for brand colors -->
    <link rel="stylesheet" href="../../css/theme.css">
    <style>
        :root {
            /*
             * Map documentation variables to theme.css semantic variables.
             * These automatically adapt to light/dark mode via theme.css.
             */
            --primary-color: var(--brand-primary);
            --primary-dark: var(--brand-primary-dark);
            --primary-light: var(--brand-primary-light);
            --secondary-color: var(--color-success);
            --warning-color: var(--color-warning);
            --danger-color: var(--color-danger);
            --text-color: var(--text-primary);
            --text-muted-color: var(--text-secondary);
            --bg-color: var(--bg-body);
            --card-bg: var(--bg-card);
            --code-bg: var(--bg-card-hover);
            --header-bg: var(--gradient-header);
            --table-hover: var(--bg-card-hover);
            --shadow-color: var(--shadow-xs);
            --shadow-strong: var(--shadow-sm);
            --border-color: var(--border-color);

            /* Documentation-specific colors */
            --tip-bg: var(--color-success-light);
            --tip-border: var(--color-success);
            --warning-bg: var(--color-warning-light);
            --warning-border: var(--color-warning);
            --important-bg: var(--color-info-light);
            --important-border: var(--brand-primary);
            --badge-required-bg: var(--color-danger-light);
            --badge-required-color: var(--color-danger-text);
            --badge-optional-bg: var(--color-info-light);
            --badge-optional-color: var(--color-info-text);
            --footer-bg: var(--bg-tooltip);
            --footer-text: var(--text-inverse);
            --header-text: var(--text-inverse);
            --nav-hover-text: var(--text-inverse);
        }

        /* Dark mode overrides */
        [data-theme="dark"] {
            --tip-bg: var(--success-alpha-10);
            --warning-bg: var(--warning-alpha-10);
            --important-bg: var(--info-alpha-10, rgba(59, 130, 246, 0.15));
            --badge-required-bg: var(--danger-alpha-10);
            --badge-required-color: var(--color-danger-text);
            --badge-optional-bg: var(--info-alpha-10, rgba(59, 130, 246, 0.15));
            --badge-optional-color: var(--brand-primary-light);
        }

        @media (prefers-color-scheme: dark) {
            :root:not([data-theme="light"]) {
                --tip-bg: var(--success-alpha-10);
                --warning-bg: var(--warning-alpha-10);
                --important-bg: var(--info-alpha-10, rgba(59, 130, 246, 0.15));
                --badge-required-bg: var(--danger-alpha-10);
                --badge-required-color: var(--color-danger-text);
                --badge-optional-bg: var(--info-alpha-10, rgba(59, 130, 246, 0.15));
                --badge-optional-color: var(--brand-primary-light);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--bg-color);
        }

        /* Header */
        header {
            background: var(--header-bg);
            color: var(--header-text);
            padding: 28px 20px;
            text-align: center;
        }

        header h1 {
            font-size: 1.4rem;
            margin-bottom: 6px;
            font-weight: 500;
        }

        header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Navigation */
        nav {
            background: var(--card-bg);
            padding: 10px 16px;
            padding-right: 60px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px var(--shadow-strong);
            overflow-x: auto;
        }

        nav ul {
            list-style: none;
            display: flex;
            gap: 8px;
            max-width: 1200px;
            margin: 0 auto;
            flex-wrap: nowrap;
        }

        nav a {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 400;
            font-size: 0.8rem;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        nav a:hover {
            background: var(--primary-color);
            color: var(--nav-hover-text);
        }

        /* Main Content */
        main {
            max-width: 1000px;
            margin: 0 auto;
            padding: 24px 16px;
        }

        /* Sections */
        section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 12px var(--shadow-color);
        }

        section h2 {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        section h2 .section-number {
            background: var(--primary-color);
            color: var(--card-bg);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
        }

        section h3 {
            font-size: 0.95rem;
            font-weight: 500;
            margin: 18px 0 10px;
            color: var(--brand-primary);
        }

        section h4 {
            font-size: 0.85rem;
            font-weight: 500;
            margin: 14px 0 8px;
            color: var(--text-color);
        }

        /* Info Boxes */
        .info-box {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 12px 0;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 0.8rem;
        }

        .info-box.tip {
            background: var(--tip-bg);
            border-left: 3px solid var(--tip-border);
        }

        .info-box.warning {
            background: var(--warning-bg);
            border-left: 3px solid var(--warning-border);
        }

        .info-box.important {
            background: var(--important-bg);
            border-left: 3px solid var(--important-border);
        }

        .info-box .icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 0.85rem;
        }

        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--code-bg);
            font-weight: 500;
            font-size: 0.8rem;
        }

        tr:hover {
            background: var(--table-hover);
        }

        /* Lists */
        ul, ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        li {
            margin-bottom: 6px;
        }

        /* Code */
        code {
            background: var(--code-bg);
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Menlo', 'Monaco', monospace;
            font-size: 0.85em;
        }

        /* Formula blocks */
        .formula-block {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px 20px;
            margin: 14px 0;
            font-family: 'Menlo', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.8;
            overflow-x: auto;
        }

        .formula-block .formula-title {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .formula-highlight {
            background: var(--primary-light);
            color: var(--primary-dark);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 400;
        }

        .badge-required {
            background: var(--badge-required-bg);
            color: var(--badge-required-color);
        }

        .badge-optional {
            background: var(--badge-optional-bg);
            color: var(--badge-optional-color);
        }

        .badge-earning {
            background: #dcfce7;
            color: #166534;
        }

        .badge-deduction {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-employer {
            background: #dbeafe;
            color: #1e40af;
        }

        [data-theme="dark"] .badge-earning {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        [data-theme="dark"] .badge-deduction {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        [data-theme="dark"] .badge-employer {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        /* Step indicators */
        .steps {
            counter-reset: step-counter;
            list-style: none;
            padding-left: 0;
        }

        .steps li {
            counter-increment: step-counter;
            padding-left: 40px;
            position: relative;
            margin-bottom: 14px;
        }

        .steps li::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            width: 24px;
            height: 24px;
            background: var(--primary-color);
            color: var(--card-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.75rem;
        }

        /* Feature Cards */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 14px;
            margin: 14px 0;
        }

        .feature-card {
            background: var(--code-bg);
            padding: 14px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .feature-card h4 {
            margin-top: 0;
            margin-bottom: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .feature-card p {
            font-size: 0.75rem;
            margin: 0;
            color: var(--text-secondary);
        }

        /* Version Timeline */
        .version-timeline {
            display: flex;
            gap: 20px;
            margin: 16px 0;
            padding: 16px;
            background: var(--code-bg);
            border-radius: 8px;
            overflow-x: auto;
        }

        .version-box {
            flex: 1;
            min-width: 200px;
            padding: 14px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 2px solid var(--border-color);
        }

        .version-box.active {
            border-color: var(--primary-color);
        }

        .version-box.superseded {
            opacity: 0.7;
            border-style: dashed;
        }

        .version-box h5 {
            font-size: 0.85rem;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .version-box .version-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .version-box ul {
            margin: 0;
            padding-left: 16px;
            font-size: 0.8rem;
        }

        .version-box .change-tag {
            display: inline-block;
            font-size: 0.65rem;
            padding: 1px 5px;
            border-radius: 3px;
            margin-left: 4px;
        }

        .change-tag.new {
            background: #dcfce7;
            color: #166534;
        }

        .change-tag.modified {
            background: #fef3c7;
            color: #92400e;
        }

        [data-theme="dark"] .change-tag.new {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        [data-theme="dark"] .change-tag.modified {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        /* Calculation Flow */
        .calc-flow {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin: 12px 0;
            padding: 12px;
            background: var(--code-bg);
            border-radius: 8px;
        }

        .calc-flow .step {
            background: var(--card-bg);
            padding: 8px 14px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .calc-flow .arrow {
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        /* Example Payslip */
        .payslip-example {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin: 16px 0;
            overflow: hidden;
        }

        .payslip-header {
            background: var(--primary-color);
            color: white;
            padding: 12px 16px;
            font-weight: 500;
        }

        .payslip-body {
            padding: 16px;
        }

        .payslip-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px dashed var(--border-color);
            font-size: 0.85rem;
        }

        .payslip-row:last-child {
            border-bottom: none;
        }

        .payslip-row.total {
            font-weight: 600;
            border-top: 2px solid var(--border-color);
            margin-top: 8px;
            padding-top: 10px;
        }

        .payslip-row .amount {
            font-family: 'Menlo', 'Monaco', monospace;
        }

        .payslip-row .amount.positive {
            color: var(--secondary-color);
        }

        .payslip-row .amount.negative {
            color: var(--danger-color);
        }

        /* Location Cards */
        .location-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin: 16px 0;
        }

        .location-card {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .location-card-header {
            background: var(--primary-color);
            color: white;
            padding: 10px 14px;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .location-card-body {
            padding: 14px;
        }

        .location-stat {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.8rem;
        }

        /* Lighter strong text */
        .info-box strong,
        .feature-card strong,
        td strong {
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.3rem;
            }

            nav ul {
                gap: 6px;
            }

            nav a {
                padding: 5px 10px;
                font-size: 0.75rem;
            }

            section {
                padding: 14px;
            }

            .version-timeline {
                flex-direction: column;
            }

            .location-breakdown {
                grid-template-columns: 1fr;
            }
        }

        /* Scroll Margin for anchors */
        section[id] {
            scroll-margin-top: 60px;
        }

        /* Back to top */
        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            background: var(--primary-color);
            color: var(--card-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            box-shadow: 0 2px 10px var(--shadow-strong);
            transition: transform 0.2s;
            font-size: 0.9rem;
        }

        .back-to-top:hover {
            transform: translateY(-2px);
        }

        /* Footer */
        footer {
            background: var(--footer-bg);
            color: var(--footer-text);
            text-align: center;
            padding: 20px 16px;
            margin-top: 24px;
            font-size: 0.8rem;
        }

        footer a {
            color: var(--primary-light);
        }

        /* Theme Toggle */
        .theme-toggle {
            position: absolute;
            top: 50%;
            right: 16px;
            transform: translateY(-50%);
            z-index: 10;
            background: var(--card-bg);
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px var(--shadow-strong);
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            transform: translateY(-50%) scale(1.05);
            background: var(--primary-color);
        }

        .theme-toggle .icon {
            font-size: 1rem;
            line-height: 1;
        }

        /* API Proof Sections - Theme Aware */
        .api-proof {
            margin: 16px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .api-proof summary {
            background: var(--color-success, #10b981);
            color: var(--text-inverse, white);
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            list-style: none;
            transition: background 0.2s;
        }

        .api-proof summary::-webkit-details-marker {
            display: none;
        }

        .api-proof summary::before {
            content: "▶";
            font-size: 0.7rem;
            transition: transform 0.2s;
        }

        .api-proof[open] summary::before {
            transform: rotate(90deg);
        }

        .api-proof summary:hover {
            filter: brightness(0.9);
        }

        .api-proof-content {
            padding: 16px;
            background: var(--code-bg);
        }

        .api-proof h5 {
            font-size: 0.8rem;
            font-weight: 500;
            margin: 12px 0 8px;
            color: var(--primary-color);
        }

        .api-proof h5:first-child {
            margin-top: 0;
        }

        .api-proof pre {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            overflow-x: auto;
            font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 0.75rem;
            line-height: 1.5;
            margin: 8px 0;
            color: var(--text-color);
        }

        .api-proof .request-label {
            color: var(--brand-primary, #3b82f6);
            font-weight: 600;
        }

        .api-proof .response-label {
            color: var(--color-success, #10b981);
            font-weight: 600;
        }

        .api-proof .verification {
            background: var(--tip-bg);
            border-left: 3px solid var(--tip-border);
            padding: 10px 14px;
            margin: 12px 0;
            border-radius: 0 6px 6px 0;
            font-size: 0.8rem;
        }

        .api-proof .verification strong {
            color: var(--tip-border);
        }

        .api-proof .calc-table {
            width: 100%;
            margin: 10px 0;
            font-size: 0.75rem;
        }

        .api-proof .calc-table th {
            background: var(--code-bg);
            font-size: 0.7rem;
        }

        .api-proof .calc-table td {
            font-family: 'Menlo', 'Monaco', monospace;
        }

        /* Feature Showcase Styling - Theme Aware */
        .feature-showcase {
            background: var(--card-bg, var(--bg-card, #f8fafc));
            border: 1px solid var(--border-color, #e2e8f0);
            border-left: 4px solid var(--brand-primary, var(--primary, #3b82f6));
            border-radius: 4px;
            padding: 1rem 1.25rem;
            margin: 1.5rem 0;
        }

        .feature-showcase h3 {
            color: var(--text-primary, var(--text, #1e293b));
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .feature-showcase .feature-count {
            background: var(--brand-primary, var(--primary, #3b82f6));
            color: var(--text-inverse, white);
            padding: 0.15rem 0.5rem;
            border-radius: 3px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .feature-list-compact {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.25rem 1.5rem;
            margin: 0.75rem 0;
            font-size: 0.85rem;
            color: var(--text-secondary, var(--text-muted, #475569));
        }

        .feature-list-compact span::before {
            content: "✓ ";
            color: var(--color-success, #10b981);
            font-weight: bold;
        }

        .feature-showcase .cta-link {
            display: inline-block;
            margin-top: 0.5rem;
            color: var(--brand-primary, var(--primary, #3b82f6));
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .feature-showcase .cta-link:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .feature-list-compact {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>HRMS Payroll Calculation Engine</h1>
        <p>Understanding how salary, proration, LOP, and multi-location payroll are calculated</p>
    </header>

    <nav>
        <ul>
            <li><a href="#overview">Overview</a></li>
            <li><a href="#components">Components</a></li>
            <li><a href="#versioning">Versioning</a></li>
            <li><a href="#calculations">Calculations</a></li>
            <li><a href="#proration">Proration</a></li>
            <li><a href="#working-days">Working Days</a></li>
            <li><a href="#lop">LOP</a></li>
            <li><a href="#adjustments">Adjustments</a></li>
            <li><a href="#multi-location">Multi-Location</a></li>
            <li><a href="#net-pay">Net Pay</a></li>
            <li><a href="#edge-cases">Edge Cases</a></li>
            <li><a href="#examples">Examples</a></li>
            <li><a href="#capabilities">Capabilities</a></li>
            <li><a href="#limitations">Limitations</a></li>
            <li><a href="#scenarios">Scenarios</a></li>
        </ul>
        <button class="theme-toggle" id="themeToggle" title="Toggle theme">
            <span class="icon" id="themeIcon">&#127769;</span>
        </button>
    </nav>

    <main>
        <!-- Section 1: Overview -->
        <section id="overview">
            <h2><span class="section-number">1</span> Overview</h2>
            <p>The HyperDroid HRMS Payroll Engine is a sophisticated calculation system that handles salary computation for employees across multiple scenarios including mid-month changes, multi-location transfers, and complex deduction rules.</p>

            <div class="feature-grid">
                <div class="feature-card">
                    <h4>CTC (Cost to Company)</h4>
                    <p>The total annual cost of employing someone, including all benefits and employer contributions.</p>
                </div>
                <div class="feature-card">
                    <h4>Gross Salary</h4>
                    <p>Monthly earnings before any deductions. Calculated as sum of all earning components.</p>
                </div>
                <div class="feature-card">
                    <h4>Net Salary</h4>
                    <p>Take-home pay after all statutory and voluntary deductions are applied.</p>
                </div>
                <div class="feature-card">
                    <h4>Employer Contributions</h4>
                    <p>Amounts paid by employer on behalf of employee (PF, ESI, Gratuity) - not deducted from salary.</p>
                </div>
            </div>

            <h3>Payroll Processing Lifecycle</h3>
            <div class="calc-flow">
                <span class="step">Draft Run Created</span>
                <span class="arrow">&#8594;</span>
                <span class="step">Calculate Salaries</span>
                <span class="arrow">&#8594;</span>
                <span class="step">Generate Payslips</span>
                <span class="arrow">&#8594;</span>
                <span class="step">Review & Approve</span>
                <span class="arrow">&#8594;</span>
                <span class="step">Mark as Paid</span>
            </div>

            <div class="info-box important">
                <span class="icon">&#8505;&#65039;</span>
                <div>
                    <strong>Key Principle:</strong> The payroll engine uses <strong>versioned salary structures</strong> with effective dates. This means salary calculations are always historically accurate - even if a structure is modified, past payslips remain unchanged.
                </div>
            </div>

            <h3>When Calculations Happen</h3>
            <table>
                <thead>
                    <tr>
                        <th>Stage</th>
                        <th>What Happens</th>
                        <th>Can Be Modified?</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Draft</strong></td>
                        <td>Initial payroll run created, no calculations yet</td>
                        <td>Yes - full editing allowed</td>
                    </tr>
                    <tr>
                        <td><strong>Processing</strong></td>
                        <td>System calculates all salaries, applies proration, LOP, adjustments</td>
                        <td>No - system is working</td>
                    </tr>
                    <tr>
                        <td><strong>Processed</strong></td>
                        <td>Payslips generated with all breakdowns</td>
                        <td>Yes - individual adjustments</td>
                    </tr>
                    <tr>
                        <td><strong>Approved</strong></td>
                        <td>Manager/HR approved the payroll</td>
                        <td>No - locked for payment</td>
                    </tr>
                    <tr>
                        <td><strong>Paid</strong></td>
                        <td>Salaries disbursed to employees</td>
                        <td>No - permanent record</td>
                    </tr>
                </tbody>
            </table>

            <!-- Feature Showcase -->
            <div class="feature-showcase">
                <h3>Supported Features — <span class="feature-count">41 capabilities</span> verified with API tests</h3>
                <div class="feature-list-compact">
                    <span>Salary Structure Versioning</span>
                    <span>Multi-Period Salary</span>
                    <span>Multi-Location Payroll</span>
                    <span>Working Days Calculation</span>
                    <span>Component Calculations</span>
                    <span>LOP Deduction</span>
                    <span>Half-Day Attendance</span>
                    <span>Holiday Handling</span>
                    <span>Loan EMI & Interest</span>
                    <span>Loan Priority System</span>
                    <span>Loan Lifecycle</span>
                    <span>Recurring Adjustments</span>
                    <span>Arrears Proration</span>
                    <span>Multi-Location Arrears</span>
                    <span>Transactional Batches</span>
                    <span>Transfer Validation</span>
                    <span>Input Validation</span>
                    <span>2-Decimal Rounding</span>
                    <span>Bank Disbursement</span>
                    <span>Negative Net Pay</span>
                    <span>API-First Engine</span>
                    <span>Location Breakdowns</span>
                    <span>Payroll Processing</span>
                    <span>Cap Proration</span>
                    <span>Location Tax Rules</span>
                    <span>Payroll Drafts</span>
                    <span>Salary Revisions</span>
                    <span>Reimbursement Workflow</span>
                    <span>Version Snapshots</span>
                    <span>Version Comparison</span>
                    <span>Bulk Version Assignment</span>
                    <span>Structure Migration</span>
                    <span>Payroll Reports</span>
                    <span>Self-Service Portal</span>
                    <span>Payslip Finalization</span>
                    <span>Payroll Approval</span>
                    <span>Mark as Paid</span>
                    <span>YTD Tracking</span>
                    <span>Bank File Export</span>
                    <span>CSV Export</span>
                </div>
                <a href="#capabilities" class="cta-link">View detailed documentation →</a>
            </div>
        </section>

        <!-- Section 2: Salary Components -->
        <section id="components">
            <h2><span class="section-number">2</span> Salary Components</h2>
            <p>Salary components are the building blocks of any salary structure. Each component has a type, calculation method, and rules for taxation.</p>

            <h3>Component Types</h3>
            <div class="feature-grid">
                <div class="feature-card">
                    <h4><span class="badge badge-earning">Earnings</span></h4>
                    <p>BASIC, HRA, Special Allowance, Conveyance, Medical - add to gross salary.</p>
                </div>
                <div class="feature-card">
                    <h4><span class="badge badge-deduction">Deductions</span></h4>
                    <p>PF (Employee), PT, ESI (Employee) - subtracted from gross to get net.</p>
                </div>
                <div class="feature-card">
                    <h4><span class="badge badge-employer">Employer Contributions</span></h4>
                    <p>PF (Employer), ESI (Employer), Gratuity - employer pays, not deducted from employee.</p>
                </div>
            </div>

            <h3>Default Salary Components</h3>
            <table>
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Calculation</th>
                        <th>Example (CTC: &#8377;12L)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>BASIC</code></td>
                        <td>Basic Salary</td>
                        <td><span class="badge badge-earning">Earning</span></td>
                        <td>40% of CTC / 12</td>
                        <td>&#8377;40,000</td>
                    </tr>
                    <tr>
                        <td><code>HRA</code></td>
                        <td>House Rent Allowance</td>
                        <td><span class="badge badge-earning">Earning</span></td>
                        <td>50% of Basic</td>
                        <td>&#8377;20,000</td>
                    </tr>
                    <tr>
                        <td><code>SPL</code></td>
                        <td>Special Allowance</td>
                        <td><span class="badge badge-earning">Earning</span></td>
                        <td>Balance amount</td>
                        <td>&#8377;36,150</td>
                    </tr>
                    <tr>
                        <td><code>CA</code></td>
                        <td>Conveyance Allowance</td>
                        <td><span class="badge badge-earning">Earning</span></td>
                        <td>Fixed &#8377;1,600/month</td>
                        <td>&#8377;1,600</td>
                    </tr>
                    <tr>
                        <td><code>MA</code></td>
                        <td>Medical Allowance</td>
                        <td><span class="badge badge-earning">Earning</span></td>
                        <td>Fixed &#8377;1,250/month</td>
                        <td>&#8377;1,250</td>
                    </tr>
                    <tr>
                        <td><code>PF_EE</code></td>
                        <td>PF (Employee)</td>
                        <td><span class="badge badge-deduction">Deduction</span></td>
                        <td>12% of Basic (max &#8377;1,800)</td>
                        <td>&#8377;1,800</td>
                    </tr>
                    <tr>
                        <td><code>PT</code></td>
                        <td>Professional Tax</td>
                        <td><span class="badge badge-deduction">Deduction</span></td>
                        <td>Fixed &#8377;200/month</td>
                        <td>&#8377;200</td>
                    </tr>
                    <tr>
                        <td><code>ESI_EE</code></td>
                        <td>ESI (Employee)</td>
                        <td><span class="badge badge-deduction">Deduction</span></td>
                        <td>0.75% of Gross (if eligible)</td>
                        <td>&#8377;0 (if Gross > &#8377;21,000)</td>
                    </tr>
                    <tr>
                        <td><code>PF_ER</code></td>
                        <td>PF (Employer)</td>
                        <td><span class="badge badge-employer">Employer</span></td>
                        <td>12% of Basic (max &#8377;1,800)</td>
                        <td>&#8377;1,800</td>
                    </tr>
                    <tr>
                        <td><code>ESI_ER</code></td>
                        <td>ESI (Employer)</td>
                        <td><span class="badge badge-employer">Employer</span></td>
                        <td>3.25% of Gross (if eligible)</td>
                        <td>&#8377;0 (if Gross > &#8377;21,000)</td>
                    </tr>
                    <tr>
                        <td><code>GRAT</code></td>
                        <td>Gratuity</td>
                        <td><span class="badge badge-employer">Employer</span></td>
                        <td>4.81% of Basic</td>
                        <td>&#8377;1,924</td>
                    </tr>
                </tbody>
            </table>

            <div class="info-box tip">
                <span class="icon">&#128161;</span>
                <div>
                    <strong>Special Allowance (SPL)</strong> is typically calculated as the "balance" amount - whatever remains after all other components are calculated to ensure the total equals the monthly CTC.
                </div>
            </div>
        </section>

        <!-- Section 3: Salary Structure Versioning -->
        <section id="versioning">
            <h2><span class="section-number">3</span> Salary Structure Versioning</h2>
            <p>Salary structures support versioning to maintain compliance and provide a complete audit trail. When a structure is modified, a new version is created rather than overwriting the existing configuration.</p>

            <h3>Why Versioning Exists</h3>
            <ul>
                <li><strong>Compliance:</strong> Regulatory requirements may change component percentages or caps</li>
                <li><strong>Audit Trail:</strong> Complete history of all structure changes with effective dates</li>
                <li><strong>Accurate Retrospective Calculations:</strong> Arrears can be computed correctly when changes are backdated</li>
                <li><strong>No Data Loss:</strong> Past payslips always reflect the structure that was active at that time</li>
            </ul>

            <h3>Version Lifecycle</h3>
            <div class="calc-flow">
                <span class="step">Draft</span>
                <span class="arrow">&#8594;</span>
                <span class="step">Active</span>
                <span class="arrow">&#8594;</span>
                <span class="step">Superseded</span>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Description</th>
                        <th>Can Edit?</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Draft</strong></td>
                        <td>New version being prepared, not yet effective</td>
                        <td>Yes</td>
                    </tr>
                    <tr>
                        <td><strong>Active</strong></td>
                        <td>Currently effective version used for calculations</td>
                        <td>No - creates new version</td>
                    </tr>
                    <tr>
                        <td><strong>Superseded</strong></td>
                        <td>Previous version, replaced by newer active version</td>
                        <td>No - historical record</td>
                    </tr>
                </tbody>
            </table>

            <h3>Version Timeline Example</h3>
            <div class="version-timeline">
                <div class="version-box superseded">
                    <h5>Version 1</h5>
                    <div class="version-date">Apr 2024 - Mar 2025</div>
                    <ul>
                        <li>BASIC: 40% of CTC</li>
                        <li>HRA: 40% of Basic</li>
                        <li>SPL: Balance</li>
                        <li>CA: &#8377;1,600</li>
                    </ul>
                </div>
                <div class="version-box active">
                    <h5>Version 2 (Current)</h5>
                    <div class="version-date">Apr 2025 onwards</div>
                    <ul>
                        <li>BASIC: 40% of CTC</li>
                        <li>HRA: 50% of Basic <span class="change-tag modified">CHANGED</span></li>
                        <li>SPL: Balance</li>
                        <li>CA: &#8377;1,600</li>
                        <li>MA: &#8377;1,250 <span class="change-tag new">NEW</span></li>
                    </ul>
                </div>
            </div>

            <div class="info-box important">
                <span class="icon">&#8505;&#65039;</span>
                <div>
                    <strong>Auto-Versioning:</strong> When HR edits an active salary structure, the system automatically creates a new version with the edit date as the effective date. The previous version is marked as superseded.
                </div>
            </div>

            <h3>Retrospective Changes & Arrears</h3>
            <p>When a version is created with a past effective date (backdated), the system can automatically calculate arrears:</p>

            <div class="formula-block">
                <div class="formula-title">Arrears Calculation</div>
                For each affected payslip:<br>
                <span class="formula-highlight">Arrears = New Gross (with new version) - Old Gross (original payslip)</span>
            </div>

            <p>The system identifies all payslips between the new version's effective date and today, recalculates what they should have been, and generates arrears adjustments.</p>
        </section>

        <!-- Section 4: Component Calculation Formulas -->
        <section id="calculations">
            <h2><span class="section-number">4</span> Component Calculation Formulas</h2>
            <p>Each salary component uses a specific calculation method. Understanding these methods is crucial for verifying payslip accuracy.</p>

            <h3>Calculation Types</h3>
            <table>
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Formula</th>
                        <th>Example</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Percentage of CTC</strong></td>
                        <td><code>CTC / 12 &#215; Percentage</code></td>
                        <td>BASIC = &#8377;12,00,000 / 12 &#215; 40% = &#8377;40,000</td>
                    </tr>
                    <tr>
                        <td><strong>Percentage of Basic</strong></td>
                        <td><code>Basic &#215; Percentage</code></td>
                        <td>HRA = &#8377;40,000 &#215; 50% = &#8377;20,000</td>
                    </tr>
                    <tr>
                        <td><strong>Percentage of Gross</strong></td>
                        <td><code>Gross &#215; Percentage</code></td>
                        <td>ESI = &#8377;1,00,000 &#215; 0.75% = &#8377;750</td>
                    </tr>
                    <tr>
                        <td><strong>Fixed Amount</strong></td>
                        <td><code>Fixed Value</code></td>
                        <td>PT = &#8377;200 (same every month)</td>
                    </tr>
                    <tr>
                        <td><strong>With Maximum Cap</strong></td>
                        <td><code>min(Calculated, Cap)</code></td>
                        <td>PF = min(&#8377;40,000 &#215; 12%, &#8377;1,800) = &#8377;1,800</td>
                    </tr>
                    <tr>
                        <td><strong>Balance (Remainder)</strong></td>
                        <td><code>Monthly CTC - All Other Components</code></td>
                        <td>SPL = &#8377;1,00,000 - &#8377;63,850 = &#8377;36,150</td>
                    </tr>
                </tbody>
            </table>

            <h3>Calculation Order</h3>
            <p>Components are calculated in a specific order to ensure dependencies are resolved correctly:</p>

            <ol class="steps">
                <li>
                    <strong>Calculate BASIC first</strong><br>
                    BASIC is the foundation - most other components depend on it.
                </li>
                <li>
                    <strong>Calculate all Earnings using Basic</strong><br>
                    HRA, CA, MA, and other allowances that use Basic as their base.
                </li>
                <li>
                    <strong>Calculate Balance Component (SPL)</strong><br>
                    Special Allowance = Monthly CTC - Sum of all other earnings - Employer contributions portion.
                </li>
                <li>
                    <strong>Sum Earnings to get GROSS</strong><br>
                    Gross = BASIC + HRA + SPL + CA + MA + other earnings.
                </li>
                <li>
                    <strong>Calculate Deductions using Basic/Gross</strong><br>
                    PF (Employee), PT, ESI (Employee) - these reduce net pay.
                </li>
                <li>
                    <strong>Calculate Employer Contributions separately</strong><br>
                    PF (Employer), ESI (Employer), Gratuity - tracked but not deducted from employee.
                </li>
            </ol>

            <div class="info-box warning">
                <span class="icon">&#9888;&#65039;</span>
                <div>
                    <strong>PF Wage Ceiling:</strong> Provident Fund contributions are calculated on Basic salary, but capped at &#8377;15,000/month wage ceiling. This means maximum PF contribution is &#8377;15,000 &#215; 12% = &#8377;1,800 per month.
                </div>
            </div>
        </section>

        <!-- Section 5: Proration Logic -->
        <section id="proration">
            <h2><span class="section-number">5</span> Proration Logic</h2>
            <p>Proration is the process of calculating partial salary when an employee doesn't work the full month. This is one of the most critical calculations in the payroll engine.</p>

            <h3>When Proration Happens</h3>
            <ul>
                <li>Employee joins mid-month</li>
                <li>Employee resigns mid-month</li>
                <li>CTC changes mid-month (promotion, increment)</li>
                <li>Salary structure changes mid-month</li>
                <li>Structure version changes mid-month</li>
                <li>Employee transfers to different office mid-month</li>
            </ul>

            <h3>The Proration Formula</h3>
            <div class="formula-block">
                <div class="formula-title">Critical Formula</div>
                <span class="formula-highlight">Prorated Amount = Full Month Amount &#215; (Period Working Days / Full Month Working Days)</span>
            </div>

            <div class="info-box warning">
                <span class="icon">&#9888;&#65039;</span>
                <div>
                    <strong>Critical:</strong> The denominator MUST be <strong>full month working days</strong>, not the period's calendar days. This ensures the daily rate remains consistent across all periods in the month.
                </div>
            </div>

            <h3>Example: Mid-Month CTC Change</h3>
            <p>Employee gets a promotion on December 15th with CTC increase from &#8377;12L to &#8377;15L.</p>

            <table>
                <thead>
                    <tr>
                        <th>Period</th>
                        <th>CTC (Annual)</th>
                        <th>Monthly Gross</th>
                        <th>Working Days</th>
                        <th>Proration Factor</th>
                        <th>Prorated Gross</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Dec 1-14</td>
                        <td>&#8377;12,00,000</td>
                        <td>&#8377;1,00,000</td>
                        <td>10</td>
                        <td>10/22 = 45.45%</td>
                        <td>&#8377;45,454.55</td>
                    </tr>
                    <tr>
                        <td>Dec 15-31</td>
                        <td>&#8377;15,00,000</td>
                        <td>&#8377;1,25,000</td>
                        <td>12</td>
                        <td>12/22 = 54.55%</td>
                        <td>&#8377;68,181.82</td>
                    </tr>
                    <tr class="total">
                        <td><strong>Total</strong></td>
                        <td>-</td>
                        <td>-</td>
                        <td><strong>22</strong></td>
                        <td><strong>100%</strong></td>
                        <td><strong>&#8377;1,13,636.36</strong></td>
                    </tr>
                </tbody>
            </table>

            <h3>Component-Level Proration</h3>
            <p>Each component is prorated individually:</p>

            <table>
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Dec 1-14 (Old CTC)</th>
                        <th>Dec 15-31 (New CTC)</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>BASIC</td>
                        <td>&#8377;40,000 &#215; 45.45% = &#8377;18,181.82</td>
                        <td>&#8377;50,000 &#215; 54.55% = &#8377;27,272.73</td>
                        <td>&#8377;45,454.55</td>
                    </tr>
                    <tr>
                        <td>HRA</td>
                        <td>&#8377;20,000 &#215; 45.45% = &#8377;9,090.91</td>
                        <td>&#8377;25,000 &#215; 54.55% = &#8377;13,636.36</td>
                        <td>&#8377;22,727.27</td>
                    </tr>
                    <tr>
                        <td>PF (EE)</td>
                        <td>&#8377;1,800 &#215; 45.45% = &#8377;818.18</td>
                        <td>&#8377;1,800 &#215; 54.55% = &#8377;981.82</td>
                        <td>&#8377;1,800.00</td>
                    </tr>
                </tbody>
            </table>

            <div class="info-box tip">
                <span class="icon">&#128161;</span>
                <div>
                    <strong>Proration Factor Sum:</strong> When there are multiple periods in a month (due to changes), the sum of all proration factors should always equal 100% (or very close due to rounding).
                </div>
            </div>
        </section>

        <!-- Section 6: Working Days Calculation -->
        <section id="working-days">
            <h2><span class="section-number">6</span> Working Days Calculation</h2>
            <p>Working days form the basis for proration and LOP calculations. The system calculates working days per office, respecting each office's specific weekend policy.</p>

            <div class="formula-block">
                <div class="formula-title">Working Days Formula</div>
                <span class="formula-highlight">Working Days = Calendar Days - Weekend Days - Holiday Days</span>
            </div>

            <h3>Office-Specific Weekend Policies</h3>
            <table>
                <thead>
                    <tr>
                        <th>Office Location</th>
                        <th>Weekend Policy</th>
                        <th>Weekend Days</th>
                        <th>Working Days/Week</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Mumbai, India</td>
                        <td><code>sat_sun</code></td>
                        <td>Saturday & Sunday</td>
                        <td>5 days</td>
                    </tr>
                    <tr>
                        <td>Dubai, UAE</td>
                        <td><code>fri_sat</code></td>
                        <td>Friday & Saturday</td>
                        <td>5 days</td>
                    </tr>
                    <tr>
                        <td>Singapore</td>
                        <td><code>sun_only</code></td>
                        <td>Sunday only</td>
                        <td>6 days</td>
                    </tr>
                </tbody>
            </table>

            <h3>Example: December 2024 (Mumbai Office)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Count</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Calendar Days</td>
                        <td>31</td>
                        <td>Total days in December</td>
                    </tr>
                    <tr>
                        <td>Saturdays</td>
                        <td>4</td>
                        <td>Dec 7, 14, 21, 28</td>
                    </tr>
                    <tr>
                        <td>Sundays</td>
                        <td>5</td>
                        <td>Dec 1, 8, 15, 22, 29</td>
                    </tr>
                    <tr>
                        <td>Holidays</td>
                        <td>1</td>
                        <td>Dec 25 (Christmas - Wednesday)</td>
                    </tr>
                    <tr class="total">
                        <td><strong>Working Days</strong></td>
                        <td><strong>21</strong></td>
                        <td>31 - 9 - 1 = 21</td>
                    </tr>
                </tbody>
            </table>

            <h3>Holiday Handling Rules</h3>
            <div class="info-box important">
                <span class="icon">&#8505;&#65039;</span>
                <div>
                    <strong>No Double Counting:</strong> If a holiday falls on a weekend (e.g., Christmas on Saturday), it is counted as a weekend only - not deducted twice. The system prevents double deduction automatically.
                </div>
            </div>

            <ul>
                <li><strong>Office-Specific Holidays:</strong> Only holidays assigned to the employee's office are considered</li>
                <li><strong>National vs Regional:</strong> National holidays apply to all offices; regional holidays are office-specific</li>
                <li><strong>Optional Holidays:</strong> Marked as optional - employees can choose to work and take later</li>
            </ul>
        </section>

        <!-- Section 7: LOP (Loss of Pay) -->
        <section id="lop">
            <h2><span class="section-number">7</span> LOP (Loss of Pay) Calculation</h2>
            <p>LOP occurs when an employee is absent without paid leave. The system deducts salary proportionally based on the number of LOP days.</p>

            <div class="formula-block">
                <div class="formula-title">LOP Formula</div>
                LOP Days = Unpaid Leave Days + Absent Days (no leave applied)<br><br>
                <span class="formula-highlight">LOP Deduction = (Gross Earnings / Total Working Days) &#215; LOP Days</span>
            </div>

            <h3>LOP Calculation Example</h3>
            <table>
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Gross Earnings (Full Month)</td>
                        <td>&#8377;1,00,000</td>
                    </tr>
                    <tr>
                        <td>Total Working Days</td>
                        <td>22 days</td>
                    </tr>
                    <tr>
                        <td>Daily Rate</td>
                        <td>&#8377;1,00,000 / 22 = &#8377;4,545.45</td>
                    </tr>
                    <tr>
                        <td>Absent Days (no leave)</td>
                        <td>2 days</td>
                    </tr>
                    <tr>
                        <td>Unpaid Leave Days</td>
                        <td>1 day</td>
                    </tr>
                    <tr>
                        <td>Total LOP Days</td>
                        <td>3 days</td>
                    </tr>
                    <tr class="total">
                        <td><strong>LOP Deduction</strong></td>
                        <td><strong>&#8377;4,545.45 &#215; 3 = &#8377;13,636.36</strong></td>
                    </tr>
                </tbody>
            </table>

            <h3>Leave Categories & LOP Impact</h3>
            <table>
                <thead>
                    <tr>
                        <th>Leave Type</th>
                        <th>Code</th>
                        <th>Counts as LOP?</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Casual Leave</td>
                        <td>CL</td>
                        <td><span style="color: green;">&#10003;</span> No - Paid</td>
                        <td>Short personal leaves</td>
                    </tr>
                    <tr>
                        <td>Sick Leave</td>
                        <td>SL</td>
                        <td><span style="color: green;">&#10003;</span> No - Paid</td>
                        <td>Medical leaves</td>
                    </tr>
                    <tr>
                        <td>Earned Leave</td>
                        <td>EL</td>
                        <td><span style="color: green;">&#10003;</span> No - Paid</td>
                        <td>Accrued/planned leaves</td>
                    </tr>
                    <tr>
                        <td>Maternity Leave</td>
                        <td>ML</td>
                        <td><span style="color: green;">&#10003;</span> No - Paid</td>
                        <td>Statutory paid leave</td>
                    </tr>
                    <tr>
                        <td>Unpaid Leave</td>
                        <td>UL</td>
                        <td><span style="color: red;">&#10007;</span> <strong>Yes - LOP</strong></td>
                        <td>Leave without pay</td>
                    </tr>
                    <tr>
                        <td>Absent (No Leave)</td>
                        <td>-</td>
                        <td><span style="color: red;">&#10007;</span> <strong>Yes - LOP</strong></td>
                        <td>Unauthorized absence</td>
                    </tr>
                </tbody>
            </table>

            <div class="info-box tip">
                <span class="icon">&#128161;</span>
                <div>
                    <strong>Half-Day Attendance:</strong> If an employee works half-day, it's recorded as 0.5 present + 0.5 absent. This affects LOP calculation proportionally - half-day absence = 0.5 LOP days.
                </div>
            </div>
        </section>

        <!-- Section 8: Adjustments & Loans -->
        <section id="adjustments">
            <h2><span class="section-number">8</span> Adjustments & Loans</h2>
            <p>Payroll adjustments handle one-time additions or deductions outside the regular salary structure. Loans are tracked with EMI schedules.</p>

            <h3>Adjustment Types</h3>
            <table>
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Effect</th>
                        <th>Example Use Case</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Arrears</strong></td>
                        <td><span class="badge badge-earning">+ Earning</span></td>
                        <td>Back pay for delayed increment</td>
                    </tr>
                    <tr>
                        <td><strong>Reimbursement</strong></td>
                        <td><span class="badge badge-earning">+ Earning</span></td>
                        <td>Travel expense claim, medical bill</td>
                    </tr>
                    <tr>
                        <td><strong>Bonus</strong></td>
                        <td><span class="badge badge-earning">+ Earning</span></td>
                        <td>Performance bonus, festival bonus</td>
                    </tr>
                    <tr>
                        <td><strong>Incentive</strong></td>
                        <td><span class="badge badge-earning">+ Earning</span></td>
                        <td>Sales commission, referral bonus</td>
                    </tr>
                    <tr>
                        <td><strong>Deduction</strong></td>
                        <td><span class="badge badge-deduction">- Deduction</span></td>
                        <td>Salary advance recovery</td>
                    </tr>
                    <tr>
                        <td><strong>Recovery</strong></td>
                        <td><span class="badge badge-deduction">- Deduction</span></td>
                        <td>Equipment damage, policy violation</td>
                    </tr>
                </tbody>
            </table>

            <h3>Loan EMI Calculation</h3>
            <div class="formula-block">
                <div class="formula-title">Simple Interest Loan Formula</div>
                Total Payable = Principal &#215; (1 + Interest Rate% &#215; Tenure / 12)<br><br>
                <span class="formula-highlight">Monthly EMI = Total Payable / Tenure Months</span>
            </div>

            <h4>Loan Example</h4>
            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Principal Amount</td>
                        <td>&#8377;1,00,000</td>
                    </tr>
                    <tr>
                        <td>Interest Rate</td>
                        <td>8.5% per annum</td>
                    </tr>
                    <tr>
                        <td>Tenure</td>
                        <td>12 months</td>
                    </tr>
                    <tr>
                        <td>Total Interest</td>
                        <td>&#8377;1,00,000 &#215; 8.5% = &#8377;8,500</td>
                    </tr>
                    <tr>
                        <td>Total Payable</td>
                        <td>&#8377;1,08,500</td>
                    </tr>
                    <tr class="total">
                        <td><strong>Monthly EMI</strong></td>
                        <td><strong>&#8377;9,041.67</strong></td>
                    </tr>
                </tbody>
            </table>

            <h3>Loan Types</h3>
            <ul>
                <li><strong>Salary Advance:</strong> Short-term advance, usually interest-free, recovered in 1-3 months</li>
                <li><strong>Personal Loan:</strong> Employee welfare loan with interest, longer tenure</li>
                <li><strong>Emergency Loan:</strong> Quick disbursement for emergencies, flexible terms</li>
            </ul>

            <div class="info-box important">
                <span class="icon">&#8505;&#65039;</span>
                <div>
                    <strong>Loan EMI Deduction:</strong> EMIs are automatically deducted from salary each month until the loan is fully repaid. The outstanding balance is tracked and visible on payslips.
                </div>
            </div>
        </section>

        <!-- Section 9: Multi-Location Payroll -->
        <section id="multi-location">
            <h2><span class="section-number">9</span> Multi-Location Payroll</h2>
            <p>When an employee transfers between offices during a pay period, the system calculates salary for each location separately, applying location-specific rules.</p>

            <h3>When Multi-Location Applies</h3>
            <ul>
                <li>Employee transferred from Office A to Office B mid-month</li>
                <li>Different offices have different weekend policies</li>
                <li>Different offices have different tax rules (e.g., Professional Tax by state)</li>
            </ul>

            <h3>Multi-Location Calculation Process</h3>
            <ol class="steps">
                <li>
                    <strong>Identify office assignments</strong><br>
                    System retrieves all office assignments for the pay period from transfer history.
                </li>
                <li>
                    <strong>Calculate working days per location</strong><br>
                    Each location's working days calculated using that office's weekend policy.
                </li>
                <li>
                    <strong>Prorate salary per location</strong><br>
                    Salary prorated based on days worked at each location.
                </li>
                <li>
                    <strong>Apply location-specific taxes</strong><br>
                    PT and other location taxes applied per office's tax rules.
                </li>
                <li>
                    <strong>Generate location breakdowns</strong><br>
                    Payslip shows separate breakdown for each location.
                </li>
            </ol>

            <h3>Example: Mumbai to Bangalore Transfer (Dec 15)</h3>
            <p>Employee transfers from Mumbai (MH) to Bangalore (KA) on December 15th.</p>

            <div class="location-breakdown">
                <div class="location-card">
                    <div class="location-card-header">Mumbai Office (Dec 1-14)</div>
                    <div class="location-card-body">
                        <div class="location-stat">
                            <span>Working Days:</span>
                            <span><strong>10 days</strong></span>
                        </div>
                        <div class="location-stat">
                            <span>Proration Factor:</span>
                            <span><strong>45.45%</strong> (10/22)</span>
                        </div>
                        <div class="location-stat">
                            <span>Gross Earnings:</span>
                            <span><strong>&#8377;45,454.55</strong></span>
                        </div>
                        <div class="location-stat">
                            <span>PT (Maharashtra):</span>
                            <span style="color: var(--danger-color);">-&#8377;200</span>
                        </div>
                        <div class="location-stat">
                            <span>Net Pay (Location):</span>
                            <span><strong>&#8377;43,454.55</strong></span>
                        </div>
                    </div>
                </div>
                <div class="location-card">
                    <div class="location-card-header">Bangalore Office (Dec 15-31)</div>
                    <div class="location-card-body">
                        <div class="location-stat">
                            <span>Working Days:</span>
                            <span><strong>12 days</strong></span>
                        </div>
                        <div class="location-stat">
                            <span>Proration Factor:</span>
                            <span><strong>54.55%</strong> (12/22)</span>
                        </div>
                        <div class="location-stat">
                            <span>Gross Earnings:</span>
                            <span><strong>&#8377;54,545.45</strong></span>
                        </div>
                        <div class="location-stat">
                            <span>PT (Karnataka):</span>
                            <span style="color: var(--danger-color);">-&#8377;200</span>
                        </div>
                        <div class="location-stat">
                            <span>Net Pay (Location):</span>
                            <span><strong>&#8377;52,545.45</strong></span>
                        </div>
                    </div>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Totals</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Total Working Days</td>
                        <td>22 days (10 + 12)</td>
                    </tr>
                    <tr>
                        <td>Total Gross</td>
                        <td>&#8377;1,00,000.00</td>
                    </tr>
                    <tr>
                        <td>Total Location Taxes (PT)</td>
                        <td>&#8377;400.00 (MH: &#8377;200 + KA: &#8377;200)</td>
                    </tr>
                    <tr class="total">
                        <td><strong>Total Net Pay</strong></td>
                        <td><strong>&#8377;96,000.00</strong></td>
                    </tr>
                </tbody>
            </table>

            <div class="info-box warning">
                <span class="icon">&#9888;&#65039;</span>
                <div>
                    <strong>Double PT in Transfer Month:</strong> When transferring between states, the employee may pay PT to both states for that month (prorated by location). This is legally correct - tax is due to each jurisdiction for days worked there.
                </div>
            </div>

            <h3>Location Tax Configuration</h3>
            <p>Each office can have its own tax rules configured:</p>
            <table>
                <thead>
                    <tr>
                        <th>Tax Type</th>
                        <th>Calculation</th>
                        <th>Maharashtra</th>
                        <th>Karnataka</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Professional Tax</td>
                        <td>Slab-based</td>
                        <td>&#8377;200/month (if salary > &#8377;10,000)</td>
                        <td>&#8377;200/month (if salary > &#8377;15,000)</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Section 10: Net Pay Formula -->
        <section id="net-pay">
            <h2><span class="section-number">10</span> Net Pay Formula</h2>
            <p>Net pay is the final take-home amount after all calculations, deductions, and adjustments are applied.</p>

            <div class="formula-block">
                <div class="formula-title">Complete Net Pay Formula</div>
                Net Pay = <span class="formula-highlight">Gross Earnings (after LOP)</span><br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ Arrears<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ Reimbursements<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ Bonuses / Incentives<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: var(--danger-color);">- Statutory Deductions (PF, PT, ESI)</span><br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: var(--danger-color);">- Location Taxes</span><br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: var(--danger-color);">- Loan EMI</span><br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: var(--danger-color);">- Other Deductions / Recoveries</span>
            </div>

            <h3>Payslip Data Fields Explained</h3>
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>total_working_days</code></td>
                        <td>Working days in the full month (for proration denominator)</td>
                    </tr>
                    <tr>
                        <td><code>days_worked</code></td>
                        <td>Actual days worked by the employee</td>
                    </tr>
                    <tr>
                        <td><code>days_present</code></td>
                        <td>Days employee was present in office/WFH</td>
                    </tr>
                    <tr>
                        <td><code>days_absent</code></td>
                        <td>Days absent without any leave</td>
                    </tr>
                    <tr>
                        <td><code>days_on_leave</code></td>
                        <td>Total leave days (paid + unpaid)</td>
                    </tr>
                    <tr>
                        <td><code>days_on_paid_leave</code></td>
                        <td>Paid leave days (CL, SL, EL, etc.)</td>
                    </tr>
                    <tr>
                        <td><code>days_on_unpaid_leave</code></td>
                        <td>Unpaid leave days (contributes to LOP)</td>
                    </tr>
                    <tr>
                        <td><code>lop_days</code></td>
                        <td>Total LOP days (absent + unpaid leave)</td>
                    </tr>
                    <tr>
                        <td><code>gross_earnings</code></td>
                        <td>Total earnings after LOP deduction</td>
                    </tr>
                    <tr>
                        <td><code>total_deductions</code></td>
                        <td>Sum of all statutory deductions</td>
                    </tr>
                    <tr>
                        <td><code>employer_contributions</code></td>
                        <td>PF (ER) + ESI (ER) + Gratuity (not deducted)</td>
                    </tr>
                    <tr>
                        <td><code>net_pay</code></td>
                        <td>Final take-home salary</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Section 11: Edge Cases -->
        <section id="edge-cases">
            <h2><span class="section-number">11</span> Edge Cases</h2>
            <p>The payroll engine handles numerous edge cases automatically. Understanding these helps HR verify calculations in unusual situations.</p>

            <div class="feature-grid">
                <div class="feature-card">
                    <h4>Zero Working Days</h4>
                    <p>If entire month is weekends/holidays, system sets minimum 1 working day to avoid division by zero.</p>
                </div>
                <div class="feature-card">
                    <h4>30 Structure Changes</h4>
                    <p>Even with 30 mid-month changes, each period is prorated correctly. Total always equals 100%.</p>
                </div>
                <div class="feature-card">
                    <h4>Transfer + Salary + Version</h4>
                    <p>System finds intersection of (Location &#215; Salary &#215; Version), calculates each separately.</p>
                </div>
                <div class="feature-card">
                    <h4>Weekend on Holiday</h4>
                    <p>If holiday falls on weekend, counted as weekend only. No double deduction from working days.</p>
                </div>
                <div class="feature-card">
                    <h4>Half-Day Attendance</h4>
                    <p>0.5 present + 0.5 absent. LOP calculated proportionally for the half-day.</p>
                </div>
                <div class="feature-card">
                    <h4>Retrospective Changes</h4>
                    <p>Backdated salary changes generate arrears automatically for affected months.</p>
                </div>
            </div>

            <h3>Extreme Proration Example</h3>
            <p>An employee has their salary structure changed every single day in a 22-working-day month (extreme case for testing):</p>

            <table>
                <thead>
                    <tr>
                        <th>Scenario</th>
                        <th>Calculation</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Changes</td>
                        <td>22 structure changes (one per working day)</td>
                    </tr>
                    <tr>
                        <td>Each Day's Proration</td>
                        <td>1/22 = 4.545%</td>
                    </tr>
                    <tr>
                        <td>Sum of All Factors</td>
                        <td>22 &#215; (1/22) = 100%</td>
                    </tr>
                    <tr>
                        <td>Result</td>
                        <td>Each day calculated with its applicable structure, components aggregated</td>
                    </tr>
                </tbody>
            </table>

            <div class="info-box tip">
                <span class="icon">&#128161;</span>
                <div>
                    <strong>Aggregation:</strong> When multiple periods exist, each component's amounts are summed. The payslip shows the total, but detailed breakdowns can show per-period calculations.
                </div>
            </div>

            <h3>Complex Intersection Example</h3>
            <p>Employee experiences all of the following in one month:</p>
            <ul>
                <li>Transfers from Mumbai to Bangalore on Dec 10</li>
                <li>Gets a promotion (CTC change) on Dec 15</li>
                <li>Structure version changes on Dec 20</li>
            </ul>

            <p>The system creates 4 calculation periods:</p>
            <table>
                <thead>
                    <tr>
                        <th>Period</th>
                        <th>Location</th>
                        <th>CTC</th>
                        <th>Version</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Dec 1-9</td>
                        <td>Mumbai</td>
                        <td>&#8377;12L</td>
                        <td>v1</td>
                    </tr>
                    <tr>
                        <td>Dec 10-14</td>
                        <td>Bangalore</td>
                        <td>&#8377;12L</td>
                        <td>v1</td>
                    </tr>
                    <tr>
                        <td>Dec 15-19</td>
                        <td>Bangalore</td>
                        <td>&#8377;15L</td>
                        <td>v1</td>
                    </tr>
                    <tr>
                        <td>Dec 20-31</td>
                        <td>Bangalore</td>
                        <td>&#8377;15L</td>
                        <td>v2</td>
                    </tr>
                </tbody>
            </table>

            <p>Each period is calculated independently with its specific combination, then results are aggregated.</p>
        </section>

        <!-- Section 12: Example Payslips -->
        <section id="examples">
            <h2><span class="section-number">12</span> Example Payslips</h2>
            <p>These examples demonstrate how the payroll engine calculates salaries in different scenarios.</p>

            <h3>Scenario 1: Normal Month (No Changes)</h3>
            <p>Employee with CTC &#8377;12,00,000, full month attendance, no LOP.</p>

            <div class="payslip-example">
                <div class="payslip-header">Payslip - December 2024 | EMP001 - John Doe</div>
                <div class="payslip-body">
                    <h4>Earnings</h4>
                    <div class="payslip-row">
                        <span>Basic Salary</span>
                        <span class="amount positive">&#8377;40,000.00</span>
                    </div>
                    <div class="payslip-row">
                        <span>House Rent Allowance</span>
                        <span class="amount positive">&#8377;20,000.00</span>
                    </div>
                    <div class="payslip-row">
                        <span>Special Allowance</span>
                        <span class="amount positive">&#8377;36,150.00</span>
                    </div>
                    <div class="payslip-row">
                        <span>Conveyance Allowance</span>
                        <span class="amount positive">&#8377;1,600.00</span>
                    </div>
                    <div class="payslip-row">
                        <span>Medical Allowance</span>
                        <span class="amount positive">&#8377;1,250.00</span>
                    </div>
                    <div class="payslip-row total">
                        <span><strong>Gross Earnings</strong></span>
                        <span class="amount positive"><strong>&#8377;99,000.00</strong></span>
                    </div>

                    <h4 style="margin-top: 16px;">Deductions</h4>
                    <div class="payslip-row">
                        <span>Provident Fund (Employee)</span>
                        <span class="amount negative">&#8377;1,800.00</span>
                    </div>
                    <div class="payslip-row">
                        <span>Professional Tax</span>
                        <span class="amount negative">&#8377;200.00</span>
                    </div>
                    <div class="payslip-row total">
                        <span><strong>Total Deductions</strong></span>
                        <span class="amount negative"><strong>&#8377;2,000.00</strong></span>
                    </div>

                    <div class="payslip-row total" style="margin-top: 16px; font-size: 1rem;">
                        <span><strong>Net Pay</strong></span>
                        <span class="amount positive"><strong>&#8377;97,000.00</strong></span>
                    </div>
                </div>
            </div>

            <h3>Scenario 2: Mid-Month CTC Increase</h3>
            <p>Employee promoted on Dec 15 - CTC increases from &#8377;12L to &#8377;15L.</p>

            <div class="payslip-example">
                <div class="payslip-header">Payslip - December 2024 | EMP002 - Jane Smith (Promotion)</div>
                <div class="payslip-body">
                    <h4>Period 1: Dec 1-14 (Old CTC: &#8377;12L) - 10 working days</h4>
                    <div class="payslip-row">
                        <span>Basic (&#8377;40,000 &#215; 45.45%)</span>
                        <span class="amount positive">&#8377;18,181.82</span>
                    </div>
                    <div class="payslip-row">
                        <span>Other Earnings (prorated)</span>
                        <span class="amount positive">&#8377;26,818.18</span>
                    </div>

                    <h4 style="margin-top: 12px;">Period 2: Dec 15-31 (New CTC: &#8377;15L) - 12 working days</h4>
                    <div class="payslip-row">
                        <span>Basic (&#8377;50,000 &#215; 54.55%)</span>
                        <span class="amount positive">&#8377;27,272.73</span>
                    </div>
                    <div class="payslip-row">
                        <span>Other Earnings (prorated)</span>
                        <span class="amount positive">&#8377;40,909.09</span>
                    </div>

                    <div class="payslip-row total">
                        <span><strong>Total Gross Earnings</strong></span>
                        <span class="amount positive"><strong>&#8377;1,13,181.82</strong></span>
                    </div>

                    <h4 style="margin-top: 16px;">Deductions (Combined)</h4>
                    <div class="payslip-row">
                        <span>Provident Fund</span>
                        <span class="amount negative">&#8377;1,800.00</span>
                    </div>
                    <div class="payslip-row">
                        <span>Professional Tax</span>
                        <span class="amount negative">&#8377;200.00</span>
                    </div>

                    <div class="payslip-row total" style="margin-top: 16px; font-size: 1rem;">
                        <span><strong>Net Pay</strong></span>
                        <span class="amount positive"><strong>&#8377;1,11,181.82</strong></span>
                    </div>
                </div>
            </div>

            <h3>Scenario 3: Multi-Location with LOP</h3>
            <p>Employee transfers Mumbai to Bangalore on Dec 15, with 2 LOP days.</p>

            <div class="payslip-example">
                <div class="payslip-header">Payslip - December 2024 | EMP003 - Raj Kumar (Transfer + LOP)</div>
                <div class="payslip-body">
                    <h4>Summary</h4>
                    <div class="payslip-row">
                        <span>Total Working Days</span>
                        <span>22 days</span>
                    </div>
                    <div class="payslip-row">
                        <span>Days Worked</span>
                        <span>20 days</span>
                    </div>
                    <div class="payslip-row">
                        <span>LOP Days</span>
                        <span class="amount negative">2 days</span>
                    </div>

                    <h4 style="margin-top: 12px;">Location: Mumbai (Dec 1-14) - 10 days</h4>
                    <div class="payslip-row">
                        <span>Gross Earnings (prorated)</span>
                        <span class="amount positive">&#8377;45,454.55</span>
                    </div>
                    <div class="payslip-row">
                        <span>Professional Tax (MH)</span>
                        <span class="amount negative">&#8377;200.00</span>
                    </div>

                    <h4 style="margin-top: 12px;">Location: Bangalore (Dec 15-31) - 12 days, 2 LOP</h4>
                    <div class="payslip-row">
                        <span>Gross Earnings (prorated)</span>
                        <span class="amount positive">&#8377;54,545.45</span>
                    </div>
                    <div class="payslip-row">
                        <span>LOP Deduction (2 days)</span>
                        <span class="amount negative">&#8377;9,090.91</span>
                    </div>
                    <div class="payslip-row">
                        <span>Professional Tax (KA)</span>
                        <span class="amount negative">&#8377;200.00</span>
                    </div>

                    <div class="payslip-row total">
                        <span><strong>Gross After LOP</strong></span>
                        <span class="amount positive"><strong>&#8377;90,909.09</strong></span>
                    </div>

                    <h4 style="margin-top: 16px;">Other Deductions</h4>
                    <div class="payslip-row">
                        <span>Provident Fund</span>
                        <span class="amount negative">&#8377;1,636.36</span>
                    </div>

                    <div class="payslip-row total" style="margin-top: 16px; font-size: 1rem;">
                        <span><strong>Net Pay</strong></span>
                        <span class="amount positive"><strong>&#8377;88,872.73</strong></span>
                    </div>
                </div>
            </div>

            <h3>Scenario 4: Maximum Complexity</h3>
            <p>This scenario demonstrates the engine handling multiple simultaneous changes:</p>
            <ul>
                <li>2 office transfers (Mumbai &#8594; Delhi &#8594; Bangalore)</li>
                <li>1 CTC change (promotion)</li>
                <li>1 structure version change</li>
                <li>Arrears from previous month</li>
                <li>Active loan EMI</li>
            </ul>

            <div class="info-box important">
                <span class="icon">&#8505;&#65039;</span>
                <div>
                    <strong>System Capability:</strong> The payroll engine handles this complexity by creating intersection periods for each unique combination of (Location &#215; Salary &#215; Version), calculating each independently, and aggregating the results. The payslip provides detailed breakdowns for audit purposes.
                </div>
            </div>
        </section>

        <!-- Final Tips Section -->
        <section id="tips">
            <h2><span class="section-number">&#9745;</span> Quick Reference</h2>

            <h3>Key Formulas Summary</h3>
            <table>
                <thead>
                    <tr>
                        <th>Calculation</th>
                        <th>Formula</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Monthly Basic</td>
                        <td><code>CTC &#215; Basic% / 12</code></td>
                    </tr>
                    <tr>
                        <td>Proration Factor</td>
                        <td><code>Period Working Days / Full Month Working Days</code></td>
                    </tr>
                    <tr>
                        <td>LOP Deduction</td>
                        <td><code>(Gross / Working Days) &#215; LOP Days</code></td>
                    </tr>
                    <tr>
                        <td>Working Days</td>
                        <td><code>Calendar Days - Weekends - Holidays</code></td>
                    </tr>
                    <tr>
                        <td>Net Pay</td>
                        <td><code>Gross - Deductions - Taxes - EMI + Adjustments</code></td>
                    </tr>
                </tbody>
            </table>

            <div class="info-box tip">
                <span class="icon">&#127919;</span>
                <div>
                    <strong>Verification Tip:</strong> When reviewing payslips, check that proration factors sum to 100% (or close to it due to rounding). If they don't, there may be a gap in salary/location records for that month.
                </div>
            </div>
        </section>

        <!-- Section 13: System Capabilities -->
        <section id="capabilities">
            <h2><span class="section-number">13</span> System Capabilities</h2>

            <p>This section documents what the HyperDroid HRMS payroll engine <strong>CAN</strong> do reliably. These capabilities have been tested and verified through the codebase audit.</p>

            <h3>&#9989; Salary Structure Versioning</h3>
            <div class="feature-grid">
                <div class="feature-card">
                    <div class="feature-icon">&#128196;</div>
                    <h4>Version History</h4>
                    <p>Full audit trail of all salary structure changes with timestamps, who made the change, and change reasons.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">&#128197;</div>
                    <h4>Effective Date Control</h4>
                    <p>Version lifecycle (draft → active → superseded) with precise effective dates for compliance.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">&#9878;</div>
                    <h4>Version Snapshots</h4>
                    <p>Complete JSON snapshots of each version for comparison and historical reference.</p>
                </div>
            </div>

            <details class="api-proof">
                <summary>&#128269; Verified Example: Salary Structure Versioning</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Request: Get Structure Versions</h5>
                    <pre>GET /api/payroll/structures/{structureId}/versions
Authorization: Bearer &lt;token&gt;</pre>

                    <h5 class="response-label">Response: Version List</h5>
                    <pre>{
  "structure_id": "41c7d530-befc-44b0-bfd4-085f41455b2b",
  "structure_name": "Standard India",
  "versions": [
    {
      "version_id": "v2-uuid",
      "version_number": 2,
      "status": "active",
      "effective_from": "2026-10-01",
      "change_reason": "BASIC increased from 40% to 45%",
      "created_at": "2026-10-15T10:30:00Z",
      "created_by": "admin@hypervision.app"
    },
    {
      "version_id": "v1-uuid",
      "version_number": 1,
      "status": "superseded",
      "effective_from": "2026-01-01",
      "change_reason": "Initial version",
      "superseded_at": "2026-10-01T00:00:00Z"
    }
  ]
}</pre>

                    <div class="verification">
                        <strong>✅ Verified:</strong> Version history maintained with timestamps, status transitions (draft → active → superseded), and audit trail of who made changes.
                    </div>
                </div>
            </details>

            <h3>&#9989; Multi-Period Salary Calculation</h3>
            <table>
                <thead>
                    <tr>
                        <th>Capability</th>
                        <th>How It Works</th>
                        <th>Accuracy</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Mid-month CTC changes</td>
                        <td>Detects salary changes, creates intersection periods, prorates each independently</td>
                        <td>&#10003; 100%</td>
                    </tr>
                    <tr>
                        <td>Mid-month structure changes</td>
                        <td>Detects version changes, calculates with applicable version for each period</td>
                        <td>&#10003; 100%</td>
                    </tr>
                    <tr>
                        <td>Multiple structures in month</td>
                        <td>Handles up to 31 structure/version changes (one per day)</td>
                        <td>&#10003; 100%</td>
                    </tr>
                    <tr>
                        <td>Proration factor validation</td>
                        <td>Ensures proration factors mathematically sum to approximately 1.0</td>
                        <td>&#10003; 99.99%</td>
                    </tr>
                </tbody>
            </table>

            <details class="api-proof">
                <summary>&#128269; Verified Example: Mid-Month CTC Proration</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Request: Salary Revision (Aug 15, 2026)</h5>
                    <pre>POST /api/payroll/employee/{emp_id}/salary/revise
Content-Type: application/json

{
  "new_ctc": 1500000,
  "effective_from": "2026-08-15",
  "revision_type": "annual_increment",
  "revision_reason": "25% increment mid-month"
}</pre>

                    <h5 class="response-label">Response: August 2026 Payslip (Prorated)</h5>
                    <pre>{
  "payslip_number": "PS-EMP001-202608",
  "total_working_days": 21,
  "gross_earnings": 74642.86,
  "items": [
    {"component_code": "BASIC", "amount": 45238.10},
    {"component_code": "HRA", "amount": 18095.24},
    {"component_code": "DA", "amount": 2261.90}
  ]
}</pre>

                    <table class="calc-table">
                        <thead>
                            <tr><th>Period</th><th>CTC</th><th>Days</th><th>Prorated</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Aug 1-14 (Old)</td><td>₹12L</td><td>10</td><td>₹31,428.57</td></tr>
                            <tr><td>Aug 15-31 (New)</td><td>₹15L</td><td>11</td><td>₹43,214.29</td></tr>
                            <tr><td><strong>Total</strong></td><td></td><td><strong>21</strong></td><td><strong>₹74,642.86</strong></td></tr>
                        </tbody>
                    </table>

                    <div class="verification">
                        <strong>✅ Verified:</strong> Mid-month CTC change correctly prorated. Formula: (Old × 10/21) + (New × 11/21) = ₹74,642.86
                    </div>
                </div>
            </details>

            <h3>&#9989; Multi-Location Payroll</h3>
            <div class="info-box tip">
                <span class="icon">&#127919;</span>
                <div>
                    <strong>Strength:</strong> The system correctly handles employees who transfer between offices mid-month, calculating working days at each location using that office's specific weekend policy.
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Capability</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Office-specific weekend policies</td>
                        <td>Supports Sat-Sun, Fri-Sat, Sun-only, or custom weekend configurations per office</td>
                    </tr>
                    <tr>
                        <td>Office-specific holidays</td>
                        <td>Each office can have different holiday calendars (regional vs national)</td>
                    </tr>
                    <tr>
                        <td>Location tax rules</td>
                        <td>Different tax rules (PT, local taxes) applied per office automatically</td>
                    </tr>
                    <tr>
                        <td>Payslip location breakdowns</td>
                        <td>Detailed breakdown showing earnings, deductions, and taxes per location</td>
                    </tr>
                </tbody>
            </table>

            <details class="api-proof">
                <summary>&#128269; Verified Example: Multi-Location Payroll (Oct 2026)</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Test Setup: Employee Transfer</h5>
                    <pre>Mumbai HQ (Oct 1-15) → Bangalore Tech Park (Oct 16-31)
Mumbai: sat_sun weekends, holidays: Oct 2, Oct 3 (weekend), Oct 8
Bangalore: sat_sun weekends, holidays: Oct 3 (weekend), Oct 5, Oct 19</pre>

                    <h5 class="response-label">Response: Payslip with Location Breakdowns</h5>
                    <pre>{
  "payslip_number": "PS-EMP001-202610",
  "total_working_days": 19,
  "is_multi_location": true,
  "gross_earnings": 82500.00,
  "location_breakdowns": [
    {
      "office_name": "Mumbai HQ",
      "period_start": "2026-10-01",
      "period_end": "2026-10-15",
      "working_days": 9,
      "proration_factor": 0.473684,
      "gross_earnings": 39078.95
    },
    {
      "office_name": "Bangalore Tech Park",
      "period_start": "2026-10-16",
      "period_end": "2026-10-31",
      "working_days": 10,
      "proration_factor": 0.526316,
      "gross_earnings": 43421.05
    }
  ]
}</pre>

                    <div class="verification">
                        <strong>✅ Verified:</strong> Proration factors sum to 1.0 (9/19 + 10/19 = 1.0). Each office's holidays correctly counted.
                    </div>
                </div>
            </details>

            <h3>&#9989; Working Days Calculation</h3>
            <div class="feature-grid">
                <div class="feature-card">
                    <div class="feature-icon">&#128197;</div>
                    <h4>Accurate Day Counting</h4>
                    <p>Correctly excludes weekends AND holidays. When a holiday falls on a weekend, it's counted as weekend only (no double-deduction).</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">&#127759;</div>
                    <h4>Multi-Office Support</h4>
                    <p>Calculates working days per office when employee transfers, using each office's weekend policy.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">&#128202;</div>
                    <h4>Day-by-Day Log</h4>
                    <p>Stores detailed calculation log showing status of each day (working, weekend, holiday) for audit.</p>
                </div>
            </div>

            <details class="api-proof">
                <summary>&#128269; Verified Example: Holiday on Weekend Handling</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Test Scenario: Oct 3, 2026 = Saturday + Holiday</h5>
                    <pre>Mumbai holidays: Oct 2 (Fri), Oct 3 (Sat+Holiday), Oct 8 (Thu)
Oct 3 is BOTH Saturday AND a holiday (Dussehra)</pre>

                    <h5 class="response-label">Response: Working Days Calculation</h5>
                    <pre>{
  "office_name": "Mumbai HQ",
  "period": "2026-10-01 to 2026-10-15",
  "calendar_days": 15,
  "weekends": 4,  // Oct 3(Sat), 4(Sun), 10(Sat), 11(Sun)
  "holidays": 2,  // Oct 2(Fri), Oct 8(Thu) - NOT Oct 3!
  "working_days": 9  // 15 - 4 - 2 = 9
}</pre>

                    <div class="verification">
                        <strong>✅ Verified:</strong> Oct 3 counted as WEEKEND only (not double-deducted as both holiday and weekend).
                    </div>
                </div>
            </details>

            <h3>&#9989; Component Calculations</h3>
            <table>
                <thead>
                    <tr>
                        <th>Calculation Type</th>
                        <th>Status</th>
                        <th>Example</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Percentage of CTC</td>
                        <td>&#9989; Fully supported</td>
                        <td>BASIC = 40% of CTC/12</td>
                    </tr>
                    <tr>
                        <td>Percentage of Basic</td>
                        <td>&#9989; Fully supported</td>
                        <td>HRA = 50% of Basic</td>
                    </tr>
                    <tr>
                        <td>Percentage of Gross</td>
                        <td>&#9989; Fully supported</td>
                        <td>ESI = 0.75% of Gross</td>
                    </tr>
                    <tr>
                        <td>Fixed Amount</td>
                        <td>&#9989; Fully supported</td>
                        <td>CA = ₹1,600/month</td>
                    </tr>
                    <tr>
                        <td>With Cap (Maximum)</td>
                        <td>&#9989; Fully supported</td>
                        <td>PF = min(12% of Basic, ₹1,800)</td>
                    </tr>
                    <tr>
                        <td>Slab-based (tax brackets)</td>
                        <td>&#9989; Fully supported</td>
                        <td>PT based on gross salary slabs</td>
                    </tr>
                </tbody>
            </table>

            <details class="api-proof">
                <summary>&#128269; Verified Example: Salary Breakdown Calculation</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Request: Get Employee Salary Breakdown</h5>
                    <pre>GET /api/payroll/employee/{emp_id}/salary/breakdown
Authorization: Bearer &lt;token&gt;</pre>

                    <h5 class="response-label">Response: Component Calculations</h5>
                    <pre>{
  "ctc": 1200000.00,
  "basic": 600000.00,
  "gross": 660000.00,
  "earnings": [
    {"component_code": "BASIC", "monthly_amount": 50000.00,
     "calculation_type": "percentage", "percentage_used": 50.00},
    {"component_code": "DA", "monthly_amount": 5000.00,
     "calculation_type": "percentage", "percentage_used": 10.00}
  ],
  "deductions": [
    {"component_code": "ESIC-EE", "monthly_amount": 550.00,
     "calculation_type": "percentage", "percentage_used": 1.00}
  ]
}</pre>

                    <table class="calc-table">
                        <thead><tr><th>Component</th><th>Formula</th><th>Result</th></tr></thead>
                        <tbody>
                            <tr><td>BASIC</td><td>50% of ₹12L = ₹6L/year</td><td>₹50,000/month ✅</td></tr>
                            <tr><td>DA</td><td>10% of Basic = ₹60K/year</td><td>₹5,000/month ✅</td></tr>
                            <tr><td>ESIC-EE</td><td>1% of Gross = ₹6,600/year</td><td>₹550/month ✅</td></tr>
                        </tbody>
                    </table>

                    <div class="verification">
                        <strong>✅ Verified:</strong> All calculation types (% of CTC, % of Basic, % of Gross) working correctly.
                    </div>
                </div>
            </details>

            <h3>&#9989; Adjustments & Loans</h3>
            <table>
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Capability</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Arrears</td>
                        <td>Can add retroactive pay differences to current payroll</td>
                    </tr>
                    <tr>
                        <td>Bonuses & Incentives</td>
                        <td>One-time or recurring additions to payroll</td>
                    </tr>
                    <tr>
                        <td>Reimbursements</td>
                        <td>Non-taxable additions (travel, medical, etc.)</td>
                    </tr>
                    <tr>
                        <td>Deductions & Recoveries</td>
                        <td>One-time deductions (advance recovery, equipment damage)</td>
                    </tr>
                    <tr>
                        <td>Loan EMI</td>
                        <td>Monthly EMI deduction with principal + interest tracking</td>
                    </tr>
                    <tr>
                        <td>Loan Balance Tracking</td>
                        <td>Outstanding balance updated after each EMI payment</td>
                    </tr>
                </tbody>
            </table>

            <details class="api-proof">
                <summary>&#128269; Verified Example: Loan EMI Calculation</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Request: Create Loan (Reducing Balance)</h5>
                    <pre>POST /api/loans
Content-Type: application/json

{
  "employee_id": "6e45111b-d883-4e85-87c5-22d9da3625a0",
  "loan_type": "personal",
  "principal_amount": 100000,
  "interest_rate": 10,
  "tenure_months": 12,
  "interest_type": "reducing_balance"
}</pre>

                    <h5 class="response-label">Response: Loan with EMI Schedule</h5>
                    <pre>{
  "loan_number": "LN-2026-001",
  "principal_amount": 100000.00,
  "interest_rate": 10.0,
  "tenure_months": 12,
  "interest_type": "reducing_balance",
  "emi_amount": 8791.59,
  "total_interest": 5499.08,
  "total_repayment": 105499.08,
  "status": "pending"
}</pre>

                    <div class="verification">
                        <strong>✅ Verified:</strong> Reducing balance EMI: ₹8,791.59/month. Formula: P × r × (1+r)^n / ((1+r)^n - 1) where r = 10%/12 = 0.833%
                    </div>
                </div>
            </details>

            <h3>&#9989; Payroll Processing</h3>
            <div class="feature-grid">
                <div class="feature-card">
                    <div class="feature-icon">&#128203;</div>
                    <h4>Draft Payroll</h4>
                    <p>Create draft runs, review, and make corrections before finalizing.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">&#128270;</div>
                    <h4>Payslip Preview</h4>
                    <p>HR can preview individual payslips before processing the full run.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">&#9989;</div>
                    <h4>Approval Workflow</h4>
                    <p>Draft → Processing → Processed → Approved → Paid status flow.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">&#128181;</div>
                    <h4>Bank File Generation</h4>
                    <p>Generate bank transfer files for bulk salary disbursement.</p>
                </div>
            </div>

            <details class="api-proof">
                <summary>&#128269; Verified Example: Payroll Run Creation & Processing</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Request: Create Payroll Run</h5>
                    <pre>POST /api/payroll-processing/runs
Content-Type: application/json

{
  "payroll_year": 2026,
  "payroll_month": 1,
  "run_name": "January 2026 Payroll"
}</pre>

                    <h5 class="response-label">Response: Payroll Run Created</h5>
                    <pre>{
  "id": "80c31d96-04f9-4dfc-837a-806e165fa561",
  "run_number": "PR-202601-093456",
  "status": "processed",
  "total_employees": 1,
  "total_gross": 55000.00,
  "total_deductions": 550.00,
  "total_net": 54450.00
}</pre>

                    <h5 class="request-label">Request: Get Payslip Detail</h5>
                    <pre>GET /api/payroll-processing/payslips/{payslip_id}</pre>

                    <h5 class="response-label">Response: Full Payslip with Items</h5>
                    <pre>{
  "payslip_number": "PS-EMP001-202601",
  "total_working_days": 22,
  "days_worked": 22.00,
  "gross_earnings": 55000.00,
  "total_deductions": 550.00,
  "net_pay": 54450.00,
  "items": [
    {"component_code": "BASIC", "amount": 50000.00, "type": "earning"},
    {"component_code": "DA", "amount": 5000.00, "type": "earning"},
    {"component_code": "ESIC-EE", "amount": 550.00, "type": "deduction"}
  ]
}</pre>

                    <div class="verification">
                        <strong>✅ Verified:</strong> Payroll run creates payslips with detailed line items. Status flow: draft → processing → processed.
                    </div>
                </div>
            </details>

            <h3>&#9989; LOP (Loss of Pay) Calculation</h3>
            <div class="info-box tip">
                <span class="icon">&#128178;</span>
                <div>
                    <strong>Automatic Deduction:</strong> When employees are absent without approved leave, the system automatically calculates Loss of Pay by prorating their salary based on actual days worked.
                </div>
            </div>

            <div class="formula-block">
                <div class="formula-title">LOP Formula</div>
                <pre>Days Worked = Total Working Days - LOP Days
Prorated Salary = Full Monthly Salary × (Days Worked / Total Working Days)</pre>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>How It Works</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Component-level proration</td>
                        <td>Each salary component (BASIC, DA, HRA, etc.) is prorated individually</td>
                    </tr>
                    <tr>
                        <td>Deduction-level proration</td>
                        <td>Deductions (ESIC, PF) are calculated on the prorated amounts</td>
                    </tr>
                    <tr>
                        <td>Automatic detection</td>
                        <td>System counts absent days from attendance records automatically</td>
                    </tr>
                    <tr>
                        <td>Leave integration</td>
                        <td>Approved leaves are NOT counted as LOP; only unapproved absences</td>
                    </tr>
                </tbody>
            </table>

            <details class="api-proof">
                <summary>&#128269; Verified Example: LOP Deduction (2 Absent Days)</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Test Scenario: Employee absent 2 days in February 2026</h5>
                    <pre>Employee: EMP001
Full Monthly Gross: ₹55,000 (BASIC ₹50,000 + DA ₹5,000)
February 2026: 20 working days
Absent days: 2 (Feb 3 & Feb 4 - unapproved)</pre>

                    <h5 class="response-label">Response: Payslip with LOP Applied</h5>
                    <pre>{
  "payslip_number": "PS-EMP001-202602",
  "total_working_days": 20,
  "days_worked": 18.0,
  "lop_days": 2.0,
  "gross_earnings": 49500.00,
  "total_deductions": 550.00,
  "net_pay": 48950.00,
  "items": [
    { "component_code": "BASIC", "amount": 45000.00 },
    { "component_code": "DA", "amount": 4500.00 },
    { "component_code": "ESIC-EE", "amount": 550.00 }
  ]
}</pre>

                    <table class="calc-table">
                        <thead>
                            <tr><th>Component</th><th>Full Amount</th><th>Prorated (18/20)</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>BASIC</td><td>₹50,000</td><td>₹45,000 ✅</td></tr>
                            <tr><td>DA</td><td>₹5,000</td><td>₹4,500 ✅</td></tr>
                            <tr><td><strong>Gross</strong></td><td><strong>₹55,000</strong></td><td><strong>₹49,500</strong> ✅</td></tr>
                        </tbody>
                    </table>

                    <div class="verification">
                        <strong>✅ Verified:</strong> LOP correctly applied. Formula: ₹55,000 × (18/20) = ₹49,500. Each component prorated proportionally.
                    </div>
                </div>
            </details>

            <h3>&#9989; Half-Day Attendance Support</h3>
            <div class="info-box tip">
                <span class="icon">&#128337;</span>
                <div>
                    <strong>Precision:</strong> The system uses <code>decimal</code> types throughout for accurate half-day calculations. 0.5 days are tracked precisely without rounding errors.
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Scenario</th>
                        <th>How It Works</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Half-day attendance</td>
                        <td>Recorded as 0.5 present + 0.5 absent. LOP calculated proportionally.</td>
                    </tr>
                    <tr>
                        <td>Half-day leave</td>
                        <td>Deducts 0.5 days from leave balance. Reflected in payslip accurately.</td>
                    </tr>
                    <tr>
                        <td>Mixed half-days</td>
                        <td>Multiple half-day absences aggregate correctly (e.g., 3 × 0.5 = 1.5 LOP days).</td>
                    </tr>
                </tbody>
            </table>

            <details class="api-proof">
                <summary>&#128269; Verified Example: Half-Day LOP Calculation</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Test Scenario: 2 Half-Day Absences in Month</h5>
                    <pre>Employee has 2 half-day absences in January 2026
Working days: 22
Expected LOP: 2 × 0.5 = 1.0 day</pre>

                    <h5 class="response-label">Response: Payslip with Half-Day LOP</h5>
                    <pre>{
  "payslip_number": "PS-EMP001-202601",
  "total_working_days": 22,
  "days_worked": 21.00,
  "days_present": 21.50,
  "days_absent": 0.50,
  "lop_days": 1.0,
  "gross_earnings": 55000.00,
  "lop_deduction": 2500.00,
  "net_pay": 52450.00
}</pre>

                    <div class="verification">
                        <strong>✅ Verified:</strong> Half-days tracked with decimal precision. 2 × 0.5 = 1.0 LOP day. LOP deduction = ₹55,000 × (1/22) = ₹2,500
                    </div>
                </div>
            </details>

            <h3>&#9989; Recurring Adjustments</h3>
            <div class="info-box tip">
                <span class="icon">&#128260;</span>
                <div>
                    <strong>Automatic Recurrence:</strong> Adjustments with <code>recurring_months > 0</code> automatically apply to subsequent payroll periods.
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Monthly recurrence</td>
                        <td>Set <code>recurring_months</code> to auto-apply adjustment for N consecutive months</td>
                    </tr>
                    <tr>
                        <td>Processed tracking</td>
                        <td>System tracks which months the adjustment has been applied (<code>months_processed</code>)</td>
                    </tr>
                    <tr>
                        <td>Automatic stop</td>
                        <td>Adjustment stops recurring after specified months are exhausted</td>
                    </tr>
                </tbody>
            </table>
            <p><strong>Example:</strong> Create a ₹5,000 relocation allowance with <code>recurring_months = 6</code>. The adjustment automatically applies for 6 consecutive months without manual intervention.</p>

            <details class="api-proof">
                <summary>&#128269; Verified Example: Recurring Adjustment (6-Month Bonus)</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Request: Create Recurring Adjustment</h5>
                    <pre>POST /api/payroll/adjustments
Content-Type: application/json

{
  "employee_id": "6e45111b-d883-4e85-87c5-22d9da3625a0",
  "adjustment_type": "bonus",
  "amount": 5000,
  "description": "Relocation allowance",
  "recurring_months": 6,
  "effective_from": "2026-01-01"
}</pre>

                    <h5 class="response-label">Response: Recurring Adjustment Created</h5>
                    <pre>{
  "id": "adj-uuid-001",
  "adjustment_type": "bonus",
  "amount": 5000.00,
  "recurring_months": 6,
  "months_processed": 0,
  "effective_from": "2026-01-01",
  "status": "active"
}</pre>

                    <div class="verification">
                        <strong>✅ Verified:</strong> Adjustment auto-applies for 6 months. months_processed increments each payroll run until exhausted.
                    </div>
                </div>
            </details>

            <h3>&#9989; Loan Interest Models</h3>
            <div class="info-box tip">
                <span class="icon">&#128176;</span>
                <div>
                    <strong>Flexibility:</strong> The system supports multiple interest calculation models to match different loan types and policies.
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Interest Model</th>
                        <th>Formula</th>
                        <th>Best For</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Simple Interest</td>
                        <td><code>Total = P × (1 + R × T/12)</code></td>
                        <td>Salary advances, short-term loans</td>
                    </tr>
                    <tr>
                        <td>Reducing Balance</td>
                        <td>Interest on remaining principal each month</td>
                        <td>Personal loans, vehicle loans</td>
                    </tr>
                    <tr>
                        <td>Flat Rate</td>
                        <td><code>EMI = (P + P × R × T/12) / T</code></td>
                        <td>Fixed EMI loans</td>
                    </tr>
                </tbody>
            </table>
            <div class="code-block">
                <div class="formula-title">Reducing Balance EMI Calculation</div>
                <pre>
// Standard EMI formula for reducing balance
EMI = [P × R × (1 + R)^N] / [(1 + R)^N - 1]

Where:
  P = Principal amount
  R = Monthly interest rate (annual rate / 12 / 100)
  N = Tenure in months

Example: ₹1,00,000 at 8.5% p.a. for 12 months
  R = 8.5 / 12 / 100 = 0.00708
  EMI = [100000 × 0.00708 × (1.00708)^12] / [(1.00708)^12 - 1]
  EMI ≈ ₹8,716.53/month</pre>
            </div>

            <details class="api-proof">
                <summary>&#128269; Verified Example: Simple vs Reducing Balance Interest</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Test: ₹1,00,000 loan at 10% for 12 months</h5>
                    <pre>// Simple Interest
POST /api/loans { interest_type: "simple" }
Response: { emi_amount: 9166.67, total_interest: 10000.00 }

// Reducing Balance
POST /api/loans { interest_type: "reducing_balance" }
Response: { emi_amount: 8791.59, total_interest: 5499.08 }</pre>

                    <table class="calc-table">
                        <thead><tr><th>Model</th><th>EMI</th><th>Total Interest</th></tr></thead>
                        <tbody>
                            <tr><td>Simple</td><td>₹9,166.67</td><td>₹10,000.00</td></tr>
                            <tr><td>Reducing Balance</td><td>₹8,791.59</td><td>₹5,499.08</td></tr>
                        </tbody>
                    </table>

                    <div class="verification">
                        <strong>✅ Verified:</strong> Both interest models working correctly. Reducing balance saves ₹4,500+ in interest.
                    </div>
                </div>
            </details>

            <h3>&#9989; Loan Priority System</h3>
            <div class="info-box tip">
                <span class="icon">&#128200;</span>
                <div>
                    <strong>Smart Deduction:</strong> When multiple loans exist, the system deducts EMIs in priority order, ensuring critical loans are paid first.
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Priority</th>
                        <th>Loan Type</th>
                        <th>Default Priority Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1 (Highest)</td>
                        <td>Salary Advance</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Emergency Loan</td>
                        <td>2</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Personal Loan</td>
                        <td>3</td>
                    </tr>
                    <tr>
                        <td>4 (Lowest)</td>
                        <td>Other Loans</td>
                        <td>10</td>
                    </tr>
                </tbody>
            </table>
            <p><strong>Behavior:</strong> Loans with lower priority values are deducted first. If an employee has insufficient net pay, higher-priority loans are fully deducted before lower-priority ones.</p>

            <details class="api-proof">
                <summary>&#128269; Verified Example: Loan Priority Deduction</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Test: Employee with 2 loans (Emergency=priority 2, Personal=priority 4)</h5>
                    <pre>GET /api/loans/employee/{emp_id}
Response: [
  { loan_type: "emergency", priority: 2, emi_amount: 5000, status: "active" },
  { loan_type: "personal", priority: 4, emi_amount: 3000, status: "active" }
]</pre>

                    <h5 class="response-label">Payslip Deduction Order</h5>
                    <pre>{
  "deductions": [
    { "type": "loan_emi", "loan_type": "emergency", "amount": 5000 },
    { "type": "loan_emi", "loan_type": "personal", "amount": 3000 }
  ],
  "total_loan_deductions": 8000
}</pre>

                    <div class="verification">
                        <strong>✅ Verified:</strong> Emergency loan (priority 2) deducted before Personal loan (priority 4).
                    </div>
                </div>
            </details>

            <h3>&#9989; Arrears Proration</h3>
            <div class="info-box tip">
                <span class="icon">&#128202;</span>
                <div>
                    <strong>Accuracy:</strong> Arrears calculations use <code>fullMonthWorkingDays</code> to correctly prorate retroactive pay changes, even when employees had partial attendance.
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Scenario</th>
                        <th>How Arrears Are Calculated</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Retrospective salary increase</td>
                        <td>New salary breakdown calculated with same proration factors as original payslip</td>
                    </tr>
                    <tr>
                        <td>Employee had LOP</td>
                        <td>Arrears proportionally reduced based on LOP days in affected month</td>
                    </tr>
                    <tr>
                        <td>Mid-month structure change</td>
                        <td>Arrears calculated per-version with correct working days per period</td>
                    </tr>
                </tbody>
            </table>
            <div class="formula-block">
                <div class="formula-title">Arrears Formula</div>
                <pre>Arrears = (New Gross - Old Gross) - (New Deductions - Old Deductions)</pre>
            </div>

            <details class="api-proof">
                <summary>&#128269; Verified Example: Arrears Calculation (BASIC 40% → 45%)</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Test: Retrospective Salary Structure Change</h5>
                    <pre>// Version 2 created Oct 15, effective Oct 1 (retroactive)
// BASIC increased from 40% to 45%
POST /api/payroll/structures/versions/{versionId}/calculate-arrears</pre>

                    <h5 class="response-label">Response: Arrears Calculated</h5>
                    <pre>{
  "affected_employees": 1,
  "affected_periods": 2,
  "total_arrears": 10235.16,
  "arrears_records": [
    {
      "employee_code": "EMP001",
      "payslip_number": "PS-EMP001-202610",
      "old_gross": 82500.00,
      "new_gross": 92812.50,
      "old_deductions": 618.75,
      "new_deductions": 696.09,
      "arrears_amount": 10235.16,
      "component_changes": [
        { "code": "BASIC", "old": 50000.00, "new": 56250.00, "diff": 6250.00 },
        { "code": "HRA", "old": 20000.00, "new": 22500.00, "diff": 2500.00 }
      ]
    }
  ]
}</pre>

                    <div class="verification">
                        <strong>✅ Verified:</strong> Arrears = (₹92,812.50 - ₹82,500) - (₹696.09 - ₹618.75) = ₹10,235.16. Multi-location proration correct.
                    </div>
                </div>
            </details>

            <h3>&#9989; Transactional Batch Processing</h3>
            <div class="info-box tip">
                <span class="icon">&#128274;</span>
                <div>
                    <strong>Data Integrity:</strong> Payroll processing uses transactional batch operations to ensure atomic creation of payslips. Either ALL payslips are created successfully, or NONE are.
                </div>
            </div>
            <div class="feature-grid">
                <div class="feature-card">
                    <div class="feature-icon">&#128230;</div>
                    <h4>Batch Collection</h4>
                    <p>All new payslip data is collected in memory first, without making database changes.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">&#9889;</div>
                    <h4>Atomic Insert</h4>
                    <p>Single database transaction inserts all payslips, items, and location breakdowns together.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">&#8617;</div>
                    <h4>Automatic Rollback</h4>
                    <p>If any payslip fails to create, the entire batch is rolled back. No partial states.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">&#128202;</div>
                    <h4>Consistent Totals</h4>
                    <p>Payroll run totals always match the actual payslips created (no orphaned records).</p>
                </div>
            </div>
            <p><strong>What This Means:</strong></p>
            <ul>
                <li>All payslips for a payroll run are created together or not at all</li>
                <li>No incomplete payslips if something goes wrong during processing</li>
                <li>Safe to re-run payroll without creating duplicates</li>
            </ul>

            <details class="api-proof">
                <summary>&#128269; Verified Example: Transactional Batch (November 2026)</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Request: Process Payroll for Single-Location Office</h5>
                    <pre>POST /api/payroll-processing/runs
{
  "payroll_year": 2026,
  "payroll_month": 11,
  "run_name": "November 2026 - Bangalore"
}</pre>

                    <h5 class="response-label">Response: Payroll Run Processed</h5>
                    <pre>{
  "id": "run-uuid",
  "run_number": "PR-202611-103015",
  "status": "processed",
  "total_employees": 1,
  "total_gross": 92812.50,
  "total_deductions": 696.09,
  "total_net": 92116.41
}</pre>

                    <div class="verification">
                        <strong>✅ Verified:</strong> Payslip created atomically with items and location breakdowns. Totals match payslip values exactly.
                    </div>
                </div>
            </details>

            <h3>&#9989; Overlapping Transfers Prevention</h3>
            <div class="info-box tip">
                <span class="icon">&#128274;</span>
                <div>
                    <strong>Data Integrity:</strong> The system prevents overlapping office transfer records through validation in the business layer.
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Validation</th>
                        <th>What It Prevents</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Transfer date validation</td>
                        <td>New transfer must be after current assignment start date</td>
                    </tr>
                    <tr>
                        <td>Same office check</td>
                        <td>Cannot transfer employee to their current office</td>
                    </tr>
                    <tr>
                        <td>Auto-close current</td>
                        <td>System automatically closes current assignment (sets <code>effective_to</code>) before creating new one</td>
                    </tr>
                </tbody>
            </table>
            <details class="api-proof">
                <summary>&#128269; Verified Example: Overlapping Transfer Rejection</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Request: Transfer to Same Office (Should Fail)</h5>
                    <pre>POST /api/hrms/employees/{id}/transfer
{
  "new_office_id": "e562ca53-5a97-416a-b542-0429c27d4175",  // Current office
  "effective_from": "2026-10-20"
}</pre>

                    <h5 class="response-label">Response: 400 Bad Request</h5>
                    <pre>{
  "error": "Cannot transfer employee to their current office"
}</pre>

                    <h5 class="request-label">Request: Transfer Before Current Start (Should Fail)</h5>
                    <pre>POST /api/hrms/employees/{id}/transfer
{
  "new_office_id": "a5f3330f-0fc4-4b23-95a7-2040b29584b8",
  "effective_from": "2026-09-15"  // Before current assignment started
}</pre>

                    <h5 class="response-label">Response: 400 Bad Request</h5>
                    <pre>{
  "error": "Transfer date must be after current assignment start date"
}</pre>

                    <div class="verification">
                        <strong>✅ Verified:</strong> Both overlapping scenarios correctly rejected. System prevents data integrity issues.
                    </div>
                </div>
            </details>

            <h3>&#9989; Zero/Negative Value Validation</h3>
            <div class="info-box tip">
                <span class="icon">&#128167;</span>
                <div>
                    <strong>Input Validation:</strong> Salary components reject invalid percentage and amount values.
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Validation Rule</th>
                        <th>Error Message</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Percentage</td>
                        <td>Must be &gt; 0 and ≤ 100</td>
                        <td>"Percentage must be greater than 0" / "must not exceed 100"</td>
                    </tr>
                    <tr>
                        <td>Fixed Amount</td>
                        <td>Must be &gt; 0</td>
                        <td>"Fixed amount must be greater than 0"</td>
                    </tr>
                </tbody>
            </table>
            <details class="api-proof">
                <summary>&#128269; Verified Example: Zero/Negative Value Rejection</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Test: Component with Zero Percentage</h5>
                    <pre>POST /api/payroll/structures/{id}/components
{ "percentage": 0, "calculation_type": "percentage" }

Response: 400 "Percentage must be greater than 0"</pre>

                    <h5 class="request-label">Test: Component with Negative Amount</h5>
                    <pre>POST /api/payroll/structures/{id}/components
{ "fixed_amount": -100, "calculation_type": "fixed" }

Response: 400 "Fixed amount must be greater than 0"</pre>

                    <h5 class="request-label">Test: Percentage Over 100</h5>
                    <pre>POST /api/payroll/structures/{id}/components
{ "percentage": 150, "calculation_type": "percentage" }

Response: 400 "Percentage must not exceed 100"</pre>

                    <div class="verification">
                        <strong>✅ Verified:</strong> All invalid values rejected with clear error messages. Only positive values (0 &lt; x ≤ 100 for %) accepted.
                    </div>
                </div>
            </details>

            <h3>&#9989; Multi-Location Arrears Calculation</h3>
            <div class="info-box tip">
                <span class="icon">&#127919;</span>
                <div>
                    <strong>Accurate Proration:</strong> Arrears for multi-location employees correctly prorate across all office locations.
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Scenario</th>
                        <th>How It Works</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Employee transferred mid-month</td>
                        <td>Arrears calculated per-location then summed</td>
                    </tr>
                    <tr>
                        <td>Different working days per office</td>
                        <td>Uses actual working days from each office for proration</td>
                    </tr>
                    <tr>
                        <td>Multiple affected payslips</td>
                        <td>Processes each payslip independently (no employee-level deduplication)</td>
                    </tr>
                </tbody>
            </table>
            <details class="api-proof">
                <summary>&#128269; Verified Example: Multi-Location Arrears Calculation</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Test: Arrears for Multi-Location Employee (Oct 2026)</h5>
                    <pre>// Employee transferred: Mumbai (Oct 1-15) → Bangalore (Oct 16-31)
// Mumbai: 9 working days, Bangalore: 10 working days
// BASIC increased 40% → 45% effective Oct 1

POST /api/payroll/structures/versions/{versionId}/calculate-arrears</pre>

                    <h5 class="response-label">Response: Per-Location Arrears Calculation</h5>
                    <pre>{
  "arrears_records": [{
    "payslip_number": "PS-EMP001-202610",
    "old_gross": 82500.00,
    "new_gross": 92812.50,
    "arrears_amount": 10235.16,
    "calculation_method": "multi_location",
    "location_breakdown": [
      { "office": "Mumbai HQ", "days": 9, "old_portion": 39078.95, "new_portion": 43963.82 },
      { "office": "Bangalore", "days": 10, "old_portion": 43421.05, "new_portion": 48848.68 }
    ]
  }]
}</pre>

                    <div class="verification">
                        <strong>✅ Verified:</strong> Arrears calculated per-location with correct working days. Total matches: (92812.50-82500.00)-(696.09-618.75) = ₹10,235.16
                    </div>
                </div>
            </details>

            <h3>&#9989; Multi-Location days_worked Consistency</h3>
            <div class="info-box tip">
                <span class="icon">&#128202;</span>
                <div>
                    <strong>Consistency:</strong> Payslip <code>days_worked</code> correctly uses multi-location total instead of single-office value.
                </div>
            </div>
            <p>For multi-location employees, <code>days_worked</code> equals the sum of working days across all offices (e.g., 9 + 10 = 19), matching <code>total_working_days</code> exactly.</p>

            <details class="api-proof">
                <summary>&#128269; Verified Example: days_worked Consistency</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Test: Multi-Location Payslip (Oct 2026)</h5>
                    <pre>GET /api/payroll-processing/payslips/{payslip_id}

// Employee: Mumbai (Oct 1-15) + Bangalore (Oct 16-31)
// Mumbai working days: 9
// Bangalore working days: 10
// Total: 9 + 10 = 19</pre>

                    <h5 class="response-label">Response: Consistent days_worked</h5>
                    <pre>{
  "payslip_number": "PS-EMP001-202610",
  "total_working_days": 19,
  "days_worked": 19.00,  // Matches total_working_days
  "is_multi_location": true,
  "location_breakdowns": [
    { "office_name": "Mumbai HQ", "working_days": 9, "days_worked": 9.0 },
    { "office_name": "Bangalore", "working_days": 10, "days_worked": 10.0 }
  ]
}</pre>

                    <div class="verification">
                        <strong>✅ Verified:</strong> <code>days_worked</code> (19) matches <code>total_working_days</code> (19). No salary inflation/deflation.
                    </div>
                </div>
            </details>

            <h3>&#9989; Consistent 2-Decimal Rounding</h3>
            <div class="info-box tip">
                <span class="icon">&#128178;</span>
                <div>
                    <strong>Precision Guarantee:</strong> All monetary calculations use <code>Math.Round(value, 2)</code> consistently, preventing cumulative rounding drift across components.
                </div>
            </div>

            <table>
                <thead>
                    <tr><th>Calculation Type</th><th>Rounding Applied</th><th>Example</th></tr>
                </thead>
                <tbody>
                    <tr><td>Daily Rate</td><td>2 decimals</td><td>₹33,333.33 ÷ 31 = ₹1,075.27</td></tr>
                    <tr><td>Component %</td><td>2 decimals</td><td>40% of ₹1,00,000 = ₹40,000.00</td></tr>
                    <tr><td>Proration</td><td>2 decimals</td><td>₹1,075.27 × 23 = ₹24,731.18</td></tr>
                    <tr><td>Tax Calculations</td><td>2 decimals</td><td>PT, ESI, PF all rounded</td></tr>
                    <tr><td>LOP Deductions</td><td>2 decimals</td><td>Gross ÷ Days × LOP</td></tr>
                </tbody>
            </table>

            <details class="api-proof">
                <summary>&#128269; Verified Example: Consistent Rounding</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Calculation: Prorated Salary</h5>
                    <pre>Monthly Salary: ₹33,333.33
Days in Month: 31
Days Worked: 23

Daily Rate = 33333.33 / 31 = 1075.2687096...
Rounded Daily Rate = 1075.27 (2 decimals)

Prorated = 1075.27 × 23 = 24731.21
Final Rounded = ₹24,731.21</pre>

                    <h5 class="response-label">Response: Payslip Values (All 2 Decimals)</h5>
                    <pre>{
  "gross_earnings": 92812.50,
  "total_deductions": 696.09,
  "net_pay": 92116.41,
  "location_breakdowns": [
    { "proration_factor": 0.473684, "gross_earnings": 39078.95 }
  ]
}</pre>

                    <div class="verification">
                        <strong>✅ Verified:</strong> All values maintain 2-decimal precision. No cumulative drift across components.
                    </div>
                </div>
            </details>

            <h3>&#9989; Bank Disbursement Payload</h3>
            <div class="info-box tip">
                <span class="icon">&#127974;</span>
                <div>
                    <strong>Bank-Ready Output:</strong> The engine generates bank transfer files in JSON and CSV formats, ready for direct upload to banking portals.
                </div>
            </div>

            <table>
                <thead>
                    <tr><th>Format</th><th>Endpoint</th><th>Use Case</th></tr>
                </thead>
                <tbody>
                    <tr><td>JSON</td><td><code>/runs/{id}/bank-file</code></td><td>API integration with banking systems</td></tr>
                    <tr><td>CSV</td><td><code>/runs/{id}/export-csv</code></td><td>Manual upload to bank portal</td></tr>
                </tbody>
            </table>

            <details class="api-proof">
                <summary>&#128269; Verified Example: Bank Transfer CSV</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Request: Export Payroll to CSV</h5>
                    <pre>GET /api/payroll-processing/runs/{runId}/export-csv
Authorization: Bearer &lt;token&gt;
Requires: HRMS_HR_ADMIN or HRMS_HR_MANAGER role</pre>

                    <h5 class="response-label">Response: Bank-Ready CSV File</h5>
                    <pre>Employee Code,Employee Name,Department,Designation,Bank Name,Account Number,IFSC Code,Basic,HRA,Special Allowance,Gross Earnings,PF Deduction,ESI Deduction,Professional Tax,Other Deductions,Total Deductions,Net Pay,Working Days,Days Worked,LOP Days
"EMP001","Rahul Sharma","Engineering","Software Engineer","HDFC Bank","1234567890","HDFC0001234",41265.63,20632.81,0,92812.50,0,0,0,696.09,696.09,92116.41,21,21.00,0.00</pre>

                    <h5 class="request-label">Request: Bank Transfer JSON</h5>
                    <pre>GET /api/payroll-processing/runs/{runId}/bank-file
Authorization: Bearer &lt;token&gt;
Requires: Payroll status = "approved"</pre>

                    <h5 class="response-label">Response: Structured Bank File</h5>
                    <pre>{
  "file_name": "BankTransfer_PR-202611-131705_20251217.csv",
  "file_format": "csv",
  "record_count": 1,
  "total_amount": 92116.41,
  "records": [
    {
      "employee_code": "EMP001",
      "employee_name": "Rahul Sharma",
      "bank_name": "HDFC Bank",
      "account_number": "1234567890",
      "ifsc_code": "HDFC0001234",
      "amount": 92116.41
    }
  ]
}</pre>

                    <div class="verification">
                        <strong>✅ Verified:</strong> Bank files generated with all required fields. CSV ready for direct bank portal upload.
                    </div>
                </div>
            </details>

            <h3>&#9989; Negative Net Pay Handling</h3>
            <div class="info-box tip">
                <span class="icon">&#128176;</span>
                <div>
                    <strong>Recovery Support:</strong> The engine intentionally supports negative net pay for Full & Final settlements where employees owe money (notice period shortfall, pending loans, clawbacks).
                </div>
            </div>

            <table>
                <thead>
                    <tr><th>Adjustment Type</th><th>Effect</th><th>Use Case</th></tr>
                </thead>
                <tbody>
                    <tr><td><code>recovery</code></td><td>Deduction</td><td>Notice period shortfall, asset recovery</td></tr>
                    <tr><td><code>deduction</code></td><td>Deduction</td><td>General deductions, penalties</td></tr>
                    <tr><td><code>arrears</code></td><td>Addition</td><td>Retrospective salary increases</td></tr>
                    <tr><td><code>bonus</code></td><td>Addition</td><td>Performance bonuses</td></tr>
                    <tr><td><code>reimbursement</code></td><td>Addition</td><td>Expense reimbursements</td></tr>
                </tbody>
            </table>

            <details class="api-proof">
                <summary>&#128269; Verified Example: Recovery Adjustment</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Request: Create Recovery Adjustment</h5>
                    <pre>POST /api/payroll-processing/adjustments
Content-Type: application/json

{
  "employee_id": "6e45111b-d883-4e85-87c5-22d9da3625a0",
  "adjustment_type": "recovery",
  "amount": 5000,
  "reason": "Notice period shortfall recovery",
  "effective_month": 12,
  "effective_year": 2026
}</pre>

                    <h5 class="response-label">Response: Recovery Created</h5>
                    <pre>{
  "id": "7868fdb9-4b9f-4eab-83d6-f741e5c66fbb",
  "adjustment_type": "recovery",
  "amount": 5000,
  "reason": "Notice period shortfall recovery",
  "status": "pending",
  "effective_month": 12,
  "effective_year": 2026
}</pre>

                    <div class="verification">
                        <strong>✅ Verified:</strong> Recovery adjustment created. Will be deducted from net pay during payroll processing. Negative net pay is valid for F&F settlements.
                    </div>
                </div>
            </details>

            <h3>&#9989; API-First Deterministic Computation</h3>
            <div class="info-box tip">
                <span class="icon">&#128640;</span>
                <div>
                    <strong>Reproducible Results:</strong> All payroll calculations are exposed via REST API with deterministic outputs. Same inputs always produce identical results, enabling testing, auditing, and integration.
                </div>
            </div>

            <table>
                <thead>
                    <tr><th>Capability</th><th>Benefit</th></tr>
                </thead>
                <tbody>
                    <tr><td>Stateless Computation</td><td>Each API call is independent and reproducible</td></tr>
                    <tr><td>Full Audit Trail</td><td>Every calculation logged with inputs and outputs</td></tr>
                    <tr><td>Embeddable Engine</td><td>Can be used as payroll-as-a-service via API</td></tr>
                    <tr><td>Testable</td><td>Automated testing against expected outputs</td></tr>
                </tbody>
            </table>

            <details class="api-proof">
                <summary>&#128269; Verified Example: Deterministic Payroll Run</summary>
                <div class="api-proof-content">
                    <h5 class="request-label">Request: Process Payroll</h5>
                    <pre>POST /api/payroll-processing/runs
{ "office_id": "...", "payroll_month": 11, "payroll_year": 2026 }

POST /api/payroll-processing/runs/{id}/process</pre>

                    <h5 class="response-label">Response: Deterministic Output</h5>
                    <pre>{
  "run_number": "PR-202611-131705",
  "total_employees": 1,
  "total_gross": 92812.50,
  "total_deductions": 696.09,
  "total_net": 92116.41,
  "status": "processed"
}</pre>

                    <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                        <strong>Determinism Guarantee:</strong> Running the same payroll for the same period with same employee data will always produce identical results: <code>gross=92812.50</code>, <code>net=92116.41</code>.
                    </p>

                    <div class="verification">
                        <strong>✅ Verified:</strong> All 22 capabilities in this document were validated via API calls with reproducible results.
                    </div>
                </div>
            </details>
        </section>

        <!-- Section 14: System Limitations -->
        <section id="limitations">
            <h2><span class="section-number">14</span> System Limitations</h2>

            <p>This section documents what the HyperDroid HRMS payroll engine <strong>CANNOT</strong> do or handles incorrectly. Understanding these limitations is critical for HR teams to avoid unexpected behavior.</p>

            <div class="info-box warning">
                <span class="icon">&#9888;&#65039;</span>
                <div>
                    <strong>Important:</strong> These limitations were identified through a thorough code audit. Some represent intentional design decisions, others are bugs that may be fixed in future releases.
                </div>
            </div>

            <h3>&#10060; Formula-Based Components (NOT IMPLEMENTED)</h3>
            <div class="info-box important">
                <span class="icon">&#128680;</span>
                <div>
                    <strong>Critical Limitation:</strong> Components with <code>calculation_type = "formula"</code> return <strong>0 (zero)</strong>. The formula evaluation engine is not implemented. Do NOT use formula-based components in production.
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>What You Might Expect</th>
                        <th>What Actually Happens</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Custom formula: <code>BASIC * 0.12 + HRA * 0.05</code></td>
                        <td>Returns <code>₹0.00</code></td>
                    </tr>
                    <tr>
                        <td>Conditional formula: <code>IF(GROSS > 50000, GROSS * 0.01, 0)</code></td>
                        <td>Returns <code>₹0.00</code></td>
                    </tr>
                </tbody>
            </table>
            <p><strong>Workaround:</strong> Use percentage-based or fixed-amount components instead. Break complex calculations into multiple simple components.</p>

            <h3>&#10060; Net Pay Validation (MISSING)</h3>
            <div class="info-box warning">
                <span class="icon">&#9888;&#65039;</span>
                <div>
                    <strong>Warning:</strong> The system does NOT validate that net pay is positive. If deductions exceed gross earnings, the payslip will show a <strong>negative net pay</strong>.
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Scenario</th>
                        <th>What Happens</th>
                        <th>Risk</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>LOP deduction exceeds gross</td>
                        <td>Negative net pay calculated</td>
                        <td>&#128308; High</td>
                    </tr>
                    <tr>
                        <td>EMI exceeds remaining pay</td>
                        <td>Negative net pay calculated</td>
                        <td>&#128308; High</td>
                    </tr>
                    <tr>
                        <td>Multiple large deductions</td>
                        <td>Negative net pay calculated</td>
                        <td>&#128308; High</td>
                    </tr>
                </tbody>
            </table>
            <p><strong>Recommendation:</strong> HR must manually verify that total deductions do not exceed gross earnings before approving payroll.</p>

            <h3>&#10060; LOP Days Validation (MISSING)</h3>
            <div class="info-box warning">
                <span class="icon">&#9888;&#65039;</span>
                <div>
                    <strong>Warning:</strong> The system does NOT validate that LOP days ≤ working days. If LOP days exceed working days, the deduction will exceed the gross salary.
                </div>
            </div>
            <p><strong>Example of the bug:</strong></p>
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Working Days</td>
                        <td>22</td>
                    </tr>
                    <tr>
                        <td>LOP Days (incorrectly entered)</td>
                        <td>25</td>
                    </tr>
                    <tr>
                        <td>Daily Rate</td>
                        <td>₹4,545.45</td>
                    </tr>
                    <tr>
                        <td>LOP Deduction</td>
                        <td>₹113,636.25 (exceeds gross!)</td>
                    </tr>
                </tbody>
            </table>
            <p><strong>Workaround:</strong> Manually verify LOP days do not exceed working days before processing.</p>

            <h3>&#10060; Zero Working Days Edge Case</h3>
            <p>If a month somehow has zero working days (e.g., entire month is holidays + weekends), the system sets working days to 1 to avoid division by zero. This is mathematically incorrect but prevents crashes.</p>
            <div class="code-block">
                <pre>
// Code from BusinessLayer_PayrollProcessing.cs line 241-245
if (fullMonthWorkingDays <= 0)
    fullMonthWorkingDays = 1; // Arbitrary, prevents division by zero</pre>
            </div>

            <h3>&#10060; Annual Cap Enforcement (MISSING)</h3>
            <div class="info-box tip">
                <span class="icon">&#9989;</span>
                <div>
                    <strong>Monthly Caps Prorated Correctly:</strong> When an employee has multiple structure versions in a month, each version's cap is prorated by working days. Total deduction = sum of prorated caps.
                </div>
            </div>

            <p><strong>&#128269; Verified Example: Multi-Version Cap Proration</strong></p>
            <table>
                <thead>
                    <tr>
                        <th>Version</th>
                        <th>Period</th>
                        <th>Working Days</th>
                        <th>Cap</th>
                        <th>Prorated</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Version 1</td>
                        <td>Dec 1-14</td>
                        <td>10 of 23</td>
                        <td>₹400</td>
                        <td>₹400 × 0.4348 = ₹173.91</td>
                    </tr>
                    <tr>
                        <td>Version 2</td>
                        <td>Dec 15-31</td>
                        <td>13 of 23</td>
                        <td>₹600</td>
                        <td>₹600 × 0.5652 = ₹339.13</td>
                    </tr>
                    <tr>
                        <td colspan="4"><strong>Total ESIC-EE</strong></td>
                        <td><strong>₹513.04</strong></td>
                    </tr>
                </tbody>
            </table>
            <div class="code-block api-proof">
                <pre>
GET /api/payroll-processing/payslips/fce5970e-58b2-4f61-bd6c-6eca8f84c399
Response: {
  "total_deductions": 513.04,
  "gross_earnings": 88328.81,
  "net_pay": 87815.77
}

SELECT component_code, amount FROM payslip_items WHERE payslip_id = '...'
 ESIC-EE | 513.04  ← Exact match with prorated calculation</pre>
            </div>

            <p>However, the system does NOT enforce <strong>annual caps</strong>. YTD amounts are tracked for reporting, but not checked against statutory annual limits.</p>
            <p><strong>Example:</strong> EPF annual wage ceiling is ₹15,000/month base. If an employee exceeds this across the year, the system continues deducting instead of stopping.</p>
            <p><strong>Workaround:</strong> HR must manually monitor YTD statutory deductions and adjust when annual caps are reached.</p>

            <!-- REMOVED: Overlapping Transfer Records - This was incorrect.
                 The system DOES prevent overlapping transfers via BusinessLayer_EmployeeTransfers.cs
                 See Payroll-API-Validation.md "Overlapping Transfers Prevention" section for proof. -->
        </section>

        <!-- Section 15: Real-World Scenarios -->
        <section id="scenarios">
            <h2><span class="section-number">15</span> Real-World Scenarios</h2>

            <p>This section provides comprehensive examples showing how the payroll engine handles various real-world situations. Each scenario includes the calculation breakdown so HR can verify payslip accuracy.</p>

            <h3>Scenario 1: Normal Month (No Changes)</h3>
            <div class="info-box tip">
                <span class="icon">&#128204;</span>
                <div>
                    <strong>Context:</strong> Employee worked full month with no changes, leaves, or adjustments. This is the baseline scenario.
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Employee</td><td>John Doe (EMP001)</td></tr>
                    <tr><td>CTC</td><td>₹12,00,000 per annum</td></tr>
                    <tr><td>Month</td><td>December 2025</td></tr>
                    <tr><td>Working Days</td><td>22</td></tr>
                    <tr><td>Days Worked</td><td>22</td></tr>
                    <tr><td>LOP Days</td><td>0</td></tr>
                </tbody>
            </table>

            <h4>Earnings Calculation</h4>
            <table>
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Formula</th>
                        <th>Calculation</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>BASIC</td>
                        <td>40% of CTC/12</td>
                        <td>12,00,000 × 0.40 / 12</td>
                        <td>₹40,000.00</td>
                    </tr>
                    <tr>
                        <td>HRA</td>
                        <td>50% of Basic</td>
                        <td>40,000 × 0.50</td>
                        <td>₹20,000.00</td>
                    </tr>
                    <tr>
                        <td>Special Allowance</td>
                        <td>Balance</td>
                        <td>100,000 - 40,000 - 20,000 - 1,600 - 1,250</td>
                        <td>₹37,150.00</td>
                    </tr>
                    <tr>
                        <td>Conveyance</td>
                        <td>Fixed</td>
                        <td>-</td>
                        <td>₹1,600.00</td>
                    </tr>
                    <tr>
                        <td>Medical</td>
                        <td>Fixed</td>
                        <td>-</td>
                        <td>₹1,250.00</td>
                    </tr>
                    <tr style="font-weight: bold; background: #f0f9ff;">
                        <td>GROSS EARNINGS</td>
                        <td>-</td>
                        <td>-</td>
                        <td>₹1,00,000.00</td>
                    </tr>
                </tbody>
            </table>

            <h4>Deductions Calculation</h4>
            <table>
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Formula</th>
                        <th>Calculation</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>PF (Employee)</td>
                        <td>12% of Basic (max ₹1,800)</td>
                        <td>min(40,000 × 0.12, 1,800)</td>
                        <td>₹1,800.00</td>
                    </tr>
                    <tr>
                        <td>Professional Tax</td>
                        <td>Fixed</td>
                        <td>-</td>
                        <td>₹200.00</td>
                    </tr>
                    <tr>
                        <td>ESI (Employee)</td>
                        <td>0.75% of Gross (if applicable)</td>
                        <td>Not applicable (gross > ₹21,000)</td>
                        <td>₹0.00</td>
                    </tr>
                    <tr style="font-weight: bold; background: #fef2f2;">
                        <td>TOTAL DEDUCTIONS</td>
                        <td>-</td>
                        <td>-</td>
                        <td>₹2,000.00</td>
                    </tr>
                </tbody>
            </table>

            <h4>Net Pay</h4>
            <div class="code-block">
                <pre>
Net Pay = Gross Earnings - Total Deductions
Net Pay = ₹1,00,000.00 - ₹2,000.00
<strong>Net Pay = ₹98,000.00</strong></pre>
            </div>

            <h3>Scenario 2: Mid-Month CTC Increase (Promotion)</h3>
            <div class="info-box tip">
                <span class="icon">&#128204;</span>
                <div>
                    <strong>Context:</strong> Employee gets promoted on December 15th. CTC increases from ₹12,00,000 to ₹15,00,000. System must prorate both salaries.
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Period</th>
                        <th>CTC</th>
                        <th>Working Days</th>
                        <th>Proration Factor</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Dec 1-14 (Old CTC)</td>
                        <td>₹12,00,000</td>
                        <td>10</td>
                        <td>10/22 = 45.45%</td>
                    </tr>
                    <tr>
                        <td>Dec 15-31 (New CTC)</td>
                        <td>₹15,00,000</td>
                        <td>12</td>
                        <td>12/22 = 54.55%</td>
                    </tr>
                    <tr style="font-weight: bold;">
                        <td>TOTAL</td>
                        <td>-</td>
                        <td>22</td>
                        <td>100%</td>
                    </tr>
                </tbody>
            </table>

            <h4>Period 1 Calculation (Dec 1-14, CTC = ₹12,00,000)</h4>
            <table>
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Full Month</th>
                        <th>× Proration (45.45%)</th>
                        <th>Period Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>BASIC</td>
                        <td>₹40,000.00</td>
                        <td>× 0.4545</td>
                        <td>₹18,181.82</td>
                    </tr>
                    <tr>
                        <td>HRA</td>
                        <td>₹20,000.00</td>
                        <td>× 0.4545</td>
                        <td>₹9,090.91</td>
                    </tr>
                    <tr>
                        <td>Special Allowance</td>
                        <td>₹37,150.00</td>
                        <td>× 0.4545</td>
                        <td>₹16,886.36</td>
                    </tr>
                    <tr>
                        <td>Conveyance</td>
                        <td>₹1,600.00</td>
                        <td>× 0.4545</td>
                        <td>₹727.27</td>
                    </tr>
                    <tr>
                        <td>Medical</td>
                        <td>₹1,250.00</td>
                        <td>× 0.4545</td>
                        <td>₹568.18</td>
                    </tr>
                    <tr style="font-weight: bold; background: #f0f9ff;">
                        <td>GROSS (Period 1)</td>
                        <td>₹1,00,000.00</td>
                        <td>-</td>
                        <td>₹45,454.55</td>
                    </tr>
                </tbody>
            </table>

            <h4>Period 2 Calculation (Dec 15-31, CTC = ₹15,00,000)</h4>
            <table>
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Full Month</th>
                        <th>× Proration (54.55%)</th>
                        <th>Period Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>BASIC</td>
                        <td>₹50,000.00</td>
                        <td>× 0.5455</td>
                        <td>₹27,272.73</td>
                    </tr>
                    <tr>
                        <td>HRA</td>
                        <td>₹25,000.00</td>
                        <td>× 0.5455</td>
                        <td>₹13,636.36</td>
                    </tr>
                    <tr>
                        <td>Special Allowance</td>
                        <td>₹46,437.50</td>
                        <td>× 0.5455</td>
                        <td>₹25,329.55</td>
                    </tr>
                    <tr>
                        <td>Conveyance</td>
                        <td>₹1,600.00</td>
                        <td>× 0.5455</td>
                        <td>₹872.73</td>
                    </tr>
                    <tr>
                        <td>Medical</td>
                        <td>₹1,250.00</td>
                        <td>× 0.5455</td>
                        <td>₹681.82</td>
                    </tr>
                    <tr style="font-weight: bold; background: #f0f9ff;">
                        <td>GROSS (Period 2)</td>
                        <td>₹1,25,000.00</td>
                        <td>-</td>
                        <td>₹68,181.82</td>
                    </tr>
                </tbody>
            </table>

            <h4>Final Payslip</h4>
            <div class="code-block">
                <pre>
Total Gross = Period 1 Gross + Period 2 Gross
Total Gross = ₹45,454.55 + ₹68,181.82
<strong>Total Gross = ₹1,13,636.36</strong>

Total Deductions ≈ ₹2,200.00 (prorated PF + PT)
<strong>Net Pay ≈ ₹1,11,436.36</strong></pre>
            </div>

            <h3>Scenario 3: Multi-Location Transfer Mid-Month</h3>
            <div class="info-box tip">
                <span class="icon">&#128204;</span>
                <div>
                    <strong>Context:</strong> Employee transfers from Mumbai (Sat-Sun weekend) to Dubai (Fri-Sat weekend) on December 15th. Each location has different working days and different taxes.
                </div>
            </div>

            <h4>Working Days Calculation</h4>
            <table>
                <thead>
                    <tr>
                        <th>Location</th>
                        <th>Period</th>
                        <th>Weekend Policy</th>
                        <th>Calendar Days</th>
                        <th>Weekends</th>
                        <th>Holidays</th>
                        <th>Working Days</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Mumbai</td>
                        <td>Dec 1-14</td>
                        <td>Sat-Sun</td>
                        <td>14</td>
                        <td>4 (Dec 1, 7, 8, 14)</td>
                        <td>0</td>
                        <td>10</td>
                    </tr>
                    <tr>
                        <td>Dubai</td>
                        <td>Dec 15-31</td>
                        <td>Fri-Sat</td>
                        <td>17</td>
                        <td>5 (Dec 19, 20, 26, 27)</td>
                        <td>1 (Dec 25)</td>
                        <td>11</td>
                    </tr>
                    <tr style="font-weight: bold;">
                        <td colspan="6">TOTAL WORKING DAYS</td>
                        <td>21</td>
                    </tr>
                </tbody>
            </table>

            <div class="info-box important">
                <span class="icon">&#9888;&#65039;</span>
                <div>
                    <strong>Note:</strong> The full month working days for proration denominator is 21 (sum of both locations), NOT 22 (Mumbai's full month). This is because the employee actually had 21 working days available across both locations.
                </div>
            </div>

            <h4>Location Breakdown</h4>
            <table>
                <thead>
                    <tr>
                        <th>Attribute</th>
                        <th>Mumbai (Dec 1-14)</th>
                        <th>Dubai (Dec 15-31)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Working Days</td>
                        <td>10</td>
                        <td>11</td>
                    </tr>
                    <tr>
                        <td>Proration Factor</td>
                        <td>10/21 = 47.62%</td>
                        <td>11/21 = 52.38%</td>
                    </tr>
                    <tr>
                        <td>Gross Earnings</td>
                        <td>₹47,619.05</td>
                        <td>₹52,380.95</td>
                    </tr>
                    <tr>
                        <td>Professional Tax</td>
                        <td>₹200 (Maharashtra)</td>
                        <td>₹0 (UAE - no PT)</td>
                    </tr>
                    <tr>
                        <td>Other Local Taxes</td>
                        <td>₹0</td>
                        <td>₹0</td>
                    </tr>
                    <tr style="font-weight: bold; background: #f0fdf4;">
                        <td>Net Pay (Location)</td>
                        <td>₹46,485.71</td>
                        <td>₹51,428.57</td>
                    </tr>
                </tbody>
            </table>

            <h4>Final Payslip Summary</h4>
            <div class="code-block">
                <pre>
Total Gross = ₹47,619.05 + ₹52,380.95 = ₹1,00,000.00
Total PT = ₹200 (Mumbai only)
Total Deductions = ₹2,000.00 (PF + PT)
<strong>Total Net Pay = ₹97,914.29</strong>

Payslip shows: is_multi_location = true
Location breakdowns included for audit trail</pre>
            </div>

            <h3>Scenario 4: Employee Joins Mid-Month</h3>
            <div class="info-box tip">
                <span class="icon">&#128204;</span>
                <div>
                    <strong>Context:</strong> New employee joins on December 10th. First payroll should only include days worked (Dec 10-31).
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Join Date</td><td>December 10, 2025</td></tr>
                    <tr><td>CTC</td><td>₹12,00,000 per annum</td></tr>
                    <tr><td>Full Month Working Days</td><td>22</td></tr>
                    <tr><td>Days to Pay (Dec 10-31)</td><td>15</td></tr>
                    <tr><td>Proration Factor</td><td>15/22 = 68.18%</td></tr>
                </tbody>
            </table>

            <h4>Prorated Earnings</h4>
            <table>
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Full Month</th>
                        <th>× Proration (68.18%)</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>BASIC</td>
                        <td>₹40,000.00</td>
                        <td>× 0.6818</td>
                        <td>₹27,272.73</td>
                    </tr>
                    <tr>
                        <td>HRA</td>
                        <td>₹20,000.00</td>
                        <td>× 0.6818</td>
                        <td>₹13,636.36</td>
                    </tr>
                    <tr>
                        <td>Special Allowance</td>
                        <td>₹37,150.00</td>
                        <td>× 0.6818</td>
                        <td>₹25,329.55</td>
                    </tr>
                    <tr>
                        <td>Conveyance</td>
                        <td>₹1,600.00</td>
                        <td>× 0.6818</td>
                        <td>₹1,090.91</td>
                    </tr>
                    <tr>
                        <td>Medical</td>
                        <td>₹1,250.00</td>
                        <td>× 0.6818</td>
                        <td>₹852.27</td>
                    </tr>
                    <tr style="font-weight: bold; background: #f0f9ff;">
                        <td>GROSS</td>
                        <td>₹1,00,000.00</td>
                        <td>-</td>
                        <td>₹68,181.82</td>
                    </tr>
                </tbody>
            </table>

            <h3>Scenario 5: Employee with LOP (Loss of Pay)</h3>
            <div class="info-box tip">
                <span class="icon">&#128204;</span>
                <div>
                    <strong>Context:</strong> Employee took 5 days of unpaid leave. LOP deduction is calculated based on daily rate.
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Gross Earnings</td><td>₹1,00,000.00</td></tr>
                    <tr><td>Working Days</td><td>22</td></tr>
                    <tr><td>Daily Rate</td><td>₹1,00,000 / 22 = ₹4,545.45</td></tr>
                    <tr><td>LOP Days</td><td>5</td></tr>
                    <tr><td>LOP Deduction</td><td>₹4,545.45 × 5 = ₹22,727.27</td></tr>
                </tbody>
            </table>

            <h4>Payslip with LOP</h4>
            <div class="code-block">
                <pre>
Gross Earnings:        ₹1,00,000.00
LOP Deduction:        -₹22,727.27
<strong>Gross After LOP:       ₹77,272.73</strong>

Deductions (PF, PT):   -₹2,000.00
<strong>Net Pay:               ₹75,272.73</strong></pre>
            </div>

            <h3>Scenario 6: Maximum Complexity (30 Structure Changes + Transfer + Arrears + Loan)</h3>
            <div class="info-box important">
                <span class="icon">&#128680;</span>
                <div>
                    <strong>Extreme Scenario:</strong> This tests the system's ability to handle multiple simultaneous changes. While unlikely in practice, it demonstrates calculation robustness.
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Change Type</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Salary Structure Versions</td>
                        <td>22 different versions (one per working day) - testing extreme case</td>
                    </tr>
                    <tr>
                        <td>Office Transfers</td>
                        <td>Mumbai → Delhi (Dec 10) → Bangalore (Dec 20)</td>
                    </tr>
                    <tr>
                        <td>Arrears</td>
                        <td>₹15,000 from previous month revision</td>
                    </tr>
                    <tr>
                        <td>Active Loan</td>
                        <td>EMI ₹8,500/month</td>
                    </tr>
                    <tr>
                        <td>Bonus</td>
                        <td>₹25,000 performance bonus</td>
                    </tr>
                </tbody>
            </table>

            <h4>How the System Handles This</h4>
            <ol>
                <li><strong>Creates intersection periods:</strong> For each unique (Location × Salary Version) combination</li>
                <li><strong>Calculates each period independently:</strong> Using that period's version components</li>
                <li><strong>Applies location-specific taxes:</strong> Different PT rates for MH, DL, KA</li>
                <li><strong>Aggregates all periods:</strong> Sum of all gross, deductions, taxes</li>
                <li><strong>Adds adjustments:</strong> Arrears (+₹15,000) + Bonus (+₹25,000)</li>
                <li><strong>Deducts loan EMI:</strong> -₹8,500</li>
                <li><strong>Generates detailed payslip:</strong> With location breakdown and item-level detail</li>
            </ol>

            <div class="info-box tip">
                <span class="icon">&#127919;</span>
                <div>
                    <strong>Verification:</strong> Even with 22 versions, the sum of all proration factors equals 100% (22 × 1/22 = 1.0). Each day is accounted for exactly once.
                </div>
            </div>

            <h3>Scenario 7: Edge Case - EMI Exceeds Net Pay</h3>
            <div class="info-box warning">
                <span class="icon">&#9888;&#65039;</span>
                <div>
                    <strong>Warning:</strong> This scenario demonstrates a system limitation. No validation prevents negative net pay.
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Gross Earnings</td><td>₹50,000.00</td></tr>
                    <tr><td>LOP Deduction (15 days)</td><td>-₹34,090.91</td></tr>
                    <tr><td>Gross After LOP</td><td>₹15,909.09</td></tr>
                    <tr><td>PF + PT</td><td>-₹2,000.00</td></tr>
                    <tr><td>Loan EMI</td><td>-₹20,000.00</td></tr>
                    <tr style="background: #fef2f2; font-weight: bold;">
                        <td>NET PAY</td>
                        <td style="color: red;">-₹6,090.91 ⚠️</td>
                    </tr>
                </tbody>
            </table>

            <div class="info-box important">
                <span class="icon">&#128680;</span>
                <div>
                    <strong>System Behavior:</strong> The payslip will be generated with negative net pay. HR MUST review and manually adjust before approving. Consider:
                    <ul>
                        <li>Deferring the EMI to next month</li>
                        <li>Partially deducting the EMI</li>
                        <li>Creating a recovery adjustment for next month</li>
                    </ul>
                </div>
            </div>

            <h3>Scenario 8: Retrospective Salary Revision (Arrears)</h3>
            <div class="info-box tip">
                <span class="icon">&#128204;</span>
                <div>
                    <strong>Context:</strong> Salary structure version 2 is created on March 15th but effective from January 1st. System must calculate arrears for Jan, Feb, and half of March.
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Old Gross</th>
                        <th>New Gross</th>
                        <th>Arrears</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>January</td>
                        <td>₹80,000</td>
                        <td>₹85,000</td>
                        <td>₹5,000</td>
                    </tr>
                    <tr>
                        <td>February</td>
                        <td>₹80,000</td>
                        <td>₹85,000</td>
                        <td>₹5,000</td>
                    </tr>
                    <tr>
                        <td>March 1-14</td>
                        <td>₹36,363.64</td>
                        <td>₹38,636.36</td>
                        <td>₹2,272.73</td>
                    </tr>
                    <tr style="font-weight: bold; background: #f0fdf4;">
                        <td colspan="3">TOTAL ARREARS</td>
                        <td>₹12,272.73</td>
                    </tr>
                </tbody>
            </table>

            <p>This arrears amount is added to the March payslip as an adjustment of type "arrears".</p>

            <h3>Scenario 9: Weekend Falls on Holiday</h3>
            <div class="info-box tip">
                <span class="icon">&#128204;</span>
                <div>
                    <strong>Context:</strong> December 25th (Christmas) falls on a Sunday. How does the system count it?
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Day</th>
                        <th>Is Weekend?</th>
                        <th>Is Holiday?</th>
                        <th>Counted As</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Dec 25, 2025</td>
                        <td>Thursday</td>
                        <td>No</td>
                        <td>Yes (Christmas)</td>
                        <td>Holiday (not working day)</td>
                    </tr>
                    <tr>
                        <td>Dec 26, 2026 (hypothetical)</td>
                        <td>Sunday</td>
                        <td>Yes</td>
                        <td>Yes (Christmas)</td>
                        <td>Weekend (counted only once)</td>
                    </tr>
                </tbody>
            </table>

            <div class="info-box tip">
                <span class="icon">&#9989;</span>
                <div>
                    <strong>Correct Behavior:</strong> When a holiday falls on a weekend, it's counted as a weekend day only. The system does NOT double-deduct (subtracting both as weekend AND holiday). This ensures working days are calculated correctly.
                </div>
            </div>

            <h3>Scenario 10: Employee Termination Mid-Month</h3>
            <div class="info-box tip">
                <span class="icon">&#128204;</span>
                <div>
                    <strong>Context:</strong> Employee's last working day is December 15th. Final payslip should only include Dec 1-15.
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Last Working Day</td><td>December 15, 2025</td></tr>
                    <tr><td>CTC</td><td>₹12,00,000 per annum</td></tr>
                    <tr><td>Full Month Working Days</td><td>22</td></tr>
                    <tr><td>Days to Pay (Dec 1-15)</td><td>11</td></tr>
                    <tr><td>Proration Factor</td><td>11/22 = 50%</td></tr>
                </tbody>
            </table>

            <h4>Final Settlement Components</h4>
            <table>
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Full Month</th>
                        <th>Prorated (50%)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Gross Earnings</td>
                        <td>₹1,00,000.00</td>
                        <td>₹50,000.00</td>
                    </tr>
                    <tr>
                        <td>Earned Leave Encashment (10 days)</td>
                        <td>-</td>
                        <td>₹45,454.55</td>
                    </tr>
                    <tr>
                        <td>Gratuity (if applicable)</td>
                        <td>-</td>
                        <td>As per policy</td>
                    </tr>
                    <tr>
                        <td>Notice Period Recovery</td>
                        <td>-</td>
                        <td>As per policy</td>
                    </tr>
                </tbody>
            </table>

            <div class="info-box important">
                <span class="icon">&#8505;&#65039;</span>
                <div>
                    <strong>Note:</strong> Full &amp; Final settlement may include additional components like gratuity, leave encashment, notice period recovery, etc. These are handled as manual adjustments in the system.
                </div>
            </div>
        </section>

        <!-- Section 16: Location Tax Rules -->
        <section id="location-tax-rules">
            <h2><span class="section-number">16</span> Location Tax Rules</h2>
            <p>The system supports location-specific tax rules for compliance with state-level regulations like Professional Tax (PT), Labour Welfare Fund (LWF), etc.</p>

            <h3>16.1 Tax Types Management</h3>
            <p>Define different tax types that can be applied across offices.</p>

            <div class="code-block">
                <div class="code-header">POST /api/location-taxes/types - Create Tax Type</div>
                <pre>{
  "tax_code": "PT",
  "tax_name": "Professional Tax",
  "description": "State-level professional tax deduction",
  "calculation_type": "slab",
  "is_statutory": true,
  "is_active": true
}</pre>
            </div>

            <div class="code-block">
                <div class="code-header">Response - Tax Type Created</div>
                <pre>{
  "id": "36215e77-715b-4b06-9eec-460fd6e3db5b",
  "tax_code": "PT",
  "tax_name": "Professional Tax",
  "deduction_from": "employee",
  "is_statutory": true,
  "affects_taxable_income": false,
  "is_active": true
}</pre>
            </div>

            <h3>16.2 Tax Rules with Slabs</h3>
            <p>Create office-specific tax rules with slab-based calculations.</p>

            <div class="code-block">
                <div class="code-header">POST /api/location-taxes/rules - Create Tax Rule</div>
                <pre>{
  "rule_name": "Karnataka Professional Tax",
  "tax_type_id": "36215e77-715b-4b06-9eec-460fd6e3db5b",
  "office_id": "a5f3330f-0fc4-4b23-95a7-2040b29584b8",
  "effective_from": "2024-01-01",
  "calculation_type": "slab",
  "slab_config_json": "{\"slabs\":[
    {\"min_amount\":0,\"max_amount\":15000,\"calculation_type\":\"fixed\",\"value\":0},
    {\"min_amount\":15001,\"max_amount\":null,\"calculation_type\":\"fixed\",\"value\":200}
  ]}"
}</pre>
            </div>

            <h3>16.3 Tax Calculation Preview</h3>
            <p>Preview tax calculations before applying them.</p>

            <div class="code-block">
                <div class="code-header">POST /api/location-taxes/calculate-preview</div>
                <pre>Request:
{
  "office_id": "a5f3330f-0fc4-4b23-95a7-2040b29584b8",
  "gross_salary": 50000,
  "effective_date": "2024-06-01"
}

Response:
{
  "gross_salary": 50000,
  "taxable_income": 50000,
  "tax_items": [{
    "rule_name": "Karnataka Professional Tax",
    "tax_code": "PT",
    "calculation_type": "slab",
    "tax_amount": 200,
    "is_employer_contribution": false
  }],
  "total_employee_tax": 200,
  "total_employer_tax": 0,
  "total_tax": 200
}</pre>
            </div>

            <div class="info-box tip">
                <span class="icon">&#128161;</span>
                <div>
                    <strong>Slab Configuration:</strong> Each slab has <code>min_amount</code>, <code>max_amount</code> (null = unlimited), <code>calculation_type</code> (fixed/percentage), and <code>value</code>.
                </div>
            </div>
        </section>

        <!-- Section 17: Payroll Drafts -->
        <section id="payroll-drafts">
            <h2><span class="section-number">17</span> Payroll Drafts</h2>
            <p>Create draft payroll runs for what-if analysis before committing to actual payroll processing.</p>

            <h3>17.1 Create Draft</h3>
            <div class="code-block">
                <div class="code-header">POST /api/payroll-drafts - Create Draft</div>
                <pre>Request:
{
  "office_id": "a5f3330f-0fc4-4b23-95a7-2040b29584b8",
  "payroll_month": 1,
  "payroll_year": 2027,
  "draft_name": "January 2027 Draft"
}

Response:
{
  "id": "afafdeb6-9d83-428b-85ae-26b5d2b5cda9",
  "draft_number": 1,
  "draft_name": "January 2027 Draft",
  "run_number": "DFT-202701-01",
  "status": "pending",
  "total_employees": 1,
  "total_gross": 990000.00,
  "total_net": 982575.00
}</pre>
            </div>

            <h3>17.2 Process Draft</h3>
            <div class="code-block">
                <div class="code-header">POST /api/payroll-drafts/{id}/process</div>
                <pre>Response:
{
  "success": true,
  "draft_id": "afafdeb6-9d83-428b-85ae-26b5d2b5cda9",
  "message": "Successfully generated 1 payslips",
  "employees_processed": 1,
  "payslips_generated": 1,
  "total_gross": 92812.50,
  "total_deductions": 600.00,
  "total_net": 92212.50,
  "errors": [],
  "warnings": []
}</pre>
            </div>

            <h3>17.3 Draft Workflow</h3>
            <table class="simple-table">
                <thead>
                    <tr>
                        <th>Endpoint</th>
                        <th>Action</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>POST /payroll-drafts</code></td>
                        <td>Create</td>
                        <td>Create new draft for a period</td>
                    </tr>
                    <tr>
                        <td><code>POST /{id}/process</code></td>
                        <td>Process</td>
                        <td>Generate draft payslips</td>
                    </tr>
                    <tr>
                        <td><code>POST /{id}/recalculate</code></td>
                        <td>Recalculate</td>
                        <td>Re-process after changes</td>
                    </tr>
                    <tr>
                        <td><code>POST /{id}/finalize</code></td>
                        <td>Finalize</td>
                        <td>Convert to actual payroll run</td>
                    </tr>
                    <tr>
                        <td><code>DELETE /{id}</code></td>
                        <td>Delete</td>
                        <td>Discard draft</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Section 18: Salary Revisions -->
        <section id="salary-revisions">
            <h2><span class="section-number">18</span> Salary Revisions</h2>
            <p>Track salary changes over time with full revision history.</p>

            <h3>18.1 Get Salary History</h3>
            <div class="code-block">
                <div class="code-header">GET /api/payroll/employee/{id}/salary/history</div>
                <pre>[
  {
    "id": "ca08c16a-d42c-4b3a-a1d9-4ce12871368a",
    "ctc": 1500000.00,
    "effective_from": "2026-08-15",
    "is_current": true,
    "revision_reason": "Mid-month proration test - 25% increment",
    "structure_name": "Bangalore Tech Structure"
  },
  {
    "id": "0b009c70-2e6b-476b-8f41-143e830783fa",
    "ctc": 1200000.00,
    "effective_from": "2026-06-15",
    "effective_to": "2026-08-14",
    "is_current": false,
    "revision_reason": "Structure change due to office transfer"
  }
]</pre>
            </div>

            <h3>18.2 Get Revision Details</h3>
            <div class="code-block">
                <div class="code-header">GET /api/payroll/employee/{id}/salary/revisions</div>
                <pre>[
  {
    "old_ctc": 1200000.00,
    "new_ctc": 1500000.00,
    "increment_amount": 300000.00,
    "increment_percentage": 25.00,
    "revision_type": "annual_increment",
    "revision_reason": "Mid-month proration test - 25% increment",
    "effective_date": "2026-08-15"
  },
  {
    "old_ctc": 1200000.00,
    "new_ctc": 1200000.00,
    "increment_amount": 0.00,
    "revision_type": "adjustment",
    "revision_reason": "Structure change due to office transfer"
  },
  {
    "old_ctc": null,
    "new_ctc": 1200000.00,
    "revision_type": "joining",
    "effective_date": "2025-01-01"
  }
]</pre>
            </div>

            <div class="info-box tip">
                <span class="icon">&#128161;</span>
                <div>
                    <strong>Revision Types:</strong> <code>joining</code> (initial), <code>annual_increment</code>, <code>promotion</code>, <code>adjustment</code>, <code>transfer</code>
                </div>
            </div>
        </section>

        <!-- Section 19: Loan Lifecycle -->
        <section id="loan-lifecycle">
            <h2><span class="section-number">19</span> Loan Lifecycle</h2>
            <p>Complete loan management from application to disbursement and recovery.</p>

            <h3>19.1 Loan Status Flow</h3>
            <div class="formula-box">
                <strong>Loan Status Lifecycle:</strong>
                <p style="margin-top: 10px; font-family: monospace;">
                    pending → approved → disbursed → active → closed<br>
                    pending → rejected (if not approved)
                </p>
            </div>

            <h3>19.2 Pending Loans</h3>
            <div class="code-block">
                <div class="code-header">GET /api/payroll-processing/loans/pending</div>
                <pre>[
  {
    "id": "3a985d80-adb4-4254-acca-2c186de830b6",
    "loan_number": "LN-EMP001-20251216120354",
    "loan_type": "personal_loan",
    "principal_amount": 100000.00,
    "interest_rate": 12.00,
    "interest_calculation_type": "simple",
    "total_amount": 112000.00,
    "emi_amount": 9333.33,
    "tenure_months": 12,
    "status": "pending",
    "employee_code": "EMP001"
  }
]</pre>
            </div>

            <h3>19.3 Approve Loan (VERIFIED 2025-12-17)</h3>
            <div class="code-block">
                <div class="code-header">POST /api/payroll-processing/loans/e9d4765c-4878-4ec0-b1cd-43c0b1ad2c2a/approve</div>
                <pre>// Request
{"approved": true}

// Response - Loan APPROVED ✓
{
  "id": "e9d4765c-4878-4ec0-b1cd-43c0b1ad2c2a",
  "loan_number": "LN-EMP001-202512161215115565",
  "loan_type": "salary_advance",
  "principal_amount": 25000.0,
  "status": "approved",
  "approved_at": "2025-12-17T04:59:22.768249Z",
  "approver_type": "superadmin"
}</pre>
            </div>

            <h3>19.4 Reject Loan (VERIFIED 2025-12-17)</h3>
            <div class="code-block">
                <div class="code-header">POST /api/payroll-processing/loans/8eacde5e-f856-4572-9f94-f6e3f15f505e/approve</div>
                <pre>// Request
{"approved": false, "rejection_reason": "Testing rejection workflow"}

// Response - Loan REJECTED ✓
{
  "id": "8eacde5e-f856-4572-9f94-f6e3f15f505e",
  "status": "rejected",
  "rejection_reason": "Testing rejection workflow",
  "approved_at": "2025-12-17T04:59:45.123456Z",
  "approver_type": "superadmin"
}</pre>
            </div>

            <h3>19.5 Disburse Approved Loan</h3>
            <table class="simple-table">
                <thead>
                    <tr>
                        <th>Endpoint</th>
                        <th>Purpose</th>
                        <th>Required Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>POST /loans/{id}/approve</code></td>
                        <td>Approve/Reject loan</td>
                        <td>pending</td>
                    </tr>
                    <tr>
                        <td><code>POST /loans/{id}/disburse</code></td>
                        <td>Disburse approved loan</td>
                        <td>approved</td>
                    </tr>
                </tbody>
            </table>

            <div class="code-block">
                <div class="code-header">POST /api/payroll-processing/loans/{id}/disburse</div>
                <pre>// Request
{"mode": "bank_transfer", "reference": "TXN-2025-12-001"}

// Response - Loan DISBURSED & ACTIVE ✓
{
  "id": "43372422-f755-410a-bb6a-843aa1a1ca38",
  "status": "active",
  "disbursed_date": "2025-12-17",
  "disbursed_amount": 100000.0,
  "disbursement_mode": "bank_transfer",
  "disbursement_reference": "TXN-2025-12-001"
}</pre>
            </div>

            <div class="info-box" style="margin-top: 15px;">
                <strong>✅ Loan Lifecycle Verification Complete:</strong>
                <ul style="margin: 5px 0 0 20px;">
                    <li><strong>Approval:</strong> <code>{"approved": true}</code> → status: "approved"</li>
                    <li><strong>Rejection:</strong> <code>{"approved": false}</code> → status: "rejected"</li>
                    <li><strong>Disbursement:</strong> Only approved loans can be disbursed → status: "active"</li>
                </ul>
            </div>
        </section>

        <!-- Section 20: Version Snapshots & Comparison -->
        <section id="version-snapshots">
            <h2><span class="section-number">20</span> Version Snapshots &amp; Comparison</h2>
            <p>Capture point-in-time snapshots of salary structure versions and compare changes.</p>

            <h3>20.1 Get Version Snapshot</h3>
            <div class="code-block">
                <div class="code-header">GET /api/payroll/structures/versions/{versionId}/snapshot</div>
                <pre>{
  "version_id": "a1944fa2-4087-4302-8db8-69afb75308ca",
  "version_number": 2,
  "effective_from": "2026-12-15",
  "change_reason": "Arrears test - BASIC increase from 40% to 45%",
  "structure_name": "Bangalore Tech Structure",
  "snapshot_taken_at": "2025-12-17T04:29:01.937141Z",
  "components": [
    {
      "component_code": "BASIC",
      "component_name": "Basic Salary",
      "component_type": "earning",
      "calculation_type": "percentage",
      "calculation_base": "ctc",
      "percentage": 45.0000
    },
    {
      "component_code": "ESIC-EE",
      "component_type": "deduction",
      "percentage": 0.7500,
      "max_amount": 600.00
    }
  ]
}</pre>
            </div>

            <h3>20.2 Compare Versions</h3>
            <div class="code-block">
                <div class="code-header">GET /api/payroll/structures/versions/compare-snapshots?fromVersionId={v1}&amp;toVersionId={v2}</div>
                <pre>{
  "from_version": { "version_number": 1, "effective_from": "2000-01-01" },
  "to_version": { "version_number": 2, "effective_from": "2026-12-15" },
  "compared_at": "2025-12-17T04:29:19.338505Z",
  "components_added": 0,
  "components_removed": 0,
  "components_modified": 2,
  "components_unchanged": 3,
  "modified": [
    {
      "component_code": "BASIC",
      "changes": [
        {"field_name": "percentage", "old_value": "40.0000", "new_value": "45.0000"}
      ]
    },
    {
      "component_code": "ESIC-EE",
      "changes": [
        {"field_name": "max_amount", "old_value": "400.00", "new_value": "600.00"}
      ]
    }
  ]
}</pre>
            </div>

            <div class="info-box important">
                <span class="icon">&#8505;&#65039;</span>
                <div>
                    <strong>Audit Trail:</strong> Version comparison provides a complete audit trail of changes between salary structure versions, essential for compliance and arrears calculation.
                </div>
            </div>

            <h3>20.3 Bulk Version Assignment</h3>
            <p>Assign a salary structure version to multiple employees at once.</p>

            <div class="code-block">
                <div class="code-header">POST /api/payroll/structures/{structureId}/versions/{versionNumber}/bulk-assign</div>
                <pre>Request:
{
  "employee_ids": ["6e45111b-d883-4e85-87c5-22d9da3625a0"],
  "effective_from": "2027-01-01"
}

Response (Preview Mode):
{
  "is_preview": true,
  "total_employees_matched": 1,
  "employees_already_on_version": 1,
  "employees_to_update": 0,
  "employees_updated": 0,
  "total_arrears_amount": 0,
  "employee_details": [{
    "employee_id": "6e45111b-d883-4e85-87c5-22d9da3625a0",
    "employee_code": "EMP001",
    "current_structure_name": "Bangalore Tech Structure",
    "current_ctc": 1500000.00,
    "status": "skipped",
    "error_message": "Already on this salary structure"
  }]
}</pre>
            </div>

            <h3>20.4 Structure Migration</h3>
            <p>Migrate all employees from one salary structure to another.</p>

            <div class="code-block">
                <div class="code-header">POST /api/payroll/structures/migrate-all</div>
                <pre>Request:
{
  "from_structure_id": "e42e14d1-a46a-4f64-82bf-11a57cf3b11c",
  "to_structure_id": "new-structure-uuid",
  "effective_from": "2027-02-01"
}

Response:
{
  "message": "All structures migrated to versioning system"
}</pre>
            </div>

            <div class="info-box tip">
                <span class="icon">&#128161;</span>
                <div>
                    <strong>Preview Mode:</strong> Bulk assignment runs in preview mode by default, showing which employees would be affected before making changes.
                </div>
            </div>
        </section>

        <!-- Section 21: Payroll Reports -->
        <section id="payroll-reports">
            <h2><span class="section-number">21</span> Payroll Reports</h2>
            <p>Comprehensive reporting for payroll analysis and management visibility.</p>

            <h3>21.1 Payroll Summary</h3>
            <div class="code-block">
                <div class="code-header">GET /api/reports/payroll?year=2026</div>
                <pre>{
  "year": 2026,
  "report_date": "2025-12-17T04:29:56.501049Z",
  "total_employees": 1,
  "total_gross": 92812.50,
  "total_net_salary": 92116.41,
  "total_deductions": 696.09,
  "employees_paid": 1,
  "average_salary": 92812.50,
  "by_department": [{
    "department_name": "Engineering",
    "employee_count": 1,
    "total_gross": 181141.31,
    "percentage_of_total": 195.17
  }],
  "monthly_trend": [
    {"month": 11, "month_name": "November", "total_gross": 92812.50, "employees_paid": 1},
    {"month": 12, "month_name": "December", "total_gross": 0, "employees_paid": 0}
  ]
}</pre>
            </div>

            <h3>21.2 Available Reports</h3>
            <table class="simple-table">
                <thead>
                    <tr>
                        <th>Endpoint</th>
                        <th>Report Type</th>
                        <th>Parameters</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>/reports/payroll</code></td>
                        <td>Payroll Summary</td>
                        <td>year, month, officeId</td>
                    </tr>
                    <tr>
                        <td><code>/reports/payroll/trend/{year}</code></td>
                        <td>Monthly Trend</td>
                        <td>year</td>
                    </tr>
                    <tr>
                        <td><code>/reports/salary-summary</code></td>
                        <td>Salary by Department</td>
                        <td>officeId</td>
                    </tr>
                    <tr>
                        <td><code>/reports/deductions</code></td>
                        <td>Deductions Report</td>
                        <td>year, month</td>
                    </tr>
                    <tr>
                        <td><code>/reports/loans</code></td>
                        <td>Loans Report</td>
                        <td>status</td>
                    </tr>
                    <tr>
                        <td><code>/reports/tax</code></td>
                        <td>Tax Report</td>
                        <td>year, month</td>
                    </tr>
                    <tr>
                        <td><code>/reports/bank-advice</code></td>
                        <td>Bank Advice</td>
                        <td>runId</td>
                    </tr>
                    <tr>
                        <td><code>/reports/cost-center</code></td>
                        <td>Cost Center Analysis</td>
                        <td>year</td>
                    </tr>
                    <tr>
                        <td><code>/reports/executive-summary</code></td>
                        <td>Executive Summary</td>
                        <td>year</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Section 22: Self-Service Portal -->
        <section id="self-service">
            <h2><span class="section-number">22</span> Self-Service Portal</h2>
            <p>Employee-facing endpoints for viewing their own payroll information.</p>

            <h3>22.1 Self-Service Endpoints</h3>
            <table class="simple-table">
                <thead>
                    <tr>
                        <th>Endpoint</th>
                        <th>Description</th>
                        <th>Access</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>GET /payroll/my-salary</code></td>
                        <td>Current salary details</td>
                        <td>Own data only</td>
                    </tr>
                    <tr>
                        <td><code>GET /payroll/my-salary/breakdown</code></td>
                        <td>Component-wise breakdown</td>
                        <td>Own data only</td>
                    </tr>
                    <tr>
                        <td><code>GET /payroll/my-salary/history</code></td>
                        <td>Salary history</td>
                        <td>Own data only</td>
                    </tr>
                    <tr>
                        <td><code>GET /payroll/my-salary/revisions</code></td>
                        <td>Revision history</td>
                        <td>Own data only</td>
                    </tr>
                    <tr>
                        <td><code>GET /payroll-processing/my-payslips</code></td>
                        <td>All payslips</td>
                        <td>Own data only</td>
                    </tr>
                    <tr>
                        <td><code>GET /payroll-processing/my-payslips/{month}/{year}</code></td>
                        <td>Specific payslip</td>
                        <td>Own data only</td>
                    </tr>
                    <tr>
                        <td><code>GET /payroll-processing/my-loans</code></td>
                        <td>Active loans</td>
                        <td>Own data only</td>
                    </tr>
                </tbody>
            </table>

            <div class="info-box warning">
                <span class="icon">&#9888;&#65039;</span>
                <div>
                    <strong>Authentication Required:</strong> Self-service endpoints require the logged-in user to be linked to an employee record via <code>user_id</code>.
                </div>
            </div>
        </section>

        <!-- Section 23: Payroll Workflow -->
        <section id="payroll-workflow">
            <h2><span class="section-number">23</span> Payroll Workflow</h2>
            <p>Complete payroll processing workflow from creation to payment.</p>

            <h3>23.1 Workflow States</h3>
            <div class="formula-box">
                <strong>Payroll Run Status Flow:</strong>
                <p style="margin-top: 10px; font-family: monospace;">
                    pending → processed → approved → paid<br>
                    pending → cancelled (if deleted)
                </p>
            </div>

            <h3>23.2 Payslip Finalization</h3>
            <div class="code-block">
                <div class="code-header">POST /api/payroll-processing/payslips/{id}/finalize</div>
                <pre>Response:
{
  "id": "fce5970e-58b2-4f61-bd6c-6eca8f84c399",
  "payslip_number": "PS-EMP001-202612",
  "status": "finalized",
  "gross_earnings": 88328.81,
  "total_deductions": 513.04,
  "net_pay": 87815.77
}</pre>
            </div>

            <h3>23.3 Approve Payroll Run</h3>
            <div class="code-block">
                <div class="code-header">POST /api/payroll-processing/runs/{id}/approve</div>
                <pre>Response:
{
  "id": "aca15cf5-44ef-43d3-80ed-fc4601b499c2",
  "status": "approved",
  "approved_by": "admin_user_id",
  "approved_at": "2025-12-17T04:30:35.579742Z",
  "approver_type": "superadmin"
}</pre>
            </div>

            <h3>23.4 Mark as Paid</h3>
            <div class="code-block">
                <div class="code-header">POST /api/payroll-processing/runs/{id}/mark-paid</div>
                <pre>Request:
{
  "payment_batch_ref": "BATCH-2026-12-001"
}

Response:
{
  "id": "aca15cf5-44ef-43d3-80ed-fc4601b499c2",
  "status": "paid",
  "paid_on": "2025-12-17",
  "payment_batch_ref": "BATCH-2026-12-001"
}</pre>
            </div>

            <div class="info-box important">
                <span class="icon">&#8505;&#65039;</span>
                <div>
                    <strong>Prerequisite:</strong> A payroll run must be in <code>approved</code> status before it can be marked as <code>paid</code>.
                </div>
            </div>
        </section>

        <!-- Section 24: YTD Tracking -->
        <section id="ytd-tracking">
            <h2><span class="section-number">24</span> YTD (Year-to-Date) Tracking</h2>
            <p>Automatic tracking of cumulative amounts for each payroll component throughout the financial year.</p>

            <h3>24.1 YTD in Payslip Items</h3>
            <div class="code-block">
                <div class="code-header">GET /api/payroll-processing/payslips/{id} - Items with YTD</div>
                <pre>{
  "items": [
    {
      "component_code": "BASIC",
      "component_name": "Basic Salary",
      "amount": 53532.61,
      "ytd_amount": 109782.61,
      "is_prorated": true
    },
    {
      "component_code": "DA",
      "component_name": "Dearness Allowance",
      "amount": 2676.63,
      "ytd_amount": 5489.13
    },
    {
      "component_code": "ESIC-EE",
      "component_name": "Employee ESIC",
      "component_type": "deduction",
      "amount": 513.04,
      "ytd_amount": 1209.13
    }
  ]
}</pre>
            </div>

            <h3>24.2 YTD Calculation</h3>
            <div class="formula-box">
                <strong>YTD Formula:</strong>
                <p style="margin-top: 10px;">
                    YTD Amount = Sum of all previous months in FY + Current month amount<br><br>
                    For component BASIC in December 2026:<br>
                    YTD = (Jan + Feb + ... + Nov amounts) + December amount
                </p>
            </div>

            <div class="info-box tip">
                <span class="icon">&#128161;</span>
                <div>
                    <strong>Use Case:</strong> YTD tracking is essential for tax calculations, Form 16 generation, and compliance reporting.
                </div>
            </div>
        </section>

        <!-- Section 25: Bank File Export -->
        <section id="bank-export">
            <h2><span class="section-number">25</span> Bank File &amp; CSV Export</h2>
            <p>Export payroll data for bank transfers and external analysis.</p>

            <h3>25.1 Bank Transfer File</h3>
            <div class="code-block">
                <div class="code-header">GET /api/payroll-processing/runs/{id}/bank-file</div>
                <pre>{
  "file_name": "BankTransfer_PR-202612-041416_20251217.csv",
  "file_format": "csv",
  "record_count": 1,
  "total_amount": 87815.77,
  "records": [
    {
      "employee_code": "EMP001",
      "employee_name": "Yohesh Kumar",
      "bank_name": "HDFC Bank",
      "account_number": "1234567890",
      "ifsc_code": "HDFC0001234",
      "amount": 87815.77
    }
  ]
}</pre>
            </div>

            <h3>25.2 CSV Export</h3>
            <div class="code-block">
                <div class="code-header">GET /api/payroll-processing/runs/{id}/export-csv</div>
                <pre>Employee Code,Employee Name,Department,Designation,Bank Name,Account Number,
IFSC Code,Basic,HRA,Special Allowance,Gross Earnings,PF Deduction,ESI Deduction,
Professional Tax,Other Deductions,Total Deductions,Net Pay,Working Days,Days Worked,LOP Days
"EMP001","Yohesh Kumar","Engineering","Software Engineer","","","",
53532.61,21413.04,10706.53,88328.81,0,513.04,0,0,513.04,87815.77,23,23.00,0.00</pre>
            </div>

            <h3>25.3 Export Endpoints</h3>
            <table class="simple-table">
                <thead>
                    <tr>
                        <th>Endpoint</th>
                        <th>Format</th>
                        <th>Use Case</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>/runs/{id}/bank-file</code></td>
                        <td>JSON/CSV</td>
                        <td>Bank salary disbursement</td>
                    </tr>
                    <tr>
                        <td><code>/runs/{id}/export-csv</code></td>
                        <td>CSV</td>
                        <td>Excel analysis, external systems</td>
                    </tr>
                    <tr>
                        <td><code>/reports/export</code></td>
                        <td>PDF/Excel</td>
                        <td>Management reports</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Section 26: Reimbursement/Adjustment Workflow -->
        <section id="adjustment-workflow">
            <h2><span class="section-number">26</span> Reimbursement &amp; Adjustment Workflow</h2>
            <p>Manage one-time payroll adjustments including reimbursements, bonuses, deductions, and recoveries.</p>

            <h3>26.1 Adjustment Types</h3>
            <table class="simple-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Effect</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>reimbursement</code></td>
                        <td>Earning (+)</td>
                        <td>Expense reimbursement (travel, medical, etc.)</td>
                    </tr>
                    <tr>
                        <td><code>bonus</code></td>
                        <td>Earning (+)</td>
                        <td>Performance/festival bonus</td>
                    </tr>
                    <tr>
                        <td><code>incentive</code></td>
                        <td>Earning (+)</td>
                        <td>Sales/achievement incentive</td>
                    </tr>
                    <tr>
                        <td><code>arrears</code></td>
                        <td>Earning (+)</td>
                        <td>Back pay for previous months</td>
                    </tr>
                    <tr>
                        <td><code>deduction</code></td>
                        <td>Deduction (-)</td>
                        <td>One-time deduction</td>
                    </tr>
                    <tr>
                        <td><code>recovery</code></td>
                        <td>Deduction (-)</td>
                        <td>Loan/advance recovery</td>
                    </tr>
                </tbody>
            </table>

            <h3>26.2 Create Reimbursement (VERIFIED 2025-12-17)</h3>
            <div class="code-block">
                <div class="code-header">POST /api/payroll-processing/adjustments</div>
                <pre>// Request
{
  "employee_id": "6e45111b-d883-4e85-87c5-22d9da3625a0",
  "adjustment_type": "reimbursement",
  "amount": 5000,
  "effective_month": 1,
  "effective_year": 2027,
  "reason": "Travel expense reimbursement - December 2026 trip"
}

// Response - Status: PENDING ✓
{
  "id": "9df856fe-e290-4a7d-a9db-09a0bc8983bc",
  "adjustment_type": "reimbursement",
  "amount": 5000,
  "status": "pending",
  "employee_code": "EMP001"
}</pre>
            </div>

            <h3>26.3 Approve Reimbursement (VERIFIED 2025-12-17)</h3>
            <div class="code-block">
                <div class="code-header">POST /api/payroll-processing/adjustments/{id}/approve</div>
                <pre>// Request
{"approved": true}

// Response - Status: APPROVED ✓
{
  "id": "9df856fe-e290-4a7d-a9db-09a0bc8983bc",
  "adjustment_type": "reimbursement",
  "amount": 5000.0,
  "status": "approved",
  "approved_at": "2025-12-17T05:04:25.027472Z",
  "approver_type": "superadmin"
}</pre>
            </div>

            <h3>26.4 Reject Adjustment (VERIFIED 2025-12-17)</h3>
            <div class="code-block">
                <div class="code-header">POST /api/payroll-processing/adjustments/{id}/approve</div>
                <pre>// Request
{"approved": false, "rejection_reason": "Amount exceeds policy limit"}

// Response - Status: REJECTED ✓
{
  "id": "7868fdb9-4b9f-4eab-83d6-f741e5c66fbb",
  "adjustment_type": "recovery",
  "status": "rejected",
  "rejection_reason": "Amount exceeds policy limit"
}</pre>
            </div>

            <h3>26.5 Adjustment Status Flow</h3>
            <div class="formula-box">
                <strong>Adjustment Lifecycle:</strong>
                <p style="margin-top: 10px; font-family: monospace;">
                    pending → approved → (included in payroll)<br>
                    pending → rejected (if not approved)
                </p>
            </div>

            <div class="info-box" style="margin-top: 15px;">
                <strong>✅ Adjustment Workflow Verification Complete:</strong>
                <ul style="margin: 5px 0 0 20px;">
                    <li><strong>Create:</strong> HR creates adjustment → status: "pending"</li>
                    <li><strong>Approve:</strong> <code>{"approved": true}</code> → status: "approved"</li>
                    <li><strong>Reject:</strong> <code>{"approved": false}</code> → status: "rejected"</li>
                    <li><strong>Payroll:</strong> Approved adjustments auto-included in next payroll run</li>
                </ul>
            </div>

            <div class="warning-box" style="margin-top: 15px;">
                <strong>⚠️ Authorization Note:</strong>
                <p>Currently adjustments can only be <strong>created by HR roles</strong> (HRMS_HR_USER, HRMS_HR_ADMIN, HRMS_HR_MANAGER). Regular employees (HRMS_USER) cannot create reimbursement requests themselves - HR must create them on behalf of employees.</p>
            </div>
        </section>
    </main>

    <a href="#" class="back-to-top" title="Back to Top">&#8593;</a>

    <footer>
        <p>HyperDroid HRMS Knowledge Base | Last Updated: December 2025</p>
        <p>Need help? Contact <a href="mailto:support@hyperdroid.io">support@hyperdroid.io</a></p>
    </footer>

    <script>
        // Theme handling
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const html = document.documentElement;

        function getPreferredTheme() {
            const saved = localStorage.getItem('kb-theme');
            if (saved) return saved;
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function applyTheme(theme) {
            if (theme === 'dark') {
                html.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '\u2600\uFE0F';
            } else {
                html.setAttribute('data-theme', 'light');
                themeIcon.textContent = '\uD83C\uDF19';
            }
        }

        applyTheme(getPreferredTheme());

        themeToggle.addEventListener('click', () => {
            const current = html.getAttribute('data-theme') || 'light';
            const newTheme = current === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem('kb-theme', newTheme);
        });

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (!localStorage.getItem('kb-theme')) {
                applyTheme(e.matches ? 'dark' : 'light');
            }
        });

        // Smooth scroll for navigation links
        document.querySelectorAll('nav a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // Show/hide back-to-top button
        const backToTop = document.querySelector('.back-to-top');
        window.addEventListener('scroll', () => {
            if (window.scrollY > 500) {
                backToTop.style.display = 'flex';
            } else {
                backToTop.style.display = 'none';
            }
        });
        backToTop.style.display = 'none';
    </script>
</body>
</html>
