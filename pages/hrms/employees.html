<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Cookie Consent & Analytics -->
    <script src="/js/cookie-consent.js" defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    <title>Employee Management - HRMS | Ragenaizer</title>
    <script>window.CACHE_VERSION = Date.now();</script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script>document.write('<link rel="stylesheet" href="../../css/theme.css?v=' + CACHE_VERSION + '">');</script>
    <script>document.write('<link rel="stylesheet" href="../../css/styles.css?v=' + CACHE_VERSION + '">');</script>
    <script>document.write('<link rel="stylesheet" href="../../css/hrms.css?v=' + CACHE_VERSION + '">');</script>
    <script>document.write('<link rel="stylesheet" href="../../css/hrms-payroll.css?v=' + CACHE_VERSION + '">');</script>
    <script>document.write('<link rel="stylesheet" href="../../css/searchable-dropdown.css?v=' + CACHE_VERSION + '">');</script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script>document.write('<link rel="stylesheet" href="../../css/flatpickr-custom.css?v=' + CACHE_VERSION + '">');</script>
    <script>document.write('<script src="../../js/theme.js?v=' + CACHE_VERSION + '"><\/script>');</script>
</head>
<body class="dashboard">
    <nav class="navbar">
        <div class="navbar-brand">
            <a href="../home.html">
                <img src="../../assets/brand_logo.png" alt="Ragenaizer Logo" class="navbar-logo">
            </a>
        </div>
        <div class="navbar-menu">
            <!-- Navigation links rendered by Navigation.init() -->
        </div>
    </nav>

    <div class="hrms-container">
        <div class="hrms-header">
            <div class="header-content">
                <nav class="breadcrumb-nav">
                    <a href="dashboard.html">HRMS</a>
                    <span class="separator">/</span>
                    <span class="current">Employees</span>
                </nav>
                <div class="hrms-header-row">
                    <!-- Hamburger Toggle Button -->
                    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle navigation menu">
                        <span class="hamburger-icon">
                            <span class="hamburger-line"></span>
                            <span class="hamburger-line"></span>
                            <span class="hamburger-line"></span>
                        </span>
                        <svg class="arrow-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 12H5"></path>
                            <path d="M12 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h1>Employee Management</h1>
                </div>
                <div class="active-tab-title" id="activeTabTitle">
                    <span class="tab-indicator"></span>
                    <span id="activeTabName">Employee Directory</span>
                </div>
            </div>
        </div>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar + Content Layout -->
        <div class="organization-layout">
            <!-- Collapsible Sidebar Navigation -->
            <aside class="organization-sidebar gradient-bg-ambient" id="organizationSidebar">
                <div class="sidebar-header">
                    <h3>Employees</h3>
                </div>
                <nav class="sidebar-nav">
                    <!-- Workforce Section -->
                    <div class="nav-group" data-group="workforce">
                        <div class="nav-group-header">
                            <span class="nav-group-title">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                Workforce
                            </span>
                            <span class="chevron">‚ñº</span>
                        </div>
                        <div class="nav-group-items">
                            <button class="sidebar-btn active" data-tab="directory" id="directoryTab">
                                <span class="nav-number">1</span><span class="nav-label">Employee Directory</span>
                            </button>
                        </div>
                    </div>
                    <!-- Access Control Section -->
                    <div class="nav-group" data-group="access">
                        <div class="nav-group-header">
                            <span class="nav-group-title">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="5" width="20" height="14" rx="2"/>
                                    <line x1="2" y1="10" x2="22" y2="10"/>
                                </svg>
                                Access Control
                            </span>
                            <span class="chevron">‚ñº</span>
                        </div>
                        <div class="nav-group-items">
                            <button class="sidebar-btn" data-tab="nfcCards" id="nfcCardsTab">
                                <span class="nav-number">2</span><span class="nav-label">NFC Cards</span>
                            </button>
                        </div>
                    </div>
                </nav>
            </aside>

            <!-- Main Content Area -->
            <main class="organization-content">
                <!-- Employee Directory Tab -->
                <div class="tab-content active" id="directory">
                    <!-- Filters -->
                    <div class="filters-bar">
                        <div class="search-box-modern">
                            <svg class="search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="m21 21-4.35-4.35"/>
                            </svg>
                            <input type="text" id="searchInput" placeholder="Search employees..." oninput="filterEmployees()">
                        </div>
                        <select class="filter-select" id="officeFilter">
                            <!-- Populated dynamically by loadFormData() -->
                        </select>
                        <select class="filter-select" id="departmentFilter">
                            <!-- Populated dynamically by loadFormData() -->
                        </select>
                        <select class="filter-select" id="statusFilter">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="on_notice">On Notice</option>
                            <option value="terminated">Terminated</option>
                        </select>
                        <a href="bulk-import.html" class="btn btn-outline-primary" id="bulkImportBtn" style="display: none;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Bulk Import
                        </a>
                        <button class="btn btn-primary" onclick="openCreateEmployeeModal()" id="createEmployeeBtn" style="display: none;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Add Employee
                        </button>
                    </div>

                    <!-- Employee Stats -->
                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-value" id="totalCount">-</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-value" id="activeCount">-</div>
                            <div class="stat-label">Active</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-value" id="probationCount">-</div>
                            <div class="stat-label">On Probation</div>
                        </div>
                        <div class="stat-card danger">
                            <div class="stat-value" id="exitCount">-</div>
                            <div class="stat-label">Exits This Month</div>
                        </div>
                    </div>

                    <!-- Employees Table -->
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Department</th>
                                    <th>Designation</th>
                                    <th>Office</th>
                                    <th>Manager</th>
                                    <th>Joining Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="employeesTableBody">
                                <tr>
                                    <td colspan="8">
                                        <div class="loading-spinner">
                                            <div class="spinner"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="employeesPagination" class="pagination-container"></div>
                    </div>
                </div>

                <!-- NFC Cards Tab -->
                <div class="tab-content" id="nfcCards">
                    <!-- Filters -->
                    <div class="filters-bar">
                        <div class="search-box-modern">
                            <svg class="search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="m21 21-4.35-4.35"/>
                            </svg>
                            <input type="text" id="nfcSearchInput" placeholder="Search by name, code, or card UID..." oninput="filterNfcCards()">
                        </div>
                        <div id="nfcStatusFilterContainer" class="filter-dropdown-container"></div>
                        <div id="nfcOfficeFilterContainer" class="filter-dropdown-container"></div>
                        <button class="btn btn-primary" onclick="openIssueNfcCardModal()" id="issueNfcCardBtn" style="display: none;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Issue Card
                        </button>
                    </div>

                    <!-- NFC Cards Table -->
                    <div class="table-container">
                        <table class="data-table" id="nfcCardsTable">
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Card UID</th>
                                    <th>Label</th>
                                    <th>Status</th>
                                    <th>Primary</th>
                                    <th>Issued Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="nfcCardsTableBody">
                                <tr class="empty-row">
                                    <td colspan="7">
                                        <div class="empty-state">
                                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                <rect x="2" y="5" width="20" height="14" rx="2"/>
                                                <line x1="2" y1="10" x2="22" y2="10"/>
                                            </svg>
                                            <p>No NFC cards found</p>
                                            <small>Issue NFC cards to employees for attendance kiosks</small>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="nfcCardsPagination" class="pagination-container"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Issue NFC Card Modal -->
    <div class="modal" id="issueNfcCardModal">
        <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="nfcCardModalTitle">Issue NFC Card</h3>
                    <button class="close-btn" onclick="closeModal('issueNfcCardModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="issueNfcCardForm">
                        <input type="hidden" id="nfcCardId">

                        <!-- Employee Selection -->
                        <div class="form-group">
                            <label>Employee <span class="required">*</span></label>
                            <input type="hidden" id="nfcEmployeeSelect" required>
                            <div class="user-search-dropdown" id="nfcEmployeeDropdown">
                                <div class="user-search-selected" id="nfcEmployeeSelected" onclick="toggleNfcEmployeeDropdown()">
                                    <span class="selected-user-text">Select employee...</span>
                                    <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </div>
                                <div class="user-search-panel" id="nfcEmployeePanel">
                                    <div class="search-box-modern">
                                        <svg class="search-icon" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="11" cy="11" r="8"/>
                                            <path d="m21 21-4.35-4.35"/>
                                        </svg>
                                        <input type="text" id="nfcEmployeeSearchInput" placeholder="Search by name or employee code..." oninput="filterNfcEmployeeList()">
                                        <button type="button" class="clear-search-btn" id="clearNfcEmployeeSearchBtn" style="display: none;" onclick="clearNfcEmployeeSearch()">
                                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="18" y1="6" x2="6" y2="18"/>
                                                <line x1="6" y1="6" x2="18" y2="18"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="user-list-header">
                                        <span id="nfcEmployeeCountDisplay">0 employees</span>
                                    </div>
                                    <div id="nfcEmployeeList" class="users-list-modern">
                                        <p class="text-muted" style="text-align: center; font-size: 0.75rem; padding: 20px;">Loading employees...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Selected Employee Card -->
                        <div class="nfc-employee-card" id="nfcSelectedEmployeeCard" style="display: none;">
                            <div class="employee-avatar" id="nfcEmployeeAvatar">-</div>
                            <div class="employee-card-content">
                                <div class="employee-card-header">
                                    <span class="employee-name" id="nfcEmployeeName">-</span>
                                    <span class="employee-code" id="nfcEmployeeCode">-</span>
                                </div>
                                <div class="assignment-row">
                                    <span class="assign-item"><span class="assign-icon">üè¢</span><span id="nfcEmployeeDept">-</span></span>
                                    <span class="assign-item"><span class="assign-icon">üíº</span><span id="nfcEmployeeDesig">-</span></span>
                                </div>
                                <div class="existing-cards-info" id="nfcExistingCardsInfo">
                                    <!-- Populated dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Card Details -->
                        <div class="form-row two-col">
                            <div class="form-group">
                                <label>Card UID <span class="required">*</span></label>
                                <input type="text" id="nfcNewCardUid" class="form-control"
                                       placeholder="e.g., 04ABCDEF123456"
                                       style="text-transform: uppercase; font-family: monospace;"
                                       pattern="[A-Fa-f0-9]+" title="Hex characters only (0-9, A-F)" required>
                                <small class="form-text">NFC card's unique identifier (hex format)</small>
                            </div>
                            <div class="form-group">
                                <label>Card Label</label>
                                <input type="text" id="nfcNewCardLabel" class="form-control"
                                       placeholder="e.g., Office Badge, Building Access">
                                <small class="form-text">Optional friendly name</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="nfcNewCardPrimary" checked>
                                <span>Set as primary card</span>
                            </label>
                            <small class="form-text">Primary card is used for quick lookups at attendance kiosks</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeModal('issueNfcCardModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="submitIssueNfcCard()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="5" width="20" height="14" rx="2"/>
                            <line x1="2" y1="10" x2="22" y2="10"/>
                        </svg>
                        Issue Card
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Employee Cards Modal -->
    <div class="modal" id="viewEmployeeCardsModal">
        <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Employee NFC Cards</h3>
                    <button class="close-btn" onclick="closeModal('viewEmployeeCardsModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Employee Info Header -->
                    <div class="nfc-employee-card" id="viewCardsEmployeeCard">
                        <div class="employee-avatar" id="viewCardsEmployeeAvatar">-</div>
                        <div class="employee-card-content">
                            <div class="employee-card-header">
                                <span class="employee-name" id="viewCardsEmployeeName">-</span>
                                <span class="employee-code" id="viewCardsEmployeeCode">-</span>
                            </div>
                            <div class="assignment-row">
                                <span class="assign-item"><span class="assign-icon">üè¢</span><span id="viewCardsEmployeeDept">-</span></span>
                                <span class="assign-item"><span class="assign-icon">üíº</span><span id="viewCardsEmployeeDesig">-</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Cards List -->
                    <div class="nfc-cards-list-modal" id="viewCardsCardsList">
                        <!-- Populated dynamically -->
                    </div>

                    <!-- Issue New Card Section -->
                    <div class="nfc-issue-inline" id="viewCardsIssueSection">
                        <h4>Issue New Card</h4>
                        <div class="form-row two-col">
                            <div class="form-group">
                                <input type="text" id="viewCardsNewUid" class="form-control"
                                       placeholder="Card UID (hex)"
                                       style="text-transform: uppercase; font-family: monospace;">
                            </div>
                            <div class="form-group">
                                <input type="text" id="viewCardsNewLabel" class="form-control"
                                       placeholder="Label (optional)">
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="checkbox-label">
                                <input type="checkbox" id="viewCardsNewPrimary">
                                <span>Set as primary</span>
                            </label>
                            <button class="btn btn-primary btn-sm" onclick="issueCardFromViewModal()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                Issue
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeModal('viewEmployeeCardsModal')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Deactivate Card Modal -->
    <div class="modal" id="deactivateCardModal">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Deactivate Card</h3>
                    <button class="close-btn" onclick="closeModal('deactivateCardModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="deactivateCardId">
                    <p>Are you sure you want to deactivate this NFC card?</p>
                    <div class="form-group">
                        <label>Reason for deactivation</label>
                        <textarea id="deactivateCardReason" class="form-control" rows="2"
                                  placeholder="e.g., Card lost, Employee transfer, Card damaged"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeModal('deactivateCardModal')">Cancel</button>
                    <button class="btn btn-danger" onclick="confirmDeactivateCard()">Deactivate</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Employee Modal -->
    <div class="modal" id="employeeModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content employee-wizard-modal">
                <div class="modal-header">
                    <h3 id="employeeModalTitle">Add Employee</h3>
                    <button class="close-btn" onclick="closeModal('employeeModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>

                <!-- Wizard Steps Navigation -->
                <div class="wizard-steps">
                    <div class="wizard-step active" data-step="1" onclick="goToEmployeeStep(1)">
                        <div class="step-number">1</div>
                        <div class="step-label">Personal</div>
                    </div>
                    <div class="wizard-step-connector"></div>
                    <div class="wizard-step" data-step="2" onclick="goToEmployeeStep(2)">
                        <div class="step-number">2</div>
                        <div class="step-label">Employment</div>
                    </div>
                    <div class="wizard-step-connector"></div>
                    <div class="wizard-step" data-step="3" onclick="goToEmployeeStep(3)">
                        <div class="step-number">3</div>
                        <div class="step-label">Banking</div>
                    </div>
                    <div class="wizard-step-connector"></div>
                    <div class="wizard-step" data-step="4" onclick="goToEmployeeStep(4)">
                        <div class="step-number">4</div>
                        <div class="step-label">Documents</div>
                    </div>
                </div>

                <div class="modal-body">
                    <form id="employeeForm">
                        <input type="hidden" id="employeeId">

                        <!-- Step 1: Personal Information -->
                        <div class="wizard-panel active" id="employeeStep1">
                            <!-- User Selection (for new employees) -->
                            <div class="form-section" id="userSelectionSection">
                                <div class="form-group">
                                    <label>User Account <span class="required">*</span></label>
                                    <input type="hidden" id="userSelect" required>
                                    <div class="user-search-dropdown" id="userSearchDropdown">
                                        <div class="user-search-selected" id="userSearchSelected" onclick="toggleUserDropdown()">
                                            <span class="selected-user-text">Select a user...</span>
                                            <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                        <div class="user-search-panel" id="userSearchPanel">
                                            <div class="search-box-modern">
                                                <svg class="search-icon" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="11" cy="11" r="8"/>
                                                    <path d="m21 21-4.35-4.35"/>
                                                </svg>
                                                <input type="text" id="userSearchInput" placeholder="Search by name or email..." oninput="filterUserList()">
                                                <button type="button" class="clear-search-btn" id="clearUserSearchBtn" style="display: none;" onclick="clearUserSearch()">
                                                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <line x1="18" y1="6" x2="6" y2="18"/>
                                                        <line x1="6" y1="6" x2="18" y2="18"/>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="user-list-header">
                                                <span id="userCountDisplay">0 users</span>
                                            </div>
                                            <div id="userSearchList" class="users-list-modern">
                                                <p class="text-muted" style="text-align: center; font-size: 0.75rem; padding: 20px;">Loading users...</p>
                                            </div>
                                        </div>
                                    </div>
                                    <small class="form-text">Only users without employee profiles are shown</small>
                                </div>
                            </div>

                            <!-- User Info Display (read-only from Auth service) -->
                            <div class="user-info-display" id="userInfoDisplay" style="display: none;">
                                <input type="hidden" id="firstName">
                                <input type="hidden" id="lastName">
                                <input type="hidden" id="workEmail">
                                <div class="user-info-avatar">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                        <circle cx="12" cy="7" r="4"/>
                                    </svg>
                                </div>
                                <div class="form-group">
                                    <label>Name</label>
                                    <div class="readonly-field" id="userNameDisplay">-</div>
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <div class="readonly-field" id="userEmailDisplay">-</div>
                                </div>
                                <div class="user-info-badge">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                                    </svg>
                                    Selected
                                </div>
                            </div>

                            <!-- Photo and Basic Info in two columns -->
                            <div class="wizard-two-col photo-info-row-large">
                                <div class="wizard-col photo-col-large">
                                    <div class="form-group photo-upload-passport-large">
                                        <label>Photo <span class="required">*</span></label>
                                        <div class="photo-dropzone-passport-large" id="photoDropzone" onclick="triggerFileUpload('photo')">
                                            <input type="file" id="photo-file" accept=".jpg,.jpeg,.png" hidden onchange="handlePhotoSelect(this)">

                                            <!-- Empty State -->
                                            <div class="photo-empty-state" id="photoPlaceholder">
                                                <div class="photo-icon-medium">
                                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                                        <circle cx="12" cy="7" r="4"/>
                                                    </svg>
                                                </div>
                                                <span class="photo-text-medium">Upload Photo</span>
                                                <span class="photo-hint-small">JPG, PNG up to 5MB</span>
                                            </div>

                                            <!-- Image Preview -->
                                            <div class="photo-preview-wrapper" id="photoPreview" style="display: none;">
                                                <img id="photoImage" src="" alt="Employee Photo">
                                                <button type="button" class="photo-remove-btn" onclick="event.stopPropagation(); removePhoto();" title="Remove photo">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                                        <line x1="18" y1="6" x2="6" y2="18"/>
                                                        <line x1="6" y1="6" x2="18" y2="18"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                        <input type="hidden" id="photo-doc-id">
                                    </div>
                                </div>
                                <div class="wizard-col info-col-large">
                                    <!-- Row 1: Employee Code + Work Phone -->
                                    <div class="form-row two-col equal-width">
                                        <div class="form-group">
                                            <label>Employee Code <span class="required">*</span></label>
                                            <input type="text" id="employeeCode" required placeholder="EMP001">
                                        </div>
                                        <div class="form-group">
                                            <label>Work Phone <span class="required">*</span></label>
                                            <input type="tel" id="workPhone" placeholder="+91-9876543210" required>
                                        </div>
                                    </div>
                                    <!-- Row 2: DOB + Gender -->
                                    <div class="form-row two-col equal-width">
                                        <div class="form-group">
                                            <label>Date of Birth <span class="required">*</span></label>
                                            <input type="date" id="dateOfBirth" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Gender</label>
                                            <select id="gender" class="form-control">
                                                <option value="">Select...</option>
                                                <option value="male">Male</option>
                                                <option value="female">Female</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                    </div>
                                    <!-- Row 3: Blood Group + Marital Status -->
                                    <div class="form-row two-col equal-width">
                                        <div class="form-group">
                                            <label>Blood Group</label>
                                            <select id="bloodGroup" class="form-control">
                                                <option value="">Select...</option>
                                                <option value="A+">A+</option>
                                                <option value="A-">A-</option>
                                                <option value="B+">B+</option>
                                                <option value="B-">B-</option>
                                                <option value="AB+">AB+</option>
                                                <option value="AB-">AB-</option>
                                                <option value="O+">O+</option>
                                                <option value="O-">O-</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Marital Status</label>
                                            <select id="maritalStatus" class="form-control">
                                                <option value="">Select...</option>
                                                <option value="single">Single</option>
                                                <option value="married">Married</option>
                                                <option value="divorced">Divorced</option>
                                                <option value="widowed">Widowed</option>
                                            </select>
                                        </div>
                                    </div>
                                    <!-- Row 4: Emergency Contact Name + Phone -->
                                    <div class="form-row two-col equal-width">
                                        <div class="form-group">
                                            <label>Emergency Contact Name</label>
                                            <input type="text" id="emergencyContactName" class="form-control" placeholder="e.g., Jane Doe">
                                        </div>
                                        <div class="form-group">
                                            <label>Emergency Contact Phone</label>
                                            <input type="tel" id="emergencyContactPhone" class="form-control" placeholder="+91-9876543210">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Employment Details -->
                        <div class="wizard-panel" id="employeeStep2">
                            <div class="form-row two-col">
                                <!-- Office Searchable Dropdown -->
                                <div class="form-group">
                                    <label>Office <span class="required">*</span></label>
                                    <input type="hidden" id="officeId" required>
                                    <div class="searchable-dropdown" id="officeDropdown" data-field="office">
                                        <div class="searchable-dropdown-trigger" onclick="toggleSearchableDropdown('office')">
                                            <span class="selected-text placeholder">Select office...</span>
                                            <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                        <div class="searchable-dropdown-panel">
                                            <div class="searchable-dropdown-search">
                                                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="11" cy="11" r="8"/>
                                                    <path d="m21 21-4.35-4.35"/>
                                                </svg>
                                                <input type="text" placeholder="Search offices..." oninput="filterSearchableDropdown('office', this.value)">
                                                <button type="button" class="clear-btn" onclick="clearSearchableDropdown('office')">
                                                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="searchable-dropdown-header"><span class="item-count">0 offices</span></div>
                                            <div class="searchable-dropdown-list"></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Department Searchable Dropdown -->
                                <div class="form-group">
                                    <label>Department <span class="required">*</span></label>
                                    <input type="hidden" id="departmentId" required>
                                    <div class="searchable-dropdown" id="departmentDropdown" data-field="department">
                                        <div class="searchable-dropdown-trigger disabled" onclick="toggleSearchableDropdown('department')">
                                            <span class="selected-text placeholder">Select office first...</span>
                                            <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                        <div class="searchable-dropdown-panel">
                                            <div class="searchable-dropdown-search">
                                                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="11" cy="11" r="8"/>
                                                    <path d="m21 21-4.35-4.35"/>
                                                </svg>
                                                <input type="text" placeholder="Search departments..." oninput="filterSearchableDropdown('department', this.value)">
                                                <button type="button" class="clear-btn" onclick="clearSearchableDropdown('department')">
                                                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="searchable-dropdown-header"><span class="item-count">0 departments</span></div>
                                            <div class="searchable-dropdown-list"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row two-col">
                                <!-- Designation Searchable Dropdown -->
                                <div class="form-group">
                                    <label>Designation <span class="required">*</span></label>
                                    <input type="hidden" id="designationId" required>
                                    <div class="searchable-dropdown" id="designationDropdown" data-field="designation">
                                        <div class="searchable-dropdown-trigger disabled" onclick="toggleSearchableDropdown('designation')">
                                            <span class="selected-text placeholder">Select department first...</span>
                                            <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                        <div class="searchable-dropdown-panel">
                                            <div class="searchable-dropdown-search">
                                                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="11" cy="11" r="8"/>
                                                    <path d="m21 21-4.35-4.35"/>
                                                </svg>
                                                <input type="text" placeholder="Search designations..." oninput="filterSearchableDropdown('designation', this.value)">
                                                <button type="button" class="clear-btn" onclick="clearSearchableDropdown('designation')">
                                                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="searchable-dropdown-header"><span class="item-count">0 designations</span></div>
                                            <div class="searchable-dropdown-list"></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Shift Searchable Dropdown -->
                                <div class="form-group">
                                    <label>Shift</label>
                                    <input type="hidden" id="shiftId">
                                    <div class="searchable-dropdown" id="shiftDropdown" data-field="shift">
                                        <div class="searchable-dropdown-trigger disabled" onclick="toggleSearchableDropdown('shift')">
                                            <span class="selected-text placeholder">Select office first...</span>
                                            <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                        <div class="searchable-dropdown-panel">
                                            <div class="searchable-dropdown-search">
                                                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="11" cy="11" r="8"/>
                                                    <path d="m21 21-4.35-4.35"/>
                                                </svg>
                                                <input type="text" placeholder="Search shifts..." oninput="filterSearchableDropdown('shift', this.value)">
                                                <button type="button" class="clear-btn" onclick="clearSearchableDropdown('shift')">
                                                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="searchable-dropdown-header"><span class="item-count">0 shifts</span></div>
                                            <div class="searchable-dropdown-list"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row two-col">
                                <!-- Reporting Manager Searchable Dropdown -->
                                <div class="form-group">
                                    <label>Reporting Manager</label>
                                    <input type="hidden" id="managerId">
                                    <div class="searchable-dropdown" id="managerDropdown" data-field="manager">
                                        <div class="searchable-dropdown-trigger" onclick="toggleSearchableDropdown('manager')">
                                            <span class="selected-text placeholder">None (Select manager...)</span>
                                            <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                        <div class="searchable-dropdown-panel">
                                            <div class="searchable-dropdown-search">
                                                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="11" cy="11" r="8"/>
                                                    <path d="m21 21-4.35-4.35"/>
                                                </svg>
                                                <input type="text" placeholder="Search managers..." oninput="filterSearchableDropdown('manager', this.value)">
                                                <button type="button" class="clear-btn" onclick="clearSearchableDropdown('manager')">
                                                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="searchable-dropdown-header"><span class="item-count">0 managers</span></div>
                                            <div class="searchable-dropdown-list"></div>
                                        </div>
                                    </div>
                                    <small class="validation-message text-danger" id="managerValidationMsg" style="display: none;"></small>
                                </div>
                                <div class="form-group">
                                    <label>Employment Type <span class="required">*</span></label>
                                    <select id="employmentType" class="form-control" required>
                                        <option value="">Select employment type...</option>
                                        <option value="full-time">Full Time</option>
                                        <option value="part-time">Part Time</option>
                                        <option value="contract">Contract</option>
                                        <option value="intern">Intern</option>
                                        <option value="temporary">Temporary</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row two-col">
                                <div class="form-group">
                                    <label>Date of Joining <span class="required">*</span></label>
                                    <input type="date" id="dateOfJoining" required placeholder="Select joining date...">
                                </div>
                                <div class="form-group">
                                    <label>Probation End Date <span class="required">*</span></label>
                                    <input type="date" id="probationEndDate" required placeholder="Select probation end date...">
                                </div>
                            </div>

                            <!-- Geofence Attendance Toggle -->
                            <div class="geofence-toggle-card employee-geofence">
                                <div class="toggle-info">
                                    <div class="toggle-title">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="12" cy="10" r="3"/>
                                            <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z"/>
                                        </svg>
                                        Enable Geofence Attendance
                                    </div>
                                    <p class="toggle-description">When enabled, this employee must be within the assigned office geofence radius to clock in/out. Overrides office-level setting.</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableGeofenceAttendance" name="enable_geofence_attendance">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <!-- Attendance Exempt Override -->
                            <div class="form-group" style="margin-top: 16px;">
                                <label for="attendanceExemptOverride">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 6px;">
                                        <circle cx="12" cy="12" r="10"/>
                                        <path d="M8 12l2 2 4-4"/>
                                    </svg>
                                    Attendance Exemption for Payroll
                                </label>
                                <select id="attendanceExemptOverride" name="attendance_exempt_override" class="form-control">
                                    <option value="">Use Designation Default</option>
                                    <option value="true">Exempt (LOP not calculated from missing attendance)</option>
                                    <option value="false">Required (LOP calculated from missing attendance)</option>
                                </select>
                                <small class="form-text" style="color: var(--text-secondary);">
                                    Overrides the designation-level setting. Exempt employees (CEO, CTO, field staff) won't have LOP deducted for missing clock in/out records.
                                </small>
                            </div>
                        </div>

                        <!-- Step 3: Banking Details -->
                        <div class="wizard-panel" id="employeeStep3">
                            <p class="wizard-step-hint">Bank account details for salary disbursement</p>
                            <div class="form-row two-col">
                                <div class="form-group">
                                    <label>Account Holder Name <span class="required">*</span></label>
                                    <input type="text" id="accountHolderName" placeholder="Name as per bank account">
                                </div>
                                <div class="form-group">
                                    <label>Bank Name <span class="required">*</span></label>
                                    <input type="text" id="bankName" placeholder="e.g. HDFC Bank">
                                </div>
                            </div>
                            <div class="form-row two-col">
                                <div class="form-group">
                                    <label>Account Number <span class="required">*</span></label>
                                    <input type="text" id="accountNumber" placeholder="Bank account number">
                                </div>
                                <div class="form-group">
                                    <label>Confirm Account Number <span class="required">*</span></label>
                                    <input type="text" id="confirmAccountNumber" placeholder="Re-enter account number">
                                </div>
                            </div>
                            <div class="form-row two-col">
                                <div class="form-group">
                                    <label>IFSC / SWIFT / BIC / IBAN <span class="required">*</span></label>
                                    <input type="text" id="ifscCode" placeholder="Bank routing code" style="text-transform: uppercase;">
                                </div>
                                <div class="form-group">
                                    <label>Branch Name</label>
                                    <input type="text" id="branchName" placeholder="Branch name">
                                </div>
                            </div>
                            <input type="hidden" id="bankAccountId">
                        </div>

                        <!-- Step 4: Identity Documents -->
                        <div class="wizard-panel" id="employeeStep4">
                            <p class="wizard-step-hint">Photo, Tax ID (front & back), and National ID (front & back) are mandatory</p>
                            <div class="document-grid-compact" id="documentUploadGrid">
                                <!-- Tax ID / PAN Card -->
                                <div class="document-item-compact" data-doc-type="pan">
                                    <div class="doc-header-inline">
                                        <div class="doc-label-section">
                                            <span class="doc-label">Tax ID / PAN <span class="required">*</span></span>
                                        </div>
                                        <input type="text" id="pan-number" class="doc-input-inline" placeholder="Enter ID number" pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" style="text-transform: uppercase;">
                                    </div>
                                    <div class="doc-uploads-row">
                                        <!-- Front Side -->
                                        <div class="doc-upload-card" id="pan_front-card">
                                            <input type="file" id="pan_front-file" accept=".pdf,.jpg,.jpeg,.png" hidden onchange="handleDocumentSelect('pan_front', this)">
                                            <div class="doc-upload-placeholder" id="pan_front-placeholder" onclick="triggerFileUpload('pan_front')">
                                                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                                    <path d="M21 15l-5-5L5 21"/>
                                                </svg>
                                                <span class="upload-text">Front Side</span>
                                                <span class="upload-hint">Click to upload</span>
                                            </div>
                                            <div class="doc-upload-preview" id="pan_front-preview-card" style="display:none">
                                                <img class="doc-thumbnail" id="pan_front-thumb" onclick="openDocumentZoom('pan_front')" alt="Front">
                                                <div class="doc-preview-overlay">
                                                    <span class="preview-label">Front</span>
                                                    <button type="button" class="preview-remove-btn" onclick="removeDocument('pan_front')" title="Remove">
                                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div class="doc-zoom-hint">Click to enlarge</div>
                                            </div>
                                            <input type="hidden" id="pan_front-doc-id">
                                        </div>
                                        <!-- Back Side -->
                                        <div class="doc-upload-card" id="pan_back-card">
                                            <input type="file" id="pan_back-file" accept=".pdf,.jpg,.jpeg,.png" hidden onchange="handleDocumentSelect('pan_back', this)">
                                            <div class="doc-upload-placeholder" id="pan_back-placeholder" onclick="triggerFileUpload('pan_back')">
                                                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                                    <path d="M21 15l-5-5L5 21"/>
                                                </svg>
                                                <span class="upload-text">Back Side</span>
                                                <span class="upload-hint">Click to upload</span>
                                            </div>
                                            <div class="doc-upload-preview" id="pan_back-preview-card" style="display:none">
                                                <img class="doc-thumbnail" id="pan_back-thumb" onclick="openDocumentZoom('pan_back')" alt="Back">
                                                <div class="doc-preview-overlay">
                                                    <span class="preview-label">Back</span>
                                                    <button type="button" class="preview-remove-btn" onclick="removeDocument('pan_back')" title="Remove">
                                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div class="doc-zoom-hint">Click to enlarge</div>
                                            </div>
                                            <input type="hidden" id="pan_back-doc-id">
                                        </div>
                                    </div>
                                </div>

                                <!-- National ID / Aadhar / SSN -->
                                <div class="document-item-compact" data-doc-type="aadhar">
                                    <div class="doc-header-inline">
                                        <div class="doc-label-section">
                                            <span class="doc-label">National ID / Aadhar <span class="required">*</span></span>
                                        </div>
                                        <input type="text" id="aadhar-number" class="doc-input-inline" placeholder="Enter ID number" pattern="[0-9]{12}" maxlength="12">
                                    </div>
                                    <div class="doc-uploads-row">
                                        <!-- Front Side -->
                                        <div class="doc-upload-card" id="aadhar_front-card">
                                            <input type="file" id="aadhar_front-file" accept=".pdf,.jpg,.jpeg,.png" hidden onchange="handleDocumentSelect('aadhar_front', this)">
                                            <div class="doc-upload-placeholder" id="aadhar_front-placeholder" onclick="triggerFileUpload('aadhar_front')">
                                                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                                    <path d="M21 15l-5-5L5 21"/>
                                                </svg>
                                                <span class="upload-text">Front Side</span>
                                                <span class="upload-hint">Click to upload</span>
                                            </div>
                                            <div class="doc-upload-preview" id="aadhar_front-preview-card" style="display:none">
                                                <img class="doc-thumbnail" id="aadhar_front-thumb" onclick="openDocumentZoom('aadhar_front')" alt="Front">
                                                <div class="doc-preview-overlay">
                                                    <span class="preview-label">Front</span>
                                                    <button type="button" class="preview-remove-btn" onclick="removeDocument('aadhar_front')" title="Remove">
                                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div class="doc-zoom-hint">Click to enlarge</div>
                                            </div>
                                            <input type="hidden" id="aadhar_front-doc-id">
                                        </div>
                                        <!-- Back Side -->
                                        <div class="doc-upload-card" id="aadhar_back-card">
                                            <input type="file" id="aadhar_back-file" accept=".pdf,.jpg,.jpeg,.png" hidden onchange="handleDocumentSelect('aadhar_back', this)">
                                            <div class="doc-upload-placeholder" id="aadhar_back-placeholder" onclick="triggerFileUpload('aadhar_back')">
                                                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                                    <path d="M21 15l-5-5L5 21"/>
                                                </svg>
                                                <span class="upload-text">Back Side</span>
                                                <span class="upload-hint">Click to upload</span>
                                            </div>
                                            <div class="doc-upload-preview" id="aadhar_back-preview-card" style="display:none">
                                                <img class="doc-thumbnail" id="aadhar_back-thumb" onclick="openDocumentZoom('aadhar_back')" alt="Back">
                                                <div class="doc-preview-overlay">
                                                    <span class="preview-label">Back</span>
                                                    <button type="button" class="preview-remove-btn" onclick="removeDocument('aadhar_back')" title="Remove">
                                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div class="doc-zoom-hint">Click to enlarge</div>
                                            </div>
                                            <input type="hidden" id="aadhar_back-doc-id">
                                        </div>
                                    </div>
                                </div>

                                <!-- Passport (Optional) -->
                                <div class="document-item-compact" data-doc-type="passport">
                                    <div class="doc-header-inline">
                                        <div class="doc-label-section">
                                            <span class="doc-label">Passport <span class="optional-badge">Optional</span></span>
                                        </div>
                                        <input type="text" id="passport-number" class="doc-input-inline" placeholder="Passport number" style="text-transform: uppercase;">
                                        <input type="date" id="passport-expiry" class="doc-input-inline doc-input-date" title="Expiry Date">
                                    </div>
                                    <div class="doc-uploads-row doc-uploads-single">
                                        <div class="doc-upload-card doc-upload-card-wide" id="passport-card">
                                            <input type="file" id="passport-file" accept=".pdf,.jpg,.jpeg,.png" hidden onchange="handleDocumentSelect('passport', this)">
                                            <div class="doc-upload-placeholder" id="passport-placeholder" onclick="triggerFileUpload('passport')">
                                                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                                    <path d="M21 15l-5-5L5 21"/>
                                                </svg>
                                                <span class="upload-text">Passport Photo Page</span>
                                                <span class="upload-hint">Click to upload</span>
                                            </div>
                                            <div class="doc-upload-preview" id="passport-preview-card" style="display:none">
                                                <img class="doc-thumbnail" id="passport-thumb" onclick="openDocumentZoom('passport')" alt="Passport">
                                                <div class="doc-preview-overlay">
                                                    <span class="preview-label">Passport</span>
                                                    <button type="button" class="preview-remove-btn" onclick="removeDocument('passport')" title="Remove">
                                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div class="doc-zoom-hint">Click to enlarge</div>
                                            </div>
                                            <input type="hidden" id="passport-doc-id">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Document Zoom Modal -->
                        <div class="doc-zoom-modal" id="docZoomModal" onclick="closeDocumentZoom(event)">
                            <div class="doc-zoom-content">
                                <img id="docZoomImage" src="" alt="Document Preview">
                                <button class="doc-zoom-close" onclick="closeDocumentZoom(event)">&times;</button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Wizard Navigation Footer -->
                <div class="modal-footer wizard-footer">
                    <button class="btn btn-outline" id="empWizardPrevBtn" onclick="prevEmployeeStep()" style="display: none;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        Back
                    </button>
                    <div class="wizard-footer-spacer"></div>
                    <button class="btn btn-primary" id="empWizardNextBtn" onclick="nextEmployeeStep()">
                        Next
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                    <button class="btn btn-primary" id="empWizardSaveBtn" onclick="saveEmployee()" style="display: none;">
                        Save Employee
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Employee Modal -->
    <div class="modal" id="viewEmployeeModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Employee Details</h3>
                    <button class="close-btn" onclick="closeModal('viewEmployeeModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body" id="viewEmployeeContent">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="editFromView()" id="editFromViewBtn">Edit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transfer Employee Modal -->
    <div class="modal" id="transferModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Transfer Employee</h3>
                    <button class="close-btn" onclick="closeModal('transferModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Compact Employee Card with Current Assignment -->
                    <div class="transfer-employee-card">
                        <div class="employee-avatar" id="transferEmployeeAvatar">-</div>
                        <div class="employee-card-content">
                            <div class="employee-card-header">
                                <span class="employee-name" id="transferEmployeeName">-</span>
                                <span class="employee-code" id="transferEmployeeCode">-</span>
                            </div>
                            <div class="assignment-row">
                                <span class="assign-item"><span class="assign-icon">üìç</span><span id="currentOfficeName">-</span></span>
                                <span class="assign-item"><span class="assign-icon">üè¢</span><span id="currentDepartmentName">-</span></span>
                                <span class="assign-item"><span class="assign-icon">üíº</span><span id="currentDesignationName">-</span></span>
                                <span class="assign-item"><span class="assign-icon">üë§</span><span id="currentManagerName">-</span></span>
                            </div>
                        </div>
                    </div>

                    <form id="transferForm">
                        <input type="hidden" id="transferEmployeeId">

                        <!-- Transfer Details -->
                        <div class="form-section">
                            <h4>Transfer Details</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Transfer Type <span class="required">*</span></label>
                                    <select id="transferType" required>
                                        <option value="transfer">Transfer</option>
                                        <option value="promotion">Promotion</option>
                                        <option value="demotion">Demotion</option>
                                        <option value="deputation">Deputation</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Effective Date <span class="required">*</span></label>
                                    <input type="date" id="transferEffectiveDate" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Transfer Reason</label>
                                <textarea id="transferReason" rows="2" placeholder="Optional reason for transfer..."></textarea>
                            </div>
                        </div>

                        <!-- What to Change Section -->
                        <div class="form-section">
                            <h4>Select Changes</h4>
                            <div class="transfer-toggle-options">
                                <div class="switch-container">
                                    <label class="switch">
                                        <input type="checkbox" id="changeOffice" onchange="toggleTransferSection('officeChangeSection', this)">
                                        <span class="slider round"></span>
                                    </label>
                                    <span class="switch-label">Change Office</span>
                                </div>
                                <div class="switch-container">
                                    <label class="switch">
                                        <input type="checkbox" id="changeDepartment" onchange="toggleTransferSection('departmentChangeSection', this)">
                                        <span class="slider round"></span>
                                    </label>
                                    <span class="switch-label">Change Department</span>
                                </div>
                                <div class="switch-container">
                                    <label class="switch">
                                        <input type="checkbox" id="changeManager" onchange="toggleTransferSection('managerChangeSection', this)">
                                        <span class="slider round"></span>
                                    </label>
                                    <span class="switch-label">Change Manager</span>
                                </div>
                            </div>
                        </div>

                        <!-- Office Change Section -->
                        <div class="form-section conditional-section" id="officeChangeSection" style="display: none;">
                            <h4>New Office</h4>
                            <div class="form-group">
                                <label>Select New Office <span class="required">*</span></label>
                                <select id="newOfficeId">
                                    <option value="">Select new office...</option>
                                </select>
                            </div>
                        </div>

                        <!-- Department Change Section -->
                        <div class="form-section conditional-section" id="departmentChangeSection" style="display: none;">
                            <h4>New Department & Designation</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>New Department <span class="required">*</span></label>
                                    <select id="newDepartmentId" onchange="onNewDepartmentChange()">
                                        <option value="">Select new department...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>New Designation</label>
                                    <select id="newDesignationId">
                                        <option value="">Select department first...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Manager Change Section -->
                        <div class="form-section conditional-section" id="managerChangeSection" style="display: none;">
                            <h4>New Reporting Manager</h4>
                            <div class="form-group">
                                <label>New Manager</label>
                                <select id="newManagerUserId" onchange="onTransferManagerChange()">
                                    <option value="">No manager (CEO/Top level)</option>
                                </select>
                                <small class="validation-message text-danger" id="transferManagerValidationMsg" style="display: none;"></small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="submitTransfer()" id="submitTransferBtn">Submit Transfer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reassign Manager Modal (Compact with Searchable Dropdown) -->
    <div class="modal" id="reassignManagerModal">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content modal-compact">
                <div class="modal-header compact-header">
                    <div class="header-with-employee">
                        <div class="employee-badge" id="reassignEmployeeAvatar">--</div>
                        <div>
                            <h4 id="reassignEmployeeName">Employee Name</h4>
                            <span class="employee-meta" id="reassignEmployeeCode">EMP000</span>
                        </div>
                    </div>
                    <button class="close-btn" onclick="closeModal('reassignManagerModal')">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body compact-body">
                    <input type="hidden" id="reassignEmployeeId">

                    <!-- Manager History Section -->
                    <div class="manager-history-section">
                        <span class="section-label">Reporting History <span class="manager-history-count" id="managerHistoryCount" style="display: none;">0</span></span>
                        <div class="manager-history-list" id="managerHistoryList">
                            <div class="no-history-message">Loading...</div>
                        </div>
                    </div>

                    <!-- Searchable Manager Dropdown -->
                    <div class="form-group compact-group">
                        <label>New Manager</label>
                        <div class="searchable-dropdown" id="managerDropdownContainer">
                            <div class="dropdown-input-wrapper">
                                <input type="text" class="dropdown-search" id="managerSearchInput"
                                       placeholder="Search managers..." autocomplete="off">
                                <input type="hidden" id="newReportingManagerId">
                                <svg class="dropdown-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                            <div class="dropdown-list" id="managerDropdownList">
                                <div class="dropdown-item no-manager" data-value="">
                                    <span class="item-avatar">‚Äî</span>
                                    <span>No manager (Top level)</span>
                                </div>
                                <!-- Virtual scrolling container -->
                                <div class="virtual-scroll-container" id="managerVirtualList"></div>
                            </div>
                        </div>
                        <small class="validation-message text-danger" id="reassignManagerValidationMsg" style="display: none;"></small>
                    </div>

                    <!-- Effective Date & Reason in one row -->
                    <div class="form-row compact-row">
                        <div class="form-group compact-group flex-1">
                            <label>Effective Date</label>
                            <input type="date" id="reassignEffectiveDate" class="form-control form-control-sm" required>
                        </div>
                        <div class="form-group compact-group flex-2">
                            <label>Reason <span class="optional">(optional)</span></label>
                            <input type="text" id="reassignReason" class="form-control form-control-sm" placeholder="e.g., Restructuring">
                        </div>
                    </div>
                </div>
                <div class="modal-footer compact-footer">
                    <button class="btn btn-sm btn-secondary" onclick="closeModal('reassignManagerModal')">Cancel</button>
                    <button class="btn btn-sm btn-primary" onclick="submitReassignManager()" id="submitReassignBtn">Reassign</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transfer History Modal -->
    <div class="modal" id="transferHistoryModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Transfer History</h3>
                    <button class="close-btn" onclick="closeModal('transferHistoryModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body" id="transferHistoryContent">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Terminate Employee Modal -->
    <div class="modal" id="terminateModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header modal-header-danger">
                    <h5 class="modal-title">Terminate Employee</h5>
                    <button class="close-btn" onclick="closeModal('terminateModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="terminate-warning">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        <div>
                            <strong>Warning: This action cannot be undone.</strong>
                            <p>Terminating an employee will deactivate their account and end their employment record.</p>
                        </div>
                    </div>
                    <div class="terminate-employee-info" id="terminateEmployeeInfo">
                        <!-- Employee info will be populated -->
                    </div>
                    <form id="terminateForm">
                        <input type="hidden" id="terminateEmployeeId">
                        <div class="form-section">
                            <div class="form-row two-col">
                                <div class="form-group">
                                    <label for="lastWorkingDate">Last Working Date *</label>
                                    <input type="date" id="lastWorkingDate" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="terminationReason">Termination Reason *</label>
                                    <select id="terminationReason" class="form-control" required>
                                        <option value="">Select Reason</option>
                                        <option value="resignation">Resignation</option>
                                        <option value="termination">Termination</option>
                                        <option value="retirement">Retirement</option>
                                        <option value="contract_end">Contract End</option>
                                        <option value="layoff">Layoff</option>
                                        <option value="mutual_separation">Mutual Separation</option>
                                        <option value="absconding">Absconding</option>
                                        <option value="death">Death</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row two-col">
                                <div class="form-group">
                                    <label for="exitInterviewDate">Exit Interview Date</label>
                                    <input type="date" id="exitInterviewDate" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="settlementDate">Full & Final Settlement Date</label>
                                    <input type="date" id="settlementDate" class="form-control">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="exitNotes">Exit Notes</label>
                                <textarea id="exitNotes" class="form-control" rows="3" placeholder="Enter any additional notes about the termination..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="confirmTermination" required>
                                    <span>I confirm that I want to terminate this employee and understand this action cannot be undone.</span>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="confirmTerminateEmployee()">Terminate Employee</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Slide Panel -->
    <div class="employee-panel-overlay" id="employeePanelOverlay" onclick="closeEmployeePanel()"></div>
    <div class="employee-slide-panel" id="employeeSlidePanel">
        <div class="panel-drag-handle"></div>
        <div class="panel-header">
            <h3>Employee Details</h3>
            <button class="panel-close-btn" onclick="closeEmployeePanel()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="panel-body" id="employeePanelBody">
            <div class="panel-loading">
                <div class="spinner"></div>
            </div>
        </div>
        <div class="panel-actions" id="employeePanelActions">
            <div class="panel-actions-card">
                <div class="panel-actions-content">
                    <div class="panel-actions-title">Quick Actions</div>
                    <div class="panel-action-buttons" id="panelActionButtons">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>document.write('<script src="../../js/hrms/hrms-datepicker.js?v=' + CACHE_VERSION + '"><\/script>');</script>
    <script>
        document.write('<script src="../../js/config.js?v=' + CACHE_VERSION + '"><\/script>');
        document.write('<script src="../../js/api.js?v=' + CACHE_VERSION + '"><\/script>');
        document.write('<script src="../../js/navigation.js?v=' + CACHE_VERSION + '"><\/script>');
        document.write('<script src="../../js/hrms/roleUtils.js?v=' + CACHE_VERSION + '"><\/script>');
        document.write('<script src="../../js/toast.js?v=' + CACHE_VERSION + '"><\/script>');
        document.write('<script src="../../js/hrms/hrms-signalr.js?v=' + CACHE_VERSION + '"><\/script>');
        document.write('<script src="../../js/hrms/office-selection.js?v=' + CACHE_VERSION + '"><\/script>');
        document.write('<script src="../../js/searchable-dropdown.js?v=' + CACHE_VERSION + '"><\/script>');
        document.write('<script src="../../js/table-pagination.js?v=' + CACHE_VERSION + '"><\/script>');
        document.write('<script src="../../js/hrms/employees.js?v=' + CACHE_VERSION + '"><\/script>');
    </script>
</body>
</html>
