<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payroll - HRMS | HyperDroid</title>
    <script>window.CACHE_VERSION = Date.now();</script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script>document.write('<link rel="stylesheet" href="../../css/styles.css?v=' + CACHE_VERSION + '">');</script>
    <script>document.write('<link rel="stylesheet" href="../../css/hrms.css?v=' + CACHE_VERSION + '">');</script>
</head>
<body class="dashboard">
    <nav class="navbar">
        <div class="navbar-brand">
            <a href="../home.html">
                <img src="../../assets/logo-svg.svg" alt="HyperDroid Logo" class="navbar-logo">
            </a>
        </div>
        <div class="navbar-menu">
            <!-- Navigation links rendered by Navigation.init() -->
        </div>
    </nav>

    <div class="hrms-container">
        <div class="hrms-header">
            <div class="header-content">
                <nav class="breadcrumb-nav">
                    <a href="dashboard.html">HRMS</a>
                    <span class="separator">/</span>
                    <span class="current">Payroll</span>
                </nav>
                <h1>Payroll Management</h1>
            </div>
            <div class="header-actions" id="adminActions" style="display: none;">
                <button class="btn btn-primary" onclick="showSalaryStructureModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Salary Structure
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="hrms-tabs">
            <button class="tab-btn active" data-tab="my-payslips">My Payslips</button>
            <button class="tab-btn" data-tab="payroll-drafts" id="payrollDraftsTab" style="display: none;">Payroll Drafts</button>
            <button class="tab-btn" data-tab="payroll-runs" id="payrollRunsTab" style="display: none;">Finalized Runs</button>
            <button class="tab-btn" data-tab="salary-structures" id="salaryTab" style="display: none;">Salary Structures</button>
            <button class="tab-btn" data-tab="components" id="componentsTab" style="display: none;">Components</button>
            <button class="tab-btn" data-tab="loans" id="loansTab">Loans & Advances</button>
        </div>

        <!-- My Payslips Tab -->
        <div class="tab-content active" id="my-payslips">
            <div class="filters-bar">
                <div class="filter-group">
                    <select id="payslipYear" class="form-select">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
            </div>

            <!-- Salary Summary -->
            <div class="stats-row" id="mySalaryStats">
                <div class="stat-card">
                    <div class="stat-value" id="lastGross">₹0</div>
                    <div class="stat-label">Last Gross Salary</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lastDeductions">₹0</div>
                    <div class="stat-label">Total Deductions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lastNet">₹0</div>
                    <div class="stat-label">Net Salary</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="ytdEarnings">₹0</div>
                    <div class="stat-label">YTD Earnings</div>
                </div>
            </div>

            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Pay Period</th>
                            <th>Gross Salary</th>
                            <th>Deductions</th>
                            <th>Net Salary</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="myPayslipsTable">
                        <tr class="empty-state">
                            <td colspan="7">
                                <div class="empty-message">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                        <line x1="1" y1="10" x2="23" y2="10"></line>
                                    </svg>
                                    <p>No payslips found</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Payroll Drafts Tab -->
        <div class="tab-content" id="payroll-drafts">
            <div class="filters-bar">
                <div class="filter-group">
                    <select id="draftYear" class="form-select" onchange="loadPayrollDrafts()">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                    <select id="draftMonth" class="form-select" onchange="loadPayrollDrafts()">
                        <option value="">All Months</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                    <select id="draftOffice" class="form-select" onchange="loadPayrollDrafts()">
                        <option value="">All Offices</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="openCreateDraftModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Create Draft
                </button>
            </div>

            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Draft Name</th>
                            <th>Period</th>
                            <th>Office</th>
                            <th>Employees</th>
                            <th>Gross Amount</th>
                            <th>Net Amount</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="payrollDraftsTable">
                        <tr class="empty-state">
                            <td colspan="9">
                                <div class="empty-message">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                        <line x1="16" y1="13" x2="8" y2="13"></line>
                                        <line x1="16" y1="17" x2="8" y2="17"></line>
                                    </svg>
                                    <p>No payroll drafts found</p>
                                    <p class="hint">Create a new draft to start payroll processing</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Payroll Runs Tab (Finalized) -->
        <div class="tab-content" id="payroll-runs">
            <div class="filters-bar">
                <div class="filter-group">
                    <select id="runYear" class="form-select" onchange="loadPayrollRuns()">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                    <select id="runMonth" class="form-select" onchange="loadPayrollRuns()">
                        <option value="">All Months</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                    <select id="runOffice" class="form-select" onchange="loadPayrollRuns()">
                        <option value="">All Offices</option>
                    </select>
                </div>
            </div>

            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Run ID</th>
                            <th>Period</th>
                            <th>Office</th>
                            <th>Employees</th>
                            <th>Gross Amount</th>
                            <th>Net Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="payrollRunsTable">
                        <tr class="empty-state">
                            <td colspan="8">
                                <div class="empty-message">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    <p>No finalized payroll runs found</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Salary Structures Tab -->
        <div class="tab-content" id="salary-structures">
            <!-- Office filter cards for salary structures -->
            <div class="office-structure-status" id="officeStructureStatus">
                <!-- Dynamically populated by JavaScript -->
            </div>

            <div class="filters-bar">
                <div class="filter-group">
                    <select id="structureOfficeFilter" class="form-select">
                        <option value="">All Offices</option>
                    </select>
                </div>
                <div class="search-box-modern">
                    <svg class="search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input type="text" id="structureSearch" placeholder="Search structures...">
                </div>
                <button class="btn btn-primary" onclick="showCreateStructureModal()" id="createStructureBtn" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Create Structure
                </button>
            </div>

            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Office</th>
                            <th>Structure Name</th>
                            <th>Code</th>
                            <th>Components</th>
                            <th>Employees</th>
                            <th>Default</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="salaryStructuresTable">
                        <tr class="empty-state">
                            <td colspan="8">
                                <div class="empty-message">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                    </svg>
                                    <p>No salary structures defined</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Components Tab -->
        <div class="tab-content" id="components">
            <div class="filters-bar">
                <div class="search-box-modern">
                    <svg class="search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input type="text" id="componentSearch" placeholder="Search components...">
                </div>
                <div class="filter-group">
                    <select id="componentType" class="form-select">
                        <option value="">All Types</option>
                        <option value="earning">Earnings</option>
                        <option value="deduction">Deductions</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="showCreateComponentModal()" id="createComponentBtn" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Add Component
                </button>
            </div>

            <div class="component-sections">
                <div class="component-section">
                    <h3>Earnings</h3>
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Component Name</th>
                                    <th>Code</th>
                                    <th>Type</th>
                                    <th>Taxable</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="earningsTable">
                                <tr class="empty-state">
                                    <td colspan="6"><p>No earnings components</p></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="component-section">
                    <h3>Deductions</h3>
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Component Name</th>
                                    <th>Code</th>
                                    <th>Type</th>
                                    <th>Pre-Tax</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="deductionsTable">
                                <tr class="empty-state">
                                    <td colspan="6"><p>No deduction components</p></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loans Tab -->
        <div class="tab-content" id="loans">
            <div class="filters-bar">
                <div class="search-box-modern">
                    <svg class="search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input type="text" id="loanSearch" placeholder="Search loans...">
                </div>
                <div class="filter-group">
                    <select id="loanStatus" class="form-select">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="showCreateLoanModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Apply for Loan
                </button>
            </div>

            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Loan Type</th>
                            <th>Principal Amount</th>
                            <th>EMI</th>
                            <th>Balance</th>
                            <th>Start Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="loansTable">
                        <tr class="empty-state">
                            <td colspan="8">
                                <div class="empty-message">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                        <line x1="12" y1="1" x2="12" y2="23"></line>
                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                    </svg>
                                    <p>No loans found</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Create Payroll Draft Modal -->
    <div class="modal" id="createDraftModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Payroll Draft</h5>
                    <button class="close-btn" onclick="closeModal('createDraftModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="createDraftForm">
                        <div class="form-section">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="draftName">Draft Name</label>
                                    <input type="text" id="draftName" name="draftName" class="form-control" placeholder="e.g., Main Draft, Scenario A" value="Draft">
                                    <small class="form-text text-muted">Give this draft a name to distinguish it from others</small>
                                </div>
                            </div>
                            <div class="form-row two-col">
                                <div class="form-group">
                                    <label for="draftPayrollMonth">Month *</label>
                                    <select id="draftPayrollMonth" name="month" class="form-control" required>
                                        <option value="1">January</option>
                                        <option value="2">February</option>
                                        <option value="3">March</option>
                                        <option value="4">April</option>
                                        <option value="5">May</option>
                                        <option value="6">June</option>
                                        <option value="7">July</option>
                                        <option value="8">August</option>
                                        <option value="9">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="draftPayrollYear">Year *</label>
                                    <select id="draftPayrollYear" name="year" class="form-control" required>
                                        <option value="2025">2025</option>
                                        <option value="2024">2024</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="draftPayrollOffice">Office</label>
                                    <select id="draftPayrollOffice" name="officeId" class="form-control">
                                        <option value="">All Offices</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row two-col">
                                <div class="form-group">
                                    <label for="draftPeriodStart">Pay Period Start *</label>
                                    <input type="date" id="draftPeriodStart" name="periodStart" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="draftPeriodEnd">Pay Period End *</label>
                                    <input type="date" id="draftPeriodEnd" name="periodEnd" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="draftNotes">Notes</label>
                                    <textarea id="draftNotes" name="notes" class="form-control" rows="2" placeholder="Optional notes about this draft"></textarea>
                                </div>
                            </div>
                            <div class="info-box">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="16" x2="12" y2="12"></line>
                                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                </svg>
                                <span>Create an empty draft first, then click "Process" to generate payslips. You can create multiple drafts for the same period to compare different scenarios.</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('createDraftModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createPayrollDraft()">Create Draft</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Draft Details Modal -->
    <div class="modal" id="draftDetailsModal">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="draftDetailTitle">Draft Details</h5>
                    <button class="close-btn" onclick="closeModal('draftDetailsModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Summary Cards -->
                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-value" id="draftTotalEmployees">0</div>
                            <div class="stat-label">Employees</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="draftTotalGross">$0</div>
                            <div class="stat-label">Total Gross</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="draftTotalDeductions">$0</div>
                            <div class="stat-label">Total Deductions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="draftTotalNet">$0</div>
                            <div class="stat-label">Total Net Pay</div>
                        </div>
                    </div>

                    <!-- Toolbar: Search + Action Buttons -->
                    <div class="draft-toolbar">
                        <div class="search-box">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="M21 21l-4.35-4.35"></path>
                            </svg>
                            <input type="text" id="draftPayslipSearch" placeholder="Search by name, code, or department..." oninput="filterDraftPayslips(this.value)">
                        </div>
                        <div class="draft-actions">
                            <button type="button" class="btn-icon btn-icon-warning" onclick="event.stopPropagation(); recalculateDraft(document.getElementById('draftDetailsModal').dataset.draftId)" title="Recalculate payroll for all employees">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                                </svg>
                            </button>
                            <button type="button" class="btn-icon btn-icon-success" onclick="event.stopPropagation(); finalizeDraft(document.getElementById('draftDetailsModal').dataset.draftId)" title="Finalize draft and create payroll run">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </button>
                            <button type="button" class="btn-icon btn-icon-primary" onclick="event.stopPropagation(); exportDraftToCSV()" title="Export to CSV">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Payslips Table -->
                    <div class="data-table-container" style="max-height: 400px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Employee Code</th>
                                    <th>Employee Name</th>
                                    <th>Department</th>
                                    <th>Gross</th>
                                    <th>Deductions</th>
                                    <th>Net Pay</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="draftPayslipsTable">
                                <tr>
                                    <td colspan="7" class="text-center">No payslips generated yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Salary Structure Modal -->
    <div class="modal" id="structureModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="structureModalTitle">Create Salary Structure</h5>
                    <button class="close-btn" onclick="closeModal('structureModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                <form id="structureForm">
                    <input type="hidden" id="structureId" name="id">
                    <div class="form-section">
                        <h3>Basic Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="structureOffice">Office *</label>
                                <select id="structureOffice" name="office_id" class="form-control" required>
                                    <option value="">Select Office</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row two-col">
                            <div class="form-group">
                                <label for="structureName">Structure Name *</label>
                                <input type="text" id="structureName" name="name" class="form-control" required placeholder="e.g., Standard Employee">
                            </div>
                            <div class="form-group">
                                <label for="structureCode">Code *</label>
                                <input type="text" id="structureCode" name="code" class="form-control" required placeholder="e.g., STD">
                            </div>
                        </div>
                        <div class="form-row two-col">
                            <div class="form-group">
                                <label for="structureDescription">Description</label>
                                <textarea id="structureDescription" name="description" class="form-control" rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="structureIsDefault">Set as Default for Office</label>
                                <select id="structureIsDefault" name="is_default" class="form-control">
                                    <option value="false">No</option>
                                    <option value="true">Yes</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-section">
                        <h3>Components</h3>
                        <div class="components-list" id="structureComponents">
                            <!-- Dynamically populated -->
                        </div>
                        <button type="button" class="btn btn-outline btn-sm" onclick="addStructureComponent()">
                            + Add Component
                        </button>
                    </div>
                </form>
            </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('structureModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSalaryStructure()">Save Structure</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Component Modal -->
    <div class="modal" id="componentModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="componentModalTitle">Create Salary Component</h5>
                    <button class="close-btn" onclick="closeModal('componentModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                <form id="componentForm">
                    <input type="hidden" id="componentId" name="id">
                    <div class="form-section">
                        <div class="form-row two-col">
                            <div class="form-group">
                                <label for="componentName">Component Name *</label>
                                <input type="text" id="componentName" name="name" class="form-control" required placeholder="e.g., Basic Salary">
                            </div>
                            <div class="form-group">
                                <label for="componentCode">Code *</label>
                                <input type="text" id="componentCode" name="code" class="form-control" required placeholder="e.g., BASIC">
                            </div>
                        </div>
                        <div class="form-row two-col">
                            <div class="form-group">
                                <label for="componentCategory">Category *</label>
                                <select id="componentCategory" name="category" class="form-control" required>
                                    <option value="earning">Earning</option>
                                    <option value="deduction">Deduction</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="calculationType">Calculation Type *</label>
                                <select id="calculationType" name="calculationType" class="form-control" required>
                                    <option value="fixed">Fixed Amount</option>
                                    <option value="percentage">Percentage of Basic</option>
                                </select>
                            </div>
                        </div>
                        <!-- Percentage fields (shown when calculation type is percentage) -->
                        <div class="form-row two-col" id="percentageFieldsRow" style="display: none;">
                            <div class="form-group">
                                <label for="componentPercentage">Percentage *</label>
                                <input type="number" id="componentPercentage" name="percentage" class="form-control" placeholder="e.g., 50" step="0.01" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label for="calculationBase">Calculation Base *</label>
                                <select id="calculationBase" name="calculationBase" class="form-control">
                                    <option value="basic">Basic Salary</option>
                                    <option value="gross">Gross Salary</option>
                                    <option value="ctc">CTC</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row two-col">
                            <div class="form-group">
                                <label for="isTaxable">Taxable</label>
                                <select id="isTaxable" name="isTaxable" class="form-control">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="isStatutory">Statutory</label>
                                <select id="isStatutory" name="isStatutory" class="form-control">
                                    <option value="false">No</option>
                                    <option value="true">Yes</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="componentDescription">Description</label>
                                <textarea id="componentDescription" name="description" class="form-control" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('componentModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveComponent()">Save Component</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Loan Modal -->
    <div class="modal" id="loanModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loanModalTitle">Apply for Loan</h5>
                    <button class="close-btn" onclick="closeModal('loanModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                <form id="loanForm">
                    <input type="hidden" id="loanId" name="id">
                    <div class="form-section">
                        <div class="form-row" id="loanEmployeeRow">
                            <div class="form-group">
                                <label for="loanEmployee">Employee *</label>
                                <select id="loanEmployee" name="employeeId" class="form-control" required>
                                    <option value="">Select Employee</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row two-col">
                            <div class="form-group">
                                <label for="loanType">Loan Type *</label>
                                <select id="loanType" name="loanType" class="form-control" required>
                                    <option value="salary_advance">Salary Advance</option>
                                    <option value="personal_loan">Personal Loan</option>
                                    <option value="emergency_loan">Emergency Loan</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="loanAmount">Amount *</label>
                                <input type="number" id="loanAmount" name="amount" class="form-control" required min="0" step="0.01">
                            </div>
                        </div>
                        <div class="form-row two-col">
                            <div class="form-group">
                                <label for="interestRate">Interest Rate (%)</label>
                                <input type="number" id="interestRate" name="interestRate" class="form-control" min="0" max="100" step="0.01" value="0">
                            </div>
                            <div class="form-group">
                                <label for="emiAmount">EMI Amount *</label>
                                <input type="number" id="emiAmount" name="emiAmount" class="form-control" required min="0" step="0.01">
                            </div>
                        </div>
                        <div class="form-row two-col">
                            <div class="form-group">
                                <label for="loanStartDate">Start Date *</label>
                                <input type="date" id="loanStartDate" name="startDate" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="numberOfInstallments">No. of Installments *</label>
                                <input type="number" id="numberOfInstallments" name="installments" class="form-control" required min="1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="loanReason">Reason</label>
                                <textarea id="loanReason" name="reason" class="form-control" rows="2" placeholder="Purpose of the loan"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('loanModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveLoan()">Submit Application</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Payslip Modal -->
    <div class="modal" id="payslipModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Payslip Details</h5>
                    <div class="modal-header-actions">
                        <button type="button" class="btn btn-sm btn-outline" onclick="downloadPayslip()" title="Download PDF">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                        </button>
                        <button class="close-btn" onclick="closeModal('payslipModal')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="payslip-container" id="payslipContent">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payroll Run Details Modal -->
    <div class="modal" id="payrollRunDetailsModal">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 900px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="payrollRunDetailsTitle">Payroll Run Details</h5>
                    <button class="close-btn" onclick="closeModal('payrollRunDetailsModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <div id="payrollRunDetailsContent">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" id="deletePayrollRunBtn" onclick="deleteCurrentPayrollRun()" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        Delete Draft
                    </button>
                    <button type="button" class="btn btn-outline" id="processPayrollRunBtn" onclick="processCurrentPayrollRun()" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        Process Payroll
                    </button>
                    <button type="button" class="btn btn-outline" id="downloadCsvBtn" onclick="downloadPayrollCsv()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Download CSV
                    </button>
                    <button type="button" class="btn btn-primary" onclick="closeModal('payrollRunDetailsModal')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Version History Modal -->
    <div class="modal" id="versionHistoryModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="versionHistoryTitle">Version History</h5>
                    <button class="close-btn" onclick="closeModal('versionHistoryModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="version-info-banner">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <span>Structure versions track component changes over time. Each version has an effective date for mid-month proration calculations.</span>
                    </div>
                    <div class="data-table-container" style="max-height: 400px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Version</th>
                                    <th>Effective From</th>
                                    <th>Effective To</th>
                                    <th>Components</th>
                                    <th>Change Reason</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="versionHistoryTable">
                                <tr class="empty-state">
                                    <td colspan="6">
                                        <div class="empty-message">
                                            <p>No versions found</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="previewVersionedSalary()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="3" y1="9" x2="21" y2="9"></line>
                            <line x1="9" y1="21" x2="9" y2="9"></line>
                        </svg>
                        Preview Calculation
                    </button>
                    <button type="button" class="btn btn-primary" onclick="showCreateVersionModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Create New Version
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Version Modal -->
    <div class="modal" id="createVersionModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createVersionModalTitle">Create New Version</h5>
                    <button class="close-btn" onclick="closeModal('createVersionModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="newVersionForm">
                        <div class="form-section">
                            <div class="form-row two-col">
                                <div class="form-group">
                                    <label for="versionEffectiveDate">Effective From *</label>
                                    <input type="date" id="versionEffectiveDate" name="effectiveFrom" class="form-control" required>
                                    <small class="form-text text-muted">Payroll will use this version for days after this date</small>
                                </div>
                                <div class="form-group">
                                    <label for="versionChangeReason">Change Reason</label>
                                    <input type="text" id="versionChangeReason" name="changeReason" class="form-control" placeholder="e.g., Added Professional Tax">
                                </div>
                            </div>
                        </div>
                        <div class="form-section">
                            <h3>Components</h3>
                            <p class="text-muted">Select components and set their values for this version</p>
                            <div class="version-components-list" id="newVersionComponents">
                                <!-- Dynamically populated -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('createVersionModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewVersion()">Create Version</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.write('<script src="../../js/config.js?v=' + CACHE_VERSION + '"><\/script>');
        document.write('<script src="../../js/api.js?v=' + CACHE_VERSION + '"><\/script>');
        document.write('<script src="../../js/navigation.js?v=' + CACHE_VERSION + '"><\/script>');
        document.write('<script src="../../js/hrms/payroll.js?v=' + CACHE_VERSION + '"><\/script>');
    </script>

    <style>
        /* Additional payroll-specific styles */
        .component-sections {
            display: grid;
            gap: 24px;
        }

        .component-section h3 {
            margin-bottom: 16px;
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .info-box {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 13px;
            color: #666;
        }

        .info-box svg {
            flex-shrink: 0;
            color: #666;
        }

        .payslip-container {
            font-size: 14px;
        }

        .payslip-header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #000;
        }

        .payslip-header h3 {
            margin: 0 0 4px;
            font-size: 20px;
        }

        .payslip-header p {
            margin: 0;
            color: #666;
        }

        .payslip-employee {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .payslip-employee .info-row {
            display: flex;
            gap: 8px;
        }

        .payslip-employee .label {
            font-weight: 500;
            color: #666;
        }

        .payslip-employee .value {
            color: #333;
        }

        .payslip-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .payslip-details h4 {
            margin: 0 0 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .payslip-details table {
            width: 100%;
            border-collapse: collapse;
        }

        .payslip-details td {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .payslip-details .amount {
            text-align: right;
            font-family: monospace;
        }

        .payslip-details .total {
            font-weight: 600;
            border-top: 2px solid #000;
        }

        .payslip-details .total td {
            padding-top: 12px;
            border-bottom: none;
        }

        .payslip-net {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #000;
            color: #fff;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
        }

        .payslip-net .net-amount {
            font-family: monospace;
            font-size: 24px;
        }

        .components-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Version History Styles */
        .version-info-banner {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 16px;
            background: #e8f4fd;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
            color: #0066cc;
        }

        .version-info-banner svg {
            flex-shrink: 0;
            margin-top: 2px;
        }

        .current-version {
            background: #f0f9ff;
        }

        .badge-current {
            display: inline-block;
            padding: 2px 8px;
            background: #10b981;
            color: white;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
            text-transform: uppercase;
        }

        /* Version Component Selector */
        .version-components-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            padding: 8px 0;
        }

        .version-component-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .version-component-row:hover {
            background: #f0f4f8;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            flex: 1;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .component-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .component-badge.component-earning {
            background: #dcfce7;
            color: #166534;
        }

        .component-badge.component-deduction {
            background: #fee2e2;
            color: #991b1b;
        }

        .component-value-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .component-value-inputs select {
            width: 120px;
        }

        .component-value-inputs input {
            width: 100px;
            text-align: right;
        }

        .form-control-sm {
            padding: 6px 10px;
            font-size: 13px;
        }

        /* Text utilities */
        .text-muted {
            color: #6c757d;
        }

        .form-text {
            font-size: 12px;
            margin-top: 4px;
        }
    </style>
</body>
</html>
