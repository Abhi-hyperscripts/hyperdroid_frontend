<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenants - TenantManager</title>
    <script>window.CACHE_VERSION = Date.now();</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>document.write('<link rel="stylesheet" href="../../css/theme.css?v=' + CACHE_VERSION + '">');</script>
    <script>document.write('<link rel="stylesheet" href="../../css/styles.css?v=' + CACHE_VERSION + '">');</script>
    <script>document.write('<link rel="stylesheet" href="../../css/tooltip.css?v=' + CACHE_VERSION + '">');</script>
    <script>document.write('<link rel="stylesheet" href="../../css/tenant-manager.css?v=' + CACHE_VERSION + '">');</script>
    <style>
        /* Compact Tenant Modal Styles */
        #tenantModal .modal-body {
            padding: 16px;
        }
        #tenantModal .form-group {
            margin-bottom: 10px;
        }
        #tenantModal .form-label {
            margin-bottom: 4px;
            font-size: 12px;
        }
        #tenantModal .form-control {
            padding: 6px 10px;
            font-size: 13px;
        }
        #tenantModal textarea.form-control {
            min-height: 40px;
        }
        #tenantModal .form-hint {
            font-size: 10px;
            margin-top: 2px;
        }
        #tenantModal .form-row {
            gap: 12px;
        }
        #tenantModal .form-row-3 {
            gap: 10px;
        }

        /* Services Selection Section - Inline chips */
        .services-selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .services-selection-header .form-label {
            margin-bottom: 0;
        }
        .services-selection-header .select-all {
            font-size: 11px;
            color: var(--brand-primary);
            cursor: pointer;
        }
        .services-selection-header .select-all:hover {
            text-decoration: underline;
        }
        .services-inline {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .service-checkbox-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 12px;
            user-select: none;
        }
        .service-checkbox-item:hover {
            border-color: var(--brand-primary);
        }
        .service-checkbox-item input[type="checkbox"] {
            margin: 0;
            width: 12px;
            height: 12px;
            accent-color: var(--brand-primary);
        }
        .service-checkbox-item.checked {
            border-color: var(--brand-primary);
            background: var(--bg-selected);
        }
        .service-checkbox-item .service-name {
            font-weight: 500;
        }

        /* License Type Tabs */
        .license-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--border-primary);
        }
        .license-tab {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }
        .license-tab:hover {
            color: var(--text-primary);
        }
        .license-tab.active {
            color: var(--brand-primary);
        }
        .license-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--brand-primary);
        }
        .license-tab-icon {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            vertical-align: -3px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* SaaS Platform Card */
        .saas-platform-card {
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: visible;
        }
        .saas-platform-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            cursor: pointer;
        }
        .saas-platform-header:hover {
            background: var(--bg-hover);
        }
        .saas-platform-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .saas-platform-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--brand-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-inverse);
        }
        .saas-platform-details h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }
        .saas-platform-details p {
            margin: 2px 0 0;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .saas-platform-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .saas-platform-expand {
            transition: transform 0.2s;
        }
        .saas-platform-card.expanded .saas-platform-expand {
            transform: rotate(180deg);
        }
        .saas-tenants-container {
            border-top: 1px solid var(--border-primary);
            padding: 12px 16px;
            background: var(--bg-secondary);
        }
        .saas-tenants-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .saas-tenants-header h5 {
            margin: 0;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .saas-tenant-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            margin-bottom: 6px;
        }
        .saas-tenant-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .saas-tenant-info .tenant-name {
            font-weight: 500;
            font-size: 13px;
        }
        .saas-tenant-info .tenant-email {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .saas-tenant-meta {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .saas-tenant-meta .badge {
            font-size: 11px;
        }

        /* ==================== License Modal Styles ==================== */

        /* Compact License Modal Header */
        #licenseModal .modal-header-enhanced {
            padding: 16px 20px 12px;
            flex-direction: row;
            gap: 14px;
            align-items: flex-start;
            background: linear-gradient(180deg, var(--brand-primary-light) 0%, transparent 100%);
        }
        #licenseModal .modal-header-enhanced .modal-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            margin-bottom: 0;
            flex-shrink: 0;
        }
        #licenseModal .modal-header-enhanced .modal-icon svg {
            width: 22px;
            height: 22px;
        }
        #licenseModal .modal-header-enhanced .modal-title {
            font-size: 16px;
            text-align: left;
            margin: 0;
        }
        #licenseModal .modal-header-enhanced .modal-subtitle {
            text-align: left;
            font-size: 12px;
        }
        #licenseModal .modal-header-enhanced .close-btn {
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
        }

        /* Compact License Form Section */
        #licenseModal .license-form-section {
            padding: 12px 20px 16px;
        }

        /* Compact Tenant Card - Horizontal Bar Style */
        .license-tenant-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .tenant-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-bottom: none;
        }
        .tenant-card-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            border-radius: 6px;
            color: var(--brand-primary);
            flex-shrink: 0;
        }
        .tenant-card-icon svg {
            width: 18px;
            height: 18px;
        }
        .tenant-card-title {
            flex: 1;
            min-width: 0;
        }
        .tenant-card-title h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .tenant-card-org {
            font-size: 11px;
            color: var(--text-secondary);
        }
        .license-type-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            flex-shrink: 0;
        }
        .license-type-badge.badge-onpremise {
            background: var(--brand-primary-light);
            color: var(--brand-primary);
        }
        .license-type-badge.badge-platform {
            background: var(--color-info-light, var(--brand-primary-light));
            color: var(--color-info, var(--brand-primary));
        }
        .license-type-badge.badge-tenant {
            background: var(--color-success-light);
            color: var(--color-success);
        }
        /* Hide tenant details section - info already in header */
        .tenant-card-details {
            display: none;
        }
        .tenant-detail-row {
            display: flex;
            gap: 16px;
            margin-bottom: 8px;
        }
        .tenant-detail-row:last-child {
            margin-bottom: 0;
        }
        .tenant-detail-item {
            flex: 1;
        }
        .tenant-detail-item.full-width {
            flex: 100%;
        }
        .tenant-detail-item .detail-label {
            display: block;
            font-size: 10px;
            font-weight: 500;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        .tenant-detail-item .detail-value {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Date Inputs Row */
        .date-inputs-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .date-input-group {
            flex: 1;
        }
        .date-input-group label {
            display: block;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        .date-input-group input[type="date"] {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            font-size: 13px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        .duration-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 14px;
            background: var(--bg-selected);
            border-radius: 6px;
            min-width: 80px;
        }
        .duration-label {
            font-size: 10px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .duration-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--brand-primary);
        }

        /* Service Count Badge */
        .service-count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            margin-left: 8px;
            background: var(--brand-primary);
            color: white;
            border-radius: 9px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Service Chips - Compact Inline Style */
        #licenseServiceCheckboxes {
            display: flex !important;
            flex-wrap: wrap !important;
            flex-direction: row !important;
            gap: 8px;
            padding: 4px 0;
        }
        #licenseServiceCheckboxes .service-chip {
            display: inline-flex !important;
            align-items: center;
            gap: 6px;
            padding: 5px 10px 5px 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 12px;
            flex: 0 0 auto;
            width: auto !important;
            max-width: fit-content;
        }
        .service-chip:hover {
            border-color: var(--brand-primary);
            background: var(--bg-hover);
        }
        .service-chip:has(input:checked) {
            border-color: var(--brand-primary);
            background: var(--bg-selected);
        }
        .service-chip input[type="checkbox"] {
            display: none;
        }
        .chip-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        .chip-icon svg {
            width: 14px;
            height: 14px;
        }
        .service-chip:has(input:checked) .chip-icon {
            color: var(--brand-primary);
        }
        .chip-name {
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
        }
        .chip-check {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1.5px solid var(--border-secondary);
            border-radius: 50%;
            color: transparent;
            transition: all 0.15s;
            flex-shrink: 0;
            margin-left: 2px;
        }
        .service-chip:has(input:checked) .chip-check {
            border-color: var(--brand-primary);
            background: var(--brand-primary);
            color: white;
        }

        /* Empty Services Message */
        .empty-services-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px;
            text-align: center;
            color: var(--text-secondary);
        }
        .empty-services-message svg {
            margin-bottom: 8px;
            opacity: 0.5;
        }
        .empty-services-message p {
            margin: 0 0 8px 0;
            font-size: 13px;
        }
        .empty-services-message a {
            color: var(--brand-primary);
            font-size: 13px;
            text-decoration: none;
        }
        .empty-services-message a:hover {
            text-decoration: underline;
        }

        /* License Success Section */
        .license-success {
            display: none;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 24px 16px;
            animation: fadeInUp 0.3s ease;
        }
        .license-success.show {
            display: flex;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .success-icon-large {
            width: 64px;
            height: 64px;
            background: var(--gradient-success, linear-gradient(135deg, var(--color-success), var(--color-success-dark, var(--color-success))));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            color: var(--text-inverse);
            box-shadow: var(--shadow-success-sm, 0 4px 14px var(--color-success-shadow, rgba(0, 0, 0, 0.15)));
        }
        .success-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 6px 0;
        }
        .success-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 0 0 20px 0;
        }
        .license-info-summary {
            display: flex;
            gap: 32px;
            margin-bottom: 20px;
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }
        .license-info-summary .info-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .license-info-summary .label {
            font-size: 11px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .license-info-summary .value {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Token Container */
        .token-container {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 10px;
            overflow: hidden;
        }
        .token-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-primary);
        }
        .token-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .token-copy-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: var(--brand-primary);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        .token-copy-btn:hover {
            background: var(--brand-primary-hover);
            transform: translateY(-1px);
        }
        .token-copy-btn.copied {
            background: var(--color-success);
        }
        .token-value {
            padding: 14px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 11px;
            line-height: 1.5;
            color: var(--text-primary);
            word-break: break-all;
            max-height: 150px;
            overflow-y: auto;
            text-align: left;
            background: var(--bg-secondary);
        }
        .token-value::-webkit-scrollbar {
            width: 6px;
        }
        .token-value::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }
        .token-value::-webkit-scrollbar-thumb {
            background: var(--border-primary);
            border-radius: 3px;
        }

        /* License History Modal */
        .license-history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            padding: 4px;
        }
        .license-history-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 10px;
            padding: 16px;
            transition: all 0.15s;
        }
        .license-history-item:hover {
            border-color: var(--brand-primary);
            box-shadow: var(--shadow-sm);
        }
        .license-history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .license-history-date {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .license-history-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .license-history-badge.active {
            background: var(--color-success-light);
            color: var(--color-success);
        }
        .license-history-badge.expired {
            background: var(--color-danger-light);
            color: var(--color-danger);
        }
        .license-history-meta {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .license-history-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .license-history-token {
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .license-history-token-preview {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        .license-history-copy-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--brand-primary);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .license-history-copy-btn:hover {
            background: var(--brand-primary-hover);
        }
        .license-history-copy-btn.copied {
            background: var(--color-success);
        }
        .license-history-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            text-align: center;
            color: var(--text-secondary);
        }
        .license-history-empty svg {
            margin-bottom: 12px;
            opacity: 0.5;
        }
        .license-history-empty p {
            margin: 0;
            font-size: 14px;
        }
        .btn-icon-info {
            background: var(--color-info-light, var(--brand-primary-light));
            color: var(--color-info, var(--brand-primary));
        }
        .btn-icon-info:hover {
            background: var(--color-info-lighter, var(--brand-primary-lighter, var(--bg-hover)));
        }
    </style>
</head>
<body class="dashboard">
    <!-- Top Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">
            <a href="dashboard.html">
                <img src="../../assets/brand_logo.png" alt="HyperDroid Logo" class="navbar-logo">
            </a>
        </div>
        <div class="navbar-menu">
            <!-- Populated by TMNavigation.init() -->
        </div>
    </nav>

    <!-- App Container -->
    <div class="app-container" id="appContainer">
        <!-- App Header -->
        <div class="app-header">
            <div class="header-content">
                <nav class="breadcrumb-nav">
                    <a href="dashboard.html">Dashboard</a>
                    <span class="separator">/</span>
                    <span class="current">Tenants</span>
                </nav>
                <div class="app-header-row">
                    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle navigation menu">
                        <span class="hamburger-icon">
                            <span class="hamburger-line"></span>
                            <span class="hamburger-line"></span>
                            <span class="hamburger-line"></span>
                        </span>
                        <svg class="arrow-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 12H5"></path>
                            <path d="M12 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h1>License Management</h1>
                </div>
                <div class="active-tab-title" id="activeTabTitle">
                    <span class="tab-indicator"></span>
                    <span id="activeTabName">Tenants</span>
                </div>
            </div>
        </div>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar + Content Layout -->
        <div class="app-layout">
            <!-- Collapsible Sidebar Navigation -->
            <aside class="app-sidebar" id="appSidebar">
                <div class="sidebar-header">
                    <h3>TenantManager</h3>
                </div>
                <nav class="sidebar-nav">
                    <!-- Overview Section -->
                    <div class="nav-group" data-group="overview">
                        <div class="nav-group-header">
                            <span class="nav-group-title">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7"></rect>
                                    <rect x="14" y="3" width="7" height="7"></rect>
                                    <rect x="14" y="14" width="7" height="7"></rect>
                                    <rect x="3" y="14" width="7" height="7"></rect>
                                </svg>
                                Overview
                            </span>
                            <span class="chevron">&#9660;</span>
                        </div>
                        <div class="nav-group-items">
                            <button class="sidebar-btn" data-tab="dashboard" onclick="navigateTo('dashboard.html')">
                                <span class="nav-number">1</span><span class="nav-label">Dashboard</span>
                            </button>
                        </div>
                    </div>

                    <!-- Management Section -->
                    <div class="nav-group" data-group="management">
                        <div class="nav-group-header">
                            <span class="nav-group-title">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                Management
                            </span>
                            <span class="chevron">&#9660;</span>
                        </div>
                        <div class="nav-group-items">
                            <button class="sidebar-btn active" data-tab="tenants" onclick="navigateTo('tenants.html')">
                                <span class="nav-number">2</span><span class="nav-label">Tenants</span>
                            </button>
                            <button class="sidebar-btn" data-tab="services" onclick="navigateTo('services.html')">
                                <span class="nav-number">3</span><span class="nav-label">Services</span>
                            </button>
                        </div>
                    </div>

                    <!-- Tools Section -->
                    <div class="nav-group" data-group="tools">
                        <div class="nav-group-header">
                            <span class="nav-group-title">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                                Tools
                            </span>
                            <span class="chevron">&#9660;</span>
                        </div>
                        <div class="nav-group-items">
                            <button class="sidebar-btn" data-tab="verify" onclick="navigateTo('verify.html')">
                                <span class="nav-number">4</span><span class="nav-label">Verify License</span>
                            </button>
                        </div>
                    </div>
                </nav>
            </aside>

            <!-- Main Content Area -->
            <main class="app-content">
                <!-- Page Header with Tabs -->
                <div class="page-header">
                    <div>
                        <h2 class="page-title">License Management</h2>
                    </div>
                </div>

                <!-- License Type Tabs -->
                <div class="license-tabs">
                    <button class="license-tab active" onclick="switchLicenseTab('onpremise')" id="tabOnPremise">
                        <svg class="license-tab-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                        On-Premise Licenses
                    </button>
                    <button class="license-tab" onclick="switchLicenseTab('saas')" id="tabSaaS">
                        <svg class="license-tab-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                        </svg>
                        SaaS Platforms
                    </button>
                </div>

                <!-- On-Premise Tab Content -->
                <div class="tab-content active" id="contentOnPremise">
                    <!-- Filters Bar -->
                    <div class="filters-bar">
                        <div class="search-box">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <input type="text" id="searchInput" placeholder="Search licenses..." oninput="filterTenants()">
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <label class="checkbox-label">
                                <input type="checkbox" id="showInactive" onchange="loadTenants()">
                                <span>Show inactive</span>
                            </label>
                            <button class="btn btn-primary" onclick="openCreateTenantModal()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                New On-Premise License
                            </button>
                        </div>
                    </div>

                    <!-- On-Premise Licenses Table -->
                    <div class="card">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Tenant Name</th>
                                        <th>Company</th>
                                        <th>Max Users</th>
                                        <th>License Start</th>
                                        <th>License Expiry</th>
                                        <th>Keys</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tenantsTableBody">
                                    <tr>
                                        <td colspan="8" class="empty-state">
                                            <div class="empty-icon">
                                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                                    <line x1="8" y1="21" x2="16" y2="21"></line>
                                                    <line x1="12" y1="17" x2="12" y2="21"></line>
                                                </svg>
                                            </div>
                                            <p>Loading...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SaaS Platforms Tab Content -->
                <div class="tab-content" id="contentSaaS">
                    <!-- Filters Bar -->
                    <div class="filters-bar">
                        <div class="search-box">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <input type="text" id="searchSaaSInput" placeholder="Search platforms..." oninput="filterSaaSPlatforms()">
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <label class="checkbox-label">
                                <input type="checkbox" id="showInactiveSaaS" onchange="loadSaaSPlatforms()">
                                <span>Show inactive</span>
                            </label>
                            <button class="btn btn-primary" onclick="openCreateSaaSPlatformModal()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                New SaaS Platform
                            </button>
                        </div>
                    </div>

                    <!-- SaaS Platforms Table -->
                    <div class="card">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Platform Name</th>
                                        <th>Company</th>
                                        <th>Max Sub-Tenants</th>
                                        <th>License Start</th>
                                        <th>License Expiry</th>
                                        <th>Keys</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="saasPlatformsTableBody">
                                    <tr>
                                        <td colspan="8" class="empty-state">
                                            <div class="empty-icon">
                                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                                    <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                                                </svg>
                                            </div>
                                            <p>Loading SaaS platforms...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Create/Edit Tenant Modal -->
    <div id="tenantModal" class="modal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tenantModalTitle">Create Tenant</h5>
                    <button class="close-btn" onclick="closeModal('tenantModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="tenantForm">
                        <input type="hidden" id="tenantId">

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="tenantName">Tenant Name *</label>
                                <input type="text" id="tenantName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="companyName">Company Name</label>
                                <input type="text" id="companyName" class="form-control">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="contactEmail">Contact Email *</label>
                                <input type="email" id="contactEmail" class="form-control" required placeholder="admin@company.com">
                                <small class="form-hint">This becomes the SuperAdmin account</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="contactPhone">Contact Phone</label>
                                <input type="tel" id="contactPhone" class="form-control" placeholder="+1-234-567-8900">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="address">Address</label>
                            <input type="text" id="address" class="form-control" placeholder="City, Country">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="maxUsers">Max Users</label>
                            <input type="number" id="maxUsers" class="form-control" value="5" min="1">
                            <small class="form-hint">Maximum number of users for this license</small>
                        </div>

                        <!-- Services Selection (inline) -->
                        <div class="form-group">
                            <div class="services-selection-header">
                                <label class="form-label">Assigned Services</label>
                                <span class="select-all" onclick="toggleAllServices()">Select All</span>
                            </div>
                            <div class="services-inline" id="tenantServicesGrid">
                                <span class="text-muted" style="font-size: 12px;">Loading...</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="notes">Notes</label>
                            <textarea id="notes" class="form-control" rows="1" placeholder="Optional notes..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('tenantModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveTenant()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17 21 17 13 7 13 7 21"/>
                            <polyline points="7 3 7 8 15 8"/>
                        </svg>
                        Save Tenant
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tenant Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tenant Details</h5>
                    <button class="close-btn" onclick="closeModal('detailsModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body" id="detailsModalBody">
                    <div class="empty-state">
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generate License Modal - Enhanced Design -->
    <div id="licenseModal" class="modal">
        <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content">
                <!-- Enhanced Header -->
                <div class="modal-header-enhanced" id="licenseModalHeader">
                    <button class="close-btn" onclick="closeModal('licenseModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                    <div class="modal-icon" id="licenseModalIcon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                            <path d="M2 17l10 5 10-5"></path>
                            <path d="M2 12l10 5 10-5"></path>
                        </svg>
                    </div>
                    <h5 class="modal-title" id="licenseModalTitle">Generate License</h5>
                    <p class="modal-subtitle" id="licenseModalSubtitle">Configure license for this tenant</p>
                </div>

                <input type="hidden" id="licenseTenantId">
                <input type="hidden" id="licenseKeyType">
                <input type="hidden" id="licensePlatformId">

                <!-- License Form Section -->
                <div class="license-form-section" id="licenseFormSection">
                    <form id="licenseForm">
                        <!-- Tenant Information Card -->
                        <div class="license-tenant-card" id="licenseTenantCard">
                            <div class="tenant-card-header">
                                <div class="tenant-card-icon" id="licenseTenantIcon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                    </svg>
                                </div>
                                <div class="tenant-card-title">
                                    <h4 id="licenseTenantName">Loading...</h4>
                                    <span class="tenant-card-org" id="licenseTenantOrg"></span>
                                </div>
                                <span class="license-type-badge" id="licenseTypeBadge">On-Premise</span>
                            </div>
                            <div class="tenant-card-details">
                                <div class="tenant-detail-row">
                                    <div class="tenant-detail-item">
                                        <span class="detail-label">Admin Email</span>
                                        <span class="detail-value" id="licenseTenantEmail">-</span>
                                    </div>
                                    <div class="tenant-detail-item">
                                        <span class="detail-label">Max Users</span>
                                        <span class="detail-value" id="licenseTenantMaxUsers">-</span>
                                    </div>
                                </div>
                                <div class="tenant-detail-row" id="licensePlatformRow" style="display: none;">
                                    <div class="tenant-detail-item full-width">
                                        <span class="detail-label">Parent Platform</span>
                                        <span class="detail-value" id="licenseTenantPlatform">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- License Period Section -->
                        <div class="form-section-title">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            License Period
                        </div>
                        <div class="date-inputs-row">
                            <div class="date-input-group">
                                <label for="licenseStartDate">Start Date</label>
                                <input type="date" id="licenseStartDate" required>
                            </div>
                            <div class="date-input-group">
                                <label for="licenseExpiryDate">Expiry Date</label>
                                <input type="date" id="licenseExpiryDate" required>
                            </div>
                            <div class="duration-display">
                                <span class="duration-label">Duration</span>
                                <span class="duration-value" id="licenseDuration">365 days</span>
                            </div>
                        </div>

                        <!-- Service Selection Section -->
                        <div class="form-section-title" style="margin-top: 1rem;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                <path d="M2 17l10 5 10-5"></path>
                                <path d="M2 12l10 5 10-5"></path>
                            </svg>
                            Licensed Services
                            <span class="service-count-badge" id="licenseServiceCount">0</span>
                        </div>
                        <div class="service-checkboxes" id="licenseServiceCheckboxes">
                            <p class="text-muted">Loading services...</p>
                        </div>

                        <div class="form-group" style="margin-bottom: 0; margin-top: 1rem;">
                            <label class="form-label" for="licenseNotes">Notes (Optional)</label>
                            <textarea id="licenseNotes" class="form-control" rows="2" placeholder="Add any notes about this license..."></textarea>
                        </div>
                    </form>
                </div>

                <!-- Success Result Section -->
                <div class="license-success" id="licenseSuccessSection">
                    <div class="success-icon-large">
                        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                    <h3 class="success-title">License Generated!</h3>
                    <p class="success-subtitle">Your encrypted license token is ready to use</p>

                    <!-- License Info Summary -->
                    <div class="license-info-summary">
                        <div class="info-item">
                            <span class="label">Valid From</span>
                            <span class="value" id="successStartDate">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Valid Until</span>
                            <span class="value" id="successExpiryDate">-</span>
                        </div>
                    </div>

                    <!-- Token Display -->
                    <div class="token-container">
                        <div class="token-header">
                            <span class="token-label">License Token</span>
                            <button class="token-copy-btn" id="tokenCopyBtn" onclick="copyLicenseToken()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                                <span>Copy</span>
                            </button>
                        </div>
                        <div class="token-value" id="licenseToken"></div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="modal-footer-enhanced">
                    <button class="btn btn-primary" id="generateLicenseBtn" onclick="generateLicense()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                            <path d="M2 17l10 5 10-5"></path>
                            <path d="M2 12l10 5 10-5"></path>
                        </svg>
                        Generate License Token
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit SaaS Platform Modal -->
    <div id="saasPlatformModal" class="modal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saasPlatformModalTitle">Create SaaS Platform</h5>
                    <button class="close-btn" onclick="closeModal('saasPlatformModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="saasPlatformForm">
                        <input type="hidden" id="saasPlatformId">

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="saasPlatformName">Platform Name *</label>
                                <input type="text" id="saasPlatformName" class="form-control" required placeholder="e.g., CloudSuite Pro">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="saasCompanyName">Company Name</label>
                                <input type="text" id="saasCompanyName" class="form-control" placeholder="e.g., TechCorp Inc">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="saasContactEmail">Platform Admin Email *</label>
                                <input type="email" id="saasContactEmail" class="form-control" required placeholder="admin@platform.com">
                                <small class="form-hint">This becomes the Platform SuperAdmin</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="saasContactPhone">Contact Phone</label>
                                <input type="tel" id="saasContactPhone" class="form-control" placeholder="+1-234-567-8900">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="saasAddress">Address</label>
                            <input type="text" id="saasAddress" class="form-control" placeholder="City, Country">
                        </div>

                        <!-- Services Selection (inline) -->
                        <div class="form-group">
                            <div class="services-selection-header">
                                <label class="form-label">Available Services</label>
                                <span class="select-all" onclick="toggleAllSaaSServices()">Select All</span>
                            </div>
                            <div class="services-inline" id="saasServicesGrid">
                                <span class="text-muted" style="font-size: 12px;">Loading...</span>
                            </div>
                            <small class="form-hint">Services that tenants on this platform can use</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="saasNotes">Notes</label>
                            <textarea id="saasNotes" class="form-control" rows="1" placeholder="Optional notes..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('saasPlatformModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveSaaSPlatform()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17 21 17 13 7 13 7 21"/>
                            <polyline points="7 3 7 8 15 8"/>
                        </svg>
                        Save Platform
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Sub-Tenant Modal -->
    <div id="subTenantModal" class="modal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="subTenantModalTitle">Add Tenant</h5>
                    <button class="close-btn" onclick="closeModal('subTenantModal')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="subTenantForm">
                        <input type="hidden" id="subTenantId">
                        <input type="hidden" id="parentPlatformId">

                        <div class="form-group">
                            <label class="form-label" for="subTenantName">Tenant Name *</label>
                            <input type="text" id="subTenantName" class="form-control" required placeholder="e.g., ABC Solutions">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="subTenantEmail">Admin Email *</label>
                                <input type="email" id="subTenantEmail" class="form-control" required placeholder="admin@tenant.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="subTenantMaxUsers">Max Users</label>
                                <input type="number" id="subTenantMaxUsers" class="form-control" value="10" min="1">
                            </div>
                        </div>

                        <!-- Services Selection -->
                        <div class="form-group">
                            <div class="services-selection-header">
                                <label class="form-label">Assigned Services</label>
                                <span class="select-all" onclick="toggleAllSubTenantServices()">Select All</span>
                            </div>
                            <div class="services-inline" id="subTenantServicesGrid">
                                <span class="text-muted" style="font-size: 12px;">Loading...</span>
                            </div>
                            <small class="form-hint">Services available from the parent platform</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('subTenantModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveSubTenant()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17 21 17 13 7 13 7 21"/>
                            <polyline points="7 3 7 8 15 8"/>
                        </svg>
                        Save Tenant
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- License History Modal -->
    <div id="licenseHistoryModal" class="modal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                    </div>
                    <div>
                        <h5 class="modal-title">License History</h5>
                        <p class="modal-subtitle" id="licenseHistoryTenantName">-</p>
                    </div>
                    <button class="close-btn" onclick="closeModal('licenseHistoryModal')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="modal-body" id="licenseHistoryContent">
                    <div class="loading-spinner">
                        <svg class="spinner" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="2" x2="12" y2="6"></line>
                            <line x1="12" y1="18" x2="12" y2="22"></line>
                            <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
                            <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
                            <line x1="2" y1="12" x2="6" y2="12"></line>
                            <line x1="18" y1="12" x2="22" y2="12"></line>
                            <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
                            <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
                        </svg>
                        <p>Loading licenses...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('licenseHistoryModal')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../../js/theme.js"></script>
    <script src="../../js/toast.js"></script>
    <script src="../../js/tenant-manager/config.js"></script>
    <script src="../../js/tenant-manager/api.js"></script>
    <script src="../../js/tenant-manager/navigation.js"></script>
    <script>
        // Check authentication
        if (!api.isAuthenticated()) {
            window.location.href = 'login.html';
        }

        // Initialize navigation
        TMNavigation.init('tenants');

        // Sidebar toggle functionality
        const sidebarToggle = document.getElementById('sidebarToggle');
        const appContainer = document.getElementById('appContainer');
        const appSidebar = document.getElementById('appSidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        // Check saved state or default to open on desktop
        function initSidebar() {
            const savedState = localStorage.getItem('sidebarOpen');
            const isDesktop = window.innerWidth > 768;

            // Default to open on desktop, closed on mobile (unless saved state exists)
            const shouldBeOpen = savedState !== null ? savedState === 'true' : isDesktop;

            if (shouldBeOpen) {
                appContainer.classList.add('sidebar-open');
                appSidebar.classList.add('open');
            }
        }

        // Initialize sidebar state
        initSidebar();

        sidebarToggle.addEventListener('click', () => {
            const isOpen = appContainer.classList.toggle('sidebar-open');
            appSidebar.classList.toggle('open');
            localStorage.setItem('sidebarOpen', isOpen);
        });

        sidebarOverlay.addEventListener('click', () => {
            appContainer.classList.remove('sidebar-open');
            appSidebar.classList.remove('open');
            localStorage.setItem('sidebarOpen', 'false');
        });

        // Navigation
        function navigateTo(page) {
            window.location.href = page;
        }

        let allTenants = [];
        let allSaaSPlatforms = [];
        let availableServices = [];
        let currentTab = 'onpremise';

        // Tab Switching
        function switchLicenseTab(tab) {
            currentTab = tab;

            // Update tab buttons
            document.querySelectorAll('.license-tab').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tab === 'onpremise' ? 'tabOnPremise' : 'tabSaaS').classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab === 'onpremise' ? 'contentOnPremise' : 'contentSaaS').classList.add('active');

            // Load data for the active tab
            if (tab === 'onpremise') {
                loadTenants();
            } else {
                loadSaaSPlatforms();
            }
        }

        // Load available services for tenant form
        async function loadAvailableServices(selectedServiceIds = []) {
            const grid = document.getElementById('tenantServicesGrid');
            grid.innerHTML = '<p class="text-muted" style="grid-column: 1 / -1; text-align: center; font-size: 12px;">Loading services...</p>';

            try {
                const { services } = await api.getServices();
                availableServices = services.filter(s => s.isActive);

                if (availableServices.length === 0) {
                    grid.innerHTML = '<p class="text-muted" style="grid-column: 1 / -1; text-align: center; font-size: 12px;">No services available</p>';
                    return;
                }

                grid.innerHTML = availableServices.map(service => {
                    const isChecked = selectedServiceIds.includes(service.id);
                    return `
                        <label class="service-checkbox-item ${isChecked ? 'checked' : ''}" data-service-id="${service.id}">
                            <input type="checkbox" name="tenantService" value="${service.id}" ${isChecked ? 'checked' : ''} onchange="toggleServiceCheckbox(this)">
                            <span class="service-name">${service.serviceName}</span>
                        </label>
                    `;
                }).join('');
            } catch (error) {
                grid.innerHTML = '<p class="text-danger" style="grid-column: 1 / -1; text-align: center; font-size: 12px;">Failed to load services</p>';
                console.error('Error loading services:', error);
            }
        }

        function toggleServiceCheckbox(checkbox) {
            const item = checkbox.closest('.service-checkbox-item');
            if (checkbox.checked) {
                item.classList.add('checked');
            } else {
                item.classList.remove('checked');
            }
        }

        function toggleAllServices() {
            const checkboxes = document.querySelectorAll('#tenantServicesGrid input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
                toggleServiceCheckbox(cb);
            });

            // Update button text
            const btn = document.querySelector('.services-selection-header .select-all');
            btn.textContent = allChecked ? 'Select All' : 'Deselect All';
        }

        // Load On-Premise tenants (filter by deploymentType = 'on-premise' and no parent)
        async function loadTenants() {
            const includeInactive = document.getElementById('showInactive').checked;

            try {
                const { tenants } = await api.getTenants(includeInactive);
                // Filter to only show on-premise tenants (no parent_tenant_id)
                allTenants = tenants.filter(t => t.deploymentType === 'on-premise' && !t.parentTenantId);
                renderTenants(allTenants);
            } catch (error) {
                console.error('Failed to load tenants:', error);
            }
        }

        function filterTenants() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allTenants.filter(t =>
                t.tenantName.toLowerCase().includes(search) ||
                (t.companyName && t.companyName.toLowerCase().includes(search)) ||
                (t.contactEmail && t.contactEmail.toLowerCase().includes(search))
            );
            renderTenants(filtered);
        }

        function renderTenants(tenants) {
            const tbody = document.getElementById('tenantsTableBody');

            if (tenants.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div class="empty-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                    <line x1="8" y1="21" x2="16" y2="21"></line>
                                    <line x1="12" y1="17" x2="12" y2="21"></line>
                                </svg>
                            </div>
                            <p>No on-premise licenses found. Click "New On-Premise License" to create one.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = tenants.map(tenant => {
                // Get license dates from activeLicense if available
                const activeLicense = tenant.activeLicense;
                const licenseStart = activeLicense?.startDate ? new Date(activeLicense.startDate) : null;
                const licenseExpiry = activeLicense?.expiryDate ? new Date(activeLicense.expiryDate) : null;
                const licenseToken = activeLicense?.encryptedToken || null;
                const now = new Date();

                let licenseStatus = '';
                let licenseStatusClass = '';
                if (licenseExpiry) {
                    if (licenseExpiry < now) {
                        licenseStatus = 'Expired';
                        licenseStatusClass = 'badge-danger';
                    } else if (licenseStart && licenseStart > now) {
                        licenseStatus = 'Pending';
                        licenseStatusClass = 'badge-warning';
                    } else {
                        licenseStatus = 'Active';
                        licenseStatusClass = 'badge-success';
                    }
                }

                return `
                <tr>
                    <td><strong>${tenant.tenantName}</strong></td>
                    <td>${tenant.companyName || '-'}</td>
                    <td>${tenant.maxUsers}</td>
                    <td>${licenseStart ? licenseStart.toLocaleDateString() : '<span class="text-muted">No license</span>'}</td>
                    <td>
                        ${licenseExpiry ? `
                            <span class="license-expiry ${licenseStatusClass ? 'has-status' : ''}">
                                ${licenseExpiry.toLocaleDateString()}
                                ${licenseStatus ? `<span class="badge badge-sm ${licenseStatusClass}">${licenseStatus}</span>` : ''}
                            </span>
                        ` : '<span class="text-muted">No license</span>'}
                    </td>
                    <td>
                        <div class="keys-group">
                            <button class="btn-icon-sm btn-icon-key" onclick="copyToClipboard('${tenant.id}', 'Tenant Key')" data-tooltip="Copy Tenant Key">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
                                </svg>
                            </button>
                            ${licenseToken ? `
                                <button class="btn-icon-sm btn-icon-license" onclick="copyToClipboard('${escapeHtml(licenseToken)}', 'License Token')" data-tooltip="Copy License Token">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                        <path d="M2 17l10 5 10-5"></path>
                                        <path d="M2 12l10 5 10-5"></path>
                                    </svg>
                                </button>
                            ` : '<span class="text-muted text-xs">No license</span>'}
                        </div>
                    </td>
                    <td>
                        <span class="badge ${tenant.isActive ? 'badge-success' : 'badge-danger'}">
                            ${tenant.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon-sm" onclick="viewTenantDetails('${tenant.id}')" data-tooltip="View Details" data-tooltip-position="top">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                            <button class="btn-icon-sm" onclick="openEditTenantModal('${tenant.id}')" data-tooltip="Edit Tenant" data-tooltip-position="top">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="btn-icon-sm btn-icon-info" onclick="openLicenseHistoryModal('${tenant.id}', '${tenant.tenantName}')" data-tooltip="View Licenses" data-tooltip-position="top">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                            </button>
                            <button class="btn-icon-sm btn-icon-success" onclick="openLicenseModal('${tenant.id}')" data-tooltip="Generate License" data-tooltip-position="top">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                    <path d="M2 17l10 5 10-5"></path>
                                    <path d="M2 12l10 5 10-5"></path>
                                </svg>
                            </button>
                            ${tenant.isActive ? `
                                <button class="btn-icon-sm btn-icon-danger" onclick="deleteTenant('${tenant.id}')" data-tooltip="Deactivate" data-tooltip-position="top">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        function copyToClipboard(text, label) {
            navigator.clipboard.writeText(text).then(() => {
                showToast(`${label} copied to clipboard`, 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function openCreateTenantModal() {
            document.getElementById('tenantModalTitle').textContent = 'New On-Premise License';
            document.getElementById('tenantForm').reset();
            document.getElementById('tenantId').value = '';
            // Reset select all button text
            const selectAllBtn = document.querySelector('#tenantModal .services-selection-header .select-all');
            if (selectAllBtn) selectAllBtn.textContent = 'Select All';
            // Load services with none selected
            await loadAvailableServices([]);
            openModal('tenantModal');
        }

        async function openEditTenantModal(tenantId) {
            try {
                const tenant = await api.getTenant(tenantId);
                document.getElementById('tenantModalTitle').textContent = 'Edit On-Premise License';
                document.getElementById('tenantId').value = tenant.id;
                document.getElementById('tenantName').value = tenant.tenantName;
                document.getElementById('companyName').value = tenant.companyName || '';
                document.getElementById('contactEmail').value = tenant.contactEmail || '';
                document.getElementById('contactPhone').value = tenant.contactPhone || '';
                document.getElementById('address').value = tenant.address || '';
                document.getElementById('maxUsers').value = tenant.maxUsers;
                document.getElementById('notes').value = tenant.notes || '';

                // Load tenant's services
                const tenantServices = await api.getTenantServices(tenantId);
                const selectedServiceIds = tenantServices.map(s => s.serviceId);
                await loadAvailableServices(selectedServiceIds);

                // Update select all button text based on selection
                const allSelected = selectedServiceIds.length === availableServices.length && availableServices.length > 0;
                document.querySelector('.services-selection-header .select-all').textContent = allSelected ? 'Deselect All' : 'Select All';

                openModal('tenantModal');
            } catch (error) {
                Toast.error('Failed to load tenant: ' + error.message);
            }
        }

        async function saveTenant() {
            const tenantId = document.getElementById('tenantId').value;

            // Get selected services
            const selectedServiceIds = Array.from(
                document.querySelectorAll('#tenantServicesGrid input[type="checkbox"]:checked')
            ).map(cb => cb.value);

            const contactEmail = document.getElementById('contactEmail').value;
            const tenantData = {
                tenantName: document.getElementById('tenantName').value,
                companyName: document.getElementById('companyName').value || null,
                contactEmail: contactEmail || null,
                contactPhone: document.getElementById('contactPhone').value || null,
                address: document.getElementById('address').value || null,
                deploymentType: 'on-premise',  // Always on-premise for this form
                maxUsers: parseInt(document.getElementById('maxUsers').value),
                superAdminEmail: contactEmail || null,
                notes: document.getElementById('notes').value || null,
                serviceIds: selectedServiceIds
            };

            try {
                if (tenantId) {
                    await api.updateTenant(tenantId, tenantData);
                } else {
                    await api.createTenant(tenantData);
                }
                closeModal('tenantModal');
                loadTenants();
                Toast.success('On-premise license saved successfully');
            } catch (error) {
                Toast.error('Failed to save license: ' + error.message);
            }
        }

        async function deleteTenant(tenantId) {
            const confirmed = await Confirm.danger(
                'Are you sure you want to deactivate this tenant? This action cannot be undone.',
                'Deactivate Tenant'
            );
            if (!confirmed) return;

            try {
                await api.deleteTenant(tenantId);
                loadTenants();
                Toast.success('Tenant deactivated successfully');
            } catch (error) {
                Toast.error('Failed to delete tenant: ' + error.message);
            }
        }

        async function viewTenantDetails(tenantId) {
            try {
                const details = await api.getTenantDetails(tenantId);
                const services = details.services || [];
                const features = details.features || [];
                const licenses = details.licenses || [];

                // Get license info
                let licenseHtml = '<span class="text-muted">No license</span>';
                if (licenses.length > 0) {
                    const latest = licenses[0];
                    const now = new Date();
                    const start = new Date(latest.startDate);
                    const expiry = new Date(latest.expiryDate);
                    let status = 'Active', statusClass = 'badge-success';
                    if (expiry < now) { status = 'Expired'; statusClass = 'badge-danger'; }
                    else if (start > now) { status = 'Pending'; statusClass = 'badge-warning'; }
                    licenseHtml = `<span class="badge ${statusClass}">${status}</span> ${start.toLocaleDateString()}  ${expiry.toLocaleDateString()}`;
                }

                const modalBody = document.getElementById('detailsModalBody');
                modalBody.innerHTML = `
                    <div class="tenant-card">
                        <div class="tenant-card-header">
                            <div class="tenant-name-row">
                                <span class="tenant-name">${details.tenant.tenantName}</span>
                                <span class="badge ${details.tenant.deploymentType === 'saas' ? 'badge-primary' : 'badge-warning'}">${details.tenant.deploymentType}</span>
                            </div>
                            ${details.tenant.companyName ? `<span class="tenant-company">${details.tenant.companyName}</span>` : ''}
                        </div>
                        <div class="tenant-card-body">
                            <div class="tenant-meta">
                                <span title="Email">${details.tenant.contactEmail || '-'}</span>
                                <span class="meta-sep"></span>
                                <span title="Phone">${details.tenant.contactPhone || '-'}</span>
                                <span class="meta-sep"></span>
                                <span title="Max Users">${details.tenant.maxUsers} users</span>
                                ${details.tenant.superAdminEmail && details.tenant.superAdminEmail !== details.tenant.contactEmail ?
                                    `<span class="meta-sep"></span><span title="SuperAdmin">${details.tenant.superAdminEmail}</span>` : ''}
                            </div>
                            <div class="tenant-services">
                                ${services.length > 0 ? services.map(s => {
                                    const name = s.service?.serviceName || s.serviceName || '?';
                                    const canRead = s.service?.canRead ?? s.canRead;
                                    const canWrite = s.service?.canWrite ?? s.canWrite;
                                    return `<span class="svc-tag">${name}<sup>${canRead ? 'R' : ''}${canWrite ? 'W' : ''}</sup></span>`;
                                }).join('') : '<span class="text-muted">No services</span>'}
                            </div>
                            ${features.length > 0 ? `
                            <div class="tenant-features">
                                ${features.map(f => `<span class="feat-tag">${f.featureName}</span>`).join('')}
                            </div>` : ''}
                            <div class="tenant-license">${licenseHtml}</div>
                        </div>
                    </div>
                `;

                openModal('detailsModal');
            } catch (error) {
                Toast.error('Failed to load tenant details: ' + error.message);
            }
        }

        // Store tenant data for license modal
        let currentTenantName = '';
        let currentTenantServices = [];
        let currentTenantData = null;

        async function openLicenseModal(tenantId) {
            document.getElementById('licenseTenantId').value = tenantId;

            // Reset modal state to form view
            document.getElementById('licenseFormSection').style.display = 'block';
            document.getElementById('licenseSuccessSection').classList.remove('show');
            document.getElementById('generateLicenseBtn').style.display = 'inline-flex';

            // Reset header to form state
            document.getElementById('licenseModalTitle').textContent = 'Generate License';
            document.getElementById('licenseModalSubtitle').textContent = 'Configure license for this tenant';
            document.getElementById('licenseModalIcon').classList.remove('success');
            document.getElementById('licenseModalIcon').innerHTML = `
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                    <path d="M2 17l10 5 10-5"></path>
                    <path d="M2 12l10 5 10-5"></path>
                </svg>
            `;

            // Show loading state in tenant card
            document.getElementById('licenseTenantName').textContent = 'Loading...';
            document.getElementById('licenseTenantOrg').textContent = '';
            document.getElementById('licenseTenantEmail').textContent = '-';
            document.getElementById('licenseTenantMaxUsers').textContent = '-';
            document.getElementById('licensePlatformRow').style.display = 'none';

            // Open modal immediately with loading state
            openModal('licenseModal');

            try {
                // Fetch tenant details by ID (works for both platforms and sub-tenants)
                const tenant = await api.getTenant(tenantId);
                currentTenantData = tenant;
                currentTenantName = tenant.tenantName;

                // Populate tenant info card
                document.getElementById('licenseTenantName').textContent = tenant.tenantName;
                document.getElementById('licenseTenantOrg').textContent = tenant.organizationName || tenant.companyName || '';
                document.getElementById('licenseTenantEmail').textContent = tenant.superAdminEmail || tenant.contactEmail || '-';
                document.getElementById('licenseTenantMaxUsers').textContent = tenant.maxUsers === -1 ? 'Unlimited' : (tenant.maxUsers || 5);

                // Determine license key type and update badge
                let keyType, badgeClass, badgeText, iconSvg;

                if (tenant.parentTenantId) {
                    // This is a sub-tenant under a SaaS platform
                    keyType = 'saas-tenant';
                    badgeClass = 'badge-tenant';
                    badgeText = 'SaaS Tenant';
                    iconSvg = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>`;

                    // Show parent platform info
                    document.getElementById('licensePlatformRow').style.display = 'block';
                    document.getElementById('licensePlatformId').value = tenant.parentTenantId;

                    // Fetch parent platform name
                    try {
                        const parentPlatform = await api.getTenant(tenant.parentTenantId);
                        document.getElementById('licenseTenantPlatform').textContent = parentPlatform.tenantName;
                    } catch (e) {
                        document.getElementById('licenseTenantPlatform').textContent = 'Unknown Platform';
                    }
                } else if (tenant.deploymentType === 'saas' || tenant.canCreateSubTenants) {
                    // This is a SaaS platform
                    keyType = 'saas-platform';
                    badgeClass = 'badge-platform';
                    badgeText = 'SaaS Platform';
                    iconSvg = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                        <line x1="8" y1="21" x2="16" y2="21"></line>
                        <line x1="12" y1="17" x2="12" y2="21"></line>
                    </svg>`;
                    document.getElementById('licensePlatformRow').style.display = 'none';
                    document.getElementById('licensePlatformId').value = '';
                } else {
                    // On-premise license
                    keyType = 'on-premise';
                    badgeClass = 'badge-onpremise';
                    badgeText = 'On-Premise';
                    iconSvg = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>`;
                    document.getElementById('licensePlatformRow').style.display = 'none';
                    document.getElementById('licensePlatformId').value = '';
                }

                document.getElementById('licenseKeyType').value = keyType;
                const badge = document.getElementById('licenseTypeBadge');
                badge.textContent = badgeText;
                badge.className = 'license-type-badge ' + badgeClass;
                document.getElementById('licenseTenantIcon').innerHTML = iconSvg;

            } catch (error) {
                console.error('Error fetching tenant:', error);
                document.getElementById('licenseTenantName').textContent = 'Error loading tenant';
                Toast.error('Failed to load tenant information');
            }

            // Set default dates
            const today = new Date();
            const oneYearLater = new Date();
            oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);

            document.getElementById('licenseStartDate').value = today.toISOString().split('T')[0];
            document.getElementById('licenseExpiryDate').value = oneYearLater.toISOString().split('T')[0];
            document.getElementById('licenseNotes').value = '';

            // Update duration display
            updateLicenseDuration();

            // Add date change listeners
            document.getElementById('licenseStartDate').addEventListener('change', updateLicenseDuration);
            document.getElementById('licenseExpiryDate').addEventListener('change', updateLicenseDuration);

            // Load tenant services
            await loadTenantServicesForLicense(tenantId);
        }

        async function loadTenantServicesForLicense(tenantId) {
            const container = document.getElementById('licenseServiceCheckboxes');
            const countBadge = document.getElementById('licenseServiceCount');
            container.innerHTML = '<p class="text-muted">Loading services...</p>';
            countBadge.textContent = '0';

            try {
                const services = await api.getTenantServices(tenantId);
                currentTenantServices = services;

                if (services.length === 0) {
                    container.innerHTML = `
                        <div class="empty-services-message">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M16 16s-1.5-2-4-2-4 2-4 2"></path>
                                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                <line x1="15" y1="9" x2="15.01" y2="9"></line>
                            </svg>
                            <p>No services assigned to this tenant.</p>
                            <a href="javascript:void(0)" onclick="closeModal('licenseModal'); viewTenantDetails('${tenantId}')">
                                Assign services first 
                            </a>
                        </div>
                    `;
                    document.getElementById('generateLicenseBtn').disabled = true;
                    return;
                }

                countBadge.textContent = services.length;
                document.getElementById('generateLicenseBtn').disabled = false;

                container.innerHTML = services.map(service => `
                    <label class="service-chip" data-service-id="${service.serviceId}">
                        <input type="checkbox" name="licenseService" value="${service.serviceId}" checked onchange="updateLicenseServiceCount()">
                        <span class="chip-icon">${getServiceIcon(service.serviceName)}</span>
                        <span class="chip-name">${service.serviceName}</span>
                        <span class="chip-check">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </span>
                    </label>
                `).join('');
            } catch (error) {
                container.innerHTML = '<p class="text-danger">Failed to load services</p>';
                console.error('Error loading services:', error);
            }
        }

        function getServiceIcon(serviceName) {
            const icons = {
                'Vision': `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="23 7 16 12 23 17 23 7"></polygon>
                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                </svg>`,
                'Drive': `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                </svg>`,
                'HRMS': `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>`,
                'Chat': `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>`,
                'Authentication': `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>`
            };
            return icons[serviceName] || `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
            </svg>`;
        }

        function updateLicenseServiceCount() {
            const checked = document.querySelectorAll('input[name="licenseService"]:checked').length;
            document.getElementById('licenseServiceCount').textContent = checked;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateLicenseDuration() {
            const startDate = document.getElementById('licenseStartDate').value;
            const expiryDate = document.getElementById('licenseExpiryDate').value;

            if (startDate && expiryDate) {
                const start = new Date(startDate);
                const end = new Date(expiryDate);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                let durationText = '';
                if (diffDays >= 365) {
                    const years = Math.floor(diffDays / 365);
                    const remainingDays = diffDays % 365;
                    durationText = `${years} year${years > 1 ? 's' : ''}`;
                    if (remainingDays > 0) {
                        durationText += ` ${remainingDays} day${remainingDays > 1 ? 's' : ''}`;
                    }
                } else if (diffDays >= 30) {
                    const months = Math.floor(diffDays / 30);
                    const remainingDays = diffDays % 30;
                    durationText = `${months} month${months > 1 ? 's' : ''}`;
                    if (remainingDays > 0) {
                        durationText += ` ${remainingDays} day${remainingDays > 1 ? 's' : ''}`;
                    }
                } else {
                    durationText = `${diffDays} day${diffDays > 1 ? 's' : ''}`;
                }

                document.getElementById('licenseDuration').textContent = durationText;
            }
        }

        async function generateLicense() {
            const tenantId = document.getElementById('licenseTenantId').value;
            const startDate = document.getElementById('licenseStartDate').value;
            const expiryDate = document.getElementById('licenseExpiryDate').value;
            const notes = document.getElementById('licenseNotes').value;
            const keyType = document.getElementById('licenseKeyType').value || 'on-premise';
            const platformId = document.getElementById('licensePlatformId').value || null;

            // Get selected service IDs
            const selectedServiceIds = Array.from(
                document.querySelectorAll('input[name="licenseService"]:checked')
            ).map(cb => cb.value);

            if (selectedServiceIds.length === 0) {
                Toast.error('Please select at least one service for the license');
                return;
            }

            // Disable button and show loading
            const btn = document.getElementById('generateLicenseBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `
                <svg class="spinner" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="2" x2="12" y2="6"></line>
                    <line x1="12" y1="18" x2="12" y2="22"></line>
                    <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
                    <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
                    <line x1="2" y1="12" x2="6" y2="12"></line>
                    <line x1="18" y1="12" x2="22" y2="12"></line>
                    <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
                    <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
                </svg>
                Generating...
            `;

            try {
                const result = await api.generateLicense(tenantId, startDate, expiryDate, notes, selectedServiceIds, keyType, platformId);

                // Update token display
                document.getElementById('licenseToken').textContent = result.encryptedToken;

                // Update summary dates
                document.getElementById('successStartDate').textContent = new Date(startDate).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric'
                });
                document.getElementById('successExpiryDate').textContent = new Date(expiryDate).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric'
                });

                // Switch to success view
                document.getElementById('licenseFormSection').style.display = 'none';
                document.getElementById('licenseSuccessSection').classList.add('show');
                document.getElementById('generateLicenseBtn').style.display = 'none';

                // Update header to success state
                document.getElementById('licenseModalTitle').textContent = 'License Generated';
                document.getElementById('licenseModalSubtitle').textContent = `License for ${currentTenantName}`;
                document.getElementById('licenseModalIcon').classList.add('success');
                document.getElementById('licenseModalIcon').innerHTML = `
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                `;

                // Reset copy button state
                const copyBtn = document.getElementById('tokenCopyBtn');
                copyBtn.classList.remove('copied');
                copyBtn.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    <span>Copy</span>
                `;

                loadTenants();
            } catch (error) {
                Toast.error('Failed to generate license: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function copyLicenseToken() {
            const token = document.getElementById('licenseToken').textContent;
            const copyBtn = document.getElementById('tokenCopyBtn');

            navigator.clipboard.writeText(token).then(() => {
                // Show copied state
                copyBtn.classList.add('copied');
                copyBtn.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    <span>Copied!</span>
                `;

                // Reset after 2 seconds
                setTimeout(() => {
                    copyBtn.classList.remove('copied');
                    copyBtn.innerHTML = `
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        <span>Copy</span>
                    `;
                }, 2000);
            });
        }

        // ============================================
        // LICENSE HISTORY FUNCTIONS
        // ============================================

        async function openLicenseHistoryModal(tenantId, tenantName) {
            // Set tenant name in header
            document.getElementById('licenseHistoryTenantName').textContent = tenantName;

            // Show loading state
            const content = document.getElementById('licenseHistoryContent');
            content.innerHTML = `
                <div class="loading-spinner">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spinner">
                        <line x1="12" y1="2" x2="12" y2="6"></line>
                        <line x1="12" y1="18" x2="12" y2="22"></line>
                        <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
                        <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
                        <line x1="2" y1="12" x2="6" y2="12"></line>
                        <line x1="18" y1="12" x2="22" y2="12"></line>
                        <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
                        <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
                    </svg>
                    <p>Loading license history...</p>
                </div>
            `;

            // Open modal
            openModal('licenseHistoryModal');

            try {
                const response = await api.getTenantLicenses(tenantId);
                // Handle both array response and object with licenses property
                const licenses = Array.isArray(response) ? response : (response?.licenses || []);

                if (!licenses || licenses.length === 0) {
                    content.innerHTML = `
                        <div class="empty-state" style="text-align: center; padding: 40px 20px;">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--text-tertiary)" stroke-width="1.5" style="margin-bottom: 16px;">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                            <h4 style="color: var(--text-secondary); margin-bottom: 8px;">No Licenses Generated</h4>
                            <p style="color: var(--text-tertiary); font-size: 13px;">
                                This tenant doesn't have any licenses yet.<br>
                                Generate a license to get started.
                            </p>
                        </div>
                    `;
                    return;
                }

                // Sort by creation date (newest first)
                licenses.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                content.innerHTML = `
                    <div class="license-history-list">
                        ${licenses.map((license, index) => {
                            const startDate = new Date(license.startDate);
                            const expiryDate = new Date(license.expiryDate);
                            const now = new Date();
                            const isExpired = now > expiryDate;
                            const isNotStarted = now < startDate;

                            let status = 'active';
                            let statusText = 'Active';
                            if (isExpired) {
                                status = 'expired';
                                statusText = 'Expired';
                            } else if (isNotStarted) {
                                status = 'pending';
                                statusText = 'Not Started';
                            }

                            // Calculate duration
                            const diffTime = Math.abs(expiryDate - startDate);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            let durationText = diffDays + ' days';
                            if (diffDays >= 365) {
                                const years = Math.floor(diffDays / 365);
                                const months = Math.floor((diffDays % 365) / 30);
                                durationText = years + (years === 1 ? ' year' : ' years');
                                if (months > 0) durationText += ', ' + months + (months === 1 ? ' month' : ' months');
                            } else if (diffDays >= 30) {
                                const months = Math.floor(diffDays / 30);
                                durationText = months + (months === 1 ? ' month' : ' months');
                            }

                            const keyTypeLabel = license.keyType === 'saas-platform' ? 'SaaS Platform' :
                                                 license.keyType === 'saas-tenant' ? 'SaaS Tenant' : 'On-Premise';

                            return `
                                <div class="license-history-item">
                                    <div class="license-history-header">
                                        <span class="license-history-badge ${status}">${statusText}</span>
                                        <span class="license-history-type">${keyTypeLabel}</span>
                                        <span class="license-history-date">Created ${new Date(license.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                                    </div>
                                    <div class="license-history-details">
                                        <div class="license-history-detail">
                                            <span class="detail-label">Valid From</span>
                                            <span class="detail-value">${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                                        </div>
                                        <div class="license-history-detail">
                                            <span class="detail-label">Expires</span>
                                            <span class="detail-value">${expiryDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                                        </div>
                                        <div class="license-history-detail">
                                            <span class="detail-label">Duration</span>
                                            <span class="detail-value">${durationText}</span>
                                        </div>
                                    </div>
                                    ${license.notes ? `<div class="license-history-notes"><strong>Notes:</strong> ${license.notes}</div>` : ''}
                                    <div class="license-history-token">
                                        <code class="token-preview" id="historyToken${index}">${license.encryptedToken.substring(0, 60)}...</code>
                                        <button class="license-history-copy-btn" onclick="copyHistoryToken('${license.encryptedToken}', this)">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                            </svg>
                                            Copy
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading license history:', error);
                content.innerHTML = `
                    <div class="error-state" style="text-align: center; padding: 40px 20px;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="1.5" style="margin-bottom: 16px;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                        <h4 style="color: var(--text-secondary); margin-bottom: 8px;">Failed to Load Licenses</h4>
                        <p style="color: var(--text-tertiary); font-size: 13px;">${error.message}</p>
                    </div>
                `;
            }
        }

        function copyHistoryToken(token, btn) {
            navigator.clipboard.writeText(token).then(() => {
                const originalHtml = btn.innerHTML;
                btn.classList.add('copied');
                btn.innerHTML = `
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Copied!
                `;

                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = originalHtml;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                Toast.error('Failed to copy to clipboard');
            });
        }

        // ============================================
        // SaaS PLATFORM FUNCTIONS
        // ============================================

        // Load SaaS platforms (deploymentType = 'saas' and no parent)
        async function loadSaaSPlatforms() {
            const includeInactive = document.getElementById('showInactiveSaaS')?.checked || false;

            try {
                const { tenants } = await api.getTenants(includeInactive);
                // Filter to only show SaaS platforms (no parent_tenant_id)
                allSaaSPlatforms = tenants.filter(t => t.deploymentType === 'saas' && !t.parentTenantId);
                renderSaaSPlatforms(allSaaSPlatforms);
            } catch (error) {
                console.error('Failed to load SaaS platforms:', error);
            }
        }

        function filterSaaSPlatforms() {
            const search = document.getElementById('searchSaaSInput').value.toLowerCase();
            const filtered = allSaaSPlatforms.filter(t =>
                t.tenantName.toLowerCase().includes(search) ||
                (t.companyName && t.companyName.toLowerCase().includes(search)) ||
                (t.contactEmail && t.contactEmail.toLowerCase().includes(search))
            );
            renderSaaSPlatforms(filtered);
        }

        function renderSaaSPlatforms(platforms) {
            const container = document.getElementById('saasPlatformsTableBody');

            if (platforms.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state" style="padding: 48px; text-align: center;">
                            <div class="empty-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                    <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                                </svg>
                            </div>
                            <p>No SaaS platforms found. Click "New SaaS Platform" to create one.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            container.innerHTML = platforms.map(platform => {
                // Get license dates from activeLicense if available
                const activeLicense = platform.activeLicense;
                const licenseStart = activeLicense?.startDate ? new Date(activeLicense.startDate).toLocaleDateString() : '-';
                const licenseExpiry = activeLicense?.expiryDate ? new Date(activeLicense.expiryDate).toLocaleDateString() : '-';
                const licenseToken = activeLicense?.encryptedToken || null;
                const maxSubTenants = platform.maxSubTenants || 'Unlimited';

                return `
                    <tr class="saas-platform-row" id="platform-row-${platform.id}" onclick="toggleSaaSPlatform('${platform.id}')">
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <svg class="saas-expand-icon" id="expand-icon-${platform.id}" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                                <strong>${platform.tenantName}</strong>
                            </div>
                        </td>
                        <td>${platform.companyName || '-'}</td>
                        <td>${maxSubTenants}</td>
                        <td>${licenseStart}</td>
                        <td>${licenseExpiry}</td>
                        <td>
                            <div class="keys-group">
                                <button class="btn-icon-sm btn-icon-key" onclick="event.stopPropagation(); copyToClipboard('${platform.id}', 'Tenant Key')" data-tooltip="Copy Tenant Key">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
                                    </svg>
                                </button>
                                ${licenseToken ? `
                                    <button class="btn-icon-sm btn-icon-license" onclick="event.stopPropagation(); copyToClipboard('${escapeHtml(licenseToken)}', 'License Token')" data-tooltip="Copy License Token">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                            <path d="M2 17l10 5 10-5"></path>
                                            <path d="M2 12l10 5 10-5"></path>
                                        </svg>
                                    </button>
                                ` : '<span class="text-muted text-xs">No license</span>'}
                            </div>
                        </td>
                        <td>
                            <span class="badge ${platform.isActive ? 'badge-success' : 'badge-danger'}">
                                ${platform.isActive ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            <div class="actions-group">
                                <button class="btn-icon-sm btn-icon-primary" onclick="event.stopPropagation(); openAddSubTenantModal('${platform.id}', '${platform.tenantName}')" data-tooltip="Add Sub-Tenant">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="8.5" cy="7" r="4"></circle>
                                        <line x1="20" y1="8" x2="20" y2="14"></line>
                                        <line x1="23" y1="11" x2="17" y2="11"></line>
                                    </svg>
                                </button>
                                <button class="btn-icon-sm" onclick="event.stopPropagation(); openEditSaaSPlatformModal('${platform.id}')" data-tooltip="Edit Platform">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button class="btn-icon-sm btn-icon-info" onclick="event.stopPropagation(); openLicenseHistoryModal('${platform.id}', '${platform.tenantName}')" data-tooltip="View Licenses">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                </button>
                                <button class="btn-icon-sm btn-icon-success" onclick="event.stopPropagation(); openLicenseModal('${platform.id}')" data-tooltip="Generate License">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                        <path d="M2 17l10 5 10-5"></path>
                                        <path d="M2 12l10 5 10-5"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr class="saas-subtenants-row" id="subtenants-row-${platform.id}" style="display: none;">
                        <td colspan="8" style="padding: 0; background: var(--bg-tertiary);">
                            <div class="saas-tenants-container" style="padding: 16px;">
                                <div class="saas-tenants-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h5 style="margin: 0; font-size: 14px;">Sub-Tenants</h5>
                                    <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); openAddSubTenantModal('${platform.id}', '${platform.tenantName}')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                        Add Tenant
                                    </button>
                                </div>
                                <div class="saas-tenants-list" id="subtenants-${platform.id}">
                                    <p class="text-muted" style="font-size: 12px; text-align: center; padding: 12px;">Loading sub-tenants...</p>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function toggleSaaSPlatform(platformId) {
            const row = document.getElementById(`platform-row-${platformId}`);
            const subtenantsRow = document.getElementById(`subtenants-row-${platformId}`);
            const expandIcon = document.getElementById(`expand-icon-${platformId}`);

            const isExpanded = row.classList.toggle('expanded');

            if (isExpanded) {
                subtenantsRow.style.display = 'table-row';
                expandIcon.style.transform = 'rotate(90deg)';
                await loadSubTenants(platformId);
            } else {
                subtenantsRow.style.display = 'none';
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }

        async function loadSubTenants(platformId) {
            const container = document.getElementById(`subtenants-${platformId}`);
            container.innerHTML = '<p class="text-muted" style="font-size: 12px; text-align: center; padding: 12px;">Loading...</p>';

            try {
                const { tenants } = await api.getTenants(true);
                // Filter to get sub-tenants of this platform
                const subTenants = tenants.filter(t => t.parentTenantId === platformId);

                if (subTenants.length === 0) {
                    container.innerHTML = '<p class="text-muted" style="font-size: 12px; text-align: center; padding: 12px;">No sub-tenants yet. Click "Add Tenant" to create one.</p>';
                    return;
                }

                container.innerHTML = subTenants.map(tenant => `
                    <div class="saas-tenant-row">
                        <div class="saas-tenant-info">
                            <span class="tenant-name">${tenant.tenantName}</span>
                            <span class="tenant-email">${tenant.contactEmail || '-'}</span>
                        </div>
                        <div class="saas-tenant-meta">
                            <span class="badge badge-info">${tenant.maxUsers} users</span>
                            <span class="badge ${tenant.isActive ? 'badge-success' : 'badge-danger'}">
                                ${tenant.isActive ? 'Active' : 'Inactive'}
                            </span>
                            <button class="btn-icon-sm" onclick="openEditSubTenantModal('${tenant.id}', '${platformId}')" data-tooltip="Edit">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="btn-icon-sm btn-icon-info" onclick="openLicenseHistoryModal('${tenant.id}', '${tenant.tenantName}')" data-tooltip="View Licenses">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                            </button>
                            <button class="btn-icon-sm btn-icon-success" onclick="openLicenseModal('${tenant.id}')" data-tooltip="Generate License">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                    <path d="M2 17l10 5 10-5"></path>
                                    <path d="M2 12l10 5 10-5"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = '<p class="text-danger" style="font-size: 12px; text-align: center; padding: 12px;">Failed to load sub-tenants</p>';
                console.error('Error loading sub-tenants:', error);
            }
        }

        // SaaS Platform Modal Functions
        async function openCreateSaaSPlatformModal() {
            document.getElementById('saasPlatformModalTitle').textContent = 'New SaaS Platform';
            document.getElementById('saasPlatformForm').reset();
            document.getElementById('saasPlatformId').value = '';
            const selectAllBtn = document.querySelector('#saasPlatformModal .services-selection-header .select-all');
            if (selectAllBtn) selectAllBtn.textContent = 'Select All';
            await loadSaaSServices([]);
            openModal('saasPlatformModal');
        }

        async function openEditSaaSPlatformModal(platformId) {
            try {
                const platform = await api.getTenant(platformId);
                document.getElementById('saasPlatformModalTitle').textContent = 'Edit SaaS Platform';
                document.getElementById('saasPlatformId').value = platform.id;
                document.getElementById('saasPlatformName').value = platform.tenantName;
                document.getElementById('saasCompanyName').value = platform.companyName || '';
                document.getElementById('saasContactEmail').value = platform.contactEmail || '';
                document.getElementById('saasContactPhone').value = platform.contactPhone || '';
                document.getElementById('saasAddress').value = platform.address || '';
                document.getElementById('saasNotes').value = platform.notes || '';

                // Load platform's services
                const platformServices = await api.getTenantServices(platformId);
                const selectedServiceIds = platformServices.map(s => s.serviceId);
                await loadSaaSServices(selectedServiceIds);

                openModal('saasPlatformModal');
            } catch (error) {
                Toast.error('Failed to load platform: ' + error.message);
            }
        }

        async function loadSaaSServices(selectedServiceIds = []) {
            const grid = document.getElementById('saasServicesGrid');
            grid.innerHTML = '<span class="text-muted" style="font-size: 12px;">Loading...</span>';

            try {
                const { services } = await api.getServices();
                const activeServices = services.filter(s => s.isActive);

                if (activeServices.length === 0) {
                    grid.innerHTML = '<span class="text-muted" style="font-size: 12px;">No services available</span>';
                    return;
                }

                grid.innerHTML = activeServices.map(service => {
                    const isChecked = selectedServiceIds.includes(service.id);
                    return `
                        <label class="service-checkbox-item ${isChecked ? 'checked' : ''}" data-service-id="${service.id}">
                            <input type="checkbox" name="saasService" value="${service.id}" ${isChecked ? 'checked' : ''} onchange="toggleServiceCheckbox(this)">
                            <span class="service-name">${service.serviceName}</span>
                        </label>
                    `;
                }).join('');
            } catch (error) {
                grid.innerHTML = '<span class="text-danger" style="font-size: 12px;">Failed to load services</span>';
                console.error('Error loading services:', error);
            }
        }

        function toggleAllSaaSServices() {
            const checkboxes = document.querySelectorAll('#saasServicesGrid input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
                toggleServiceCheckbox(cb);
            });

            const btn = document.querySelector('#saasPlatformModal .services-selection-header .select-all');
            btn.textContent = allChecked ? 'Select All' : 'Deselect All';
        }

        async function saveSaaSPlatform() {
            const platformId = document.getElementById('saasPlatformId').value;

            const selectedServiceIds = Array.from(
                document.querySelectorAll('#saasServicesGrid input[type="checkbox"]:checked')
            ).map(cb => cb.value);

            const contactEmail = document.getElementById('saasContactEmail').value;
            const platformData = {
                tenantName: document.getElementById('saasPlatformName').value,
                companyName: document.getElementById('saasCompanyName').value || null,
                contactEmail: contactEmail || null,
                contactPhone: document.getElementById('saasContactPhone').value || null,
                address: document.getElementById('saasAddress').value || null,
                deploymentType: 'saas',  // Always saas for platforms
                maxUsers: -1,  // Unlimited for platform itself
                superAdminEmail: contactEmail || null,
                notes: document.getElementById('saasNotes').value || null,
                serviceIds: selectedServiceIds
            };

            try {
                if (platformId) {
                    await api.updateTenant(platformId, platformData);
                } else {
                    await api.createTenant(platformData);
                }
                closeModal('saasPlatformModal');
                loadSaaSPlatforms();
                Toast.success('SaaS platform saved successfully');
            } catch (error) {
                Toast.error('Failed to save platform: ' + error.message);
            }
        }

        // Sub-Tenant Modal Functions
        let currentParentPlatformId = null;
        let currentParentPlatformServices = [];

        async function openAddSubTenantModal(platformId, platformName) {
            currentParentPlatformId = platformId;
            document.getElementById('subTenantModalTitle').textContent = `Add Tenant to ${platformName}`;
            document.getElementById('subTenantForm').reset();
            document.getElementById('subTenantId').value = '';
            document.getElementById('parentPlatformId').value = platformId;

            const selectAllBtn = document.querySelector('#subTenantModal .services-selection-header .select-all');
            if (selectAllBtn) selectAllBtn.textContent = 'Select All';

            // Load parent platform's services for sub-tenant to choose from
            await loadSubTenantServices(platformId, []);
            openModal('subTenantModal');
        }

        async function openEditSubTenantModal(tenantId, platformId) {
            currentParentPlatformId = platformId;

            try {
                const tenant = await api.getTenant(tenantId);
                document.getElementById('subTenantModalTitle').textContent = 'Edit Tenant';
                document.getElementById('subTenantId').value = tenant.id;
                document.getElementById('parentPlatformId').value = platformId;
                document.getElementById('subTenantName').value = tenant.tenantName;
                document.getElementById('subTenantEmail').value = tenant.contactEmail || '';
                document.getElementById('subTenantMaxUsers').value = tenant.maxUsers;

                // Load tenant's services
                const tenantServices = await api.getTenantServices(tenantId);
                const selectedServiceIds = tenantServices.map(s => s.serviceId);
                await loadSubTenantServices(platformId, selectedServiceIds);

                openModal('subTenantModal');
            } catch (error) {
                Toast.error('Failed to load tenant: ' + error.message);
            }
        }

        async function loadSubTenantServices(platformId, selectedServiceIds = []) {
            const grid = document.getElementById('subTenantServicesGrid');
            grid.innerHTML = '<span class="text-muted" style="font-size: 12px;">Loading...</span>';

            try {
                // Get parent platform's services
                const platformServices = await api.getTenantServices(platformId);
                currentParentPlatformServices = platformServices;

                if (platformServices.length === 0) {
                    grid.innerHTML = '<span class="text-muted" style="font-size: 12px;">No services available from parent platform</span>';
                    return;
                }

                grid.innerHTML = platformServices.map(service => {
                    const isChecked = selectedServiceIds.includes(service.serviceId);
                    return `
                        <label class="service-checkbox-item ${isChecked ? 'checked' : ''}" data-service-id="${service.serviceId}">
                            <input type="checkbox" name="subTenantService" value="${service.serviceId}" ${isChecked ? 'checked' : ''} onchange="toggleServiceCheckbox(this)">
                            <span class="service-name">${service.serviceName}</span>
                        </label>
                    `;
                }).join('');
            } catch (error) {
                grid.innerHTML = '<span class="text-danger" style="font-size: 12px;">Failed to load services</span>';
                console.error('Error loading services:', error);
            }
        }

        function toggleAllSubTenantServices() {
            const checkboxes = document.querySelectorAll('#subTenantServicesGrid input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
                toggleServiceCheckbox(cb);
            });

            const btn = document.querySelector('#subTenantModal .services-selection-header .select-all');
            btn.textContent = allChecked ? 'Select All' : 'Deselect All';
        }

        async function saveSubTenant() {
            const tenantId = document.getElementById('subTenantId').value;
            const parentPlatformId = document.getElementById('parentPlatformId').value;

            const selectedServiceIds = Array.from(
                document.querySelectorAll('#subTenantServicesGrid input[type="checkbox"]:checked')
            ).map(cb => cb.value);

            const contactEmail = document.getElementById('subTenantEmail').value;
            const tenantData = {
                tenantName: document.getElementById('subTenantName').value,
                contactEmail: contactEmail || null,
                deploymentType: 'saas',  // Sub-tenants are also saas type
                maxUsers: parseInt(document.getElementById('subTenantMaxUsers').value),
                superAdminEmail: contactEmail || null,
                parentTenantId: parentPlatformId,  // Link to parent platform
                serviceIds: selectedServiceIds
            };

            try {
                if (tenantId) {
                    await api.updateTenant(tenantId, tenantData);
                } else {
                    await api.createTenant(tenantData);
                }
                closeModal('subTenantModal');
                // Reload sub-tenants for the parent platform
                await loadSubTenants(parentPlatformId);
                Toast.success('Tenant saved successfully');
            } catch (error) {
                Toast.error('Failed to save tenant: ' + error.message);
            }
        }

        // Initial load
        loadTenants();
    </script>
</body>
</html>
