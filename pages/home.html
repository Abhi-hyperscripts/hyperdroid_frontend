<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LXVS357DCK"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-LXVS357DCK');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - HyperDroid</title>
    <script>window.CACHE_VERSION = Date.now();</script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script>document.write('<link rel="stylesheet" href="../css/theme.css?v=' + CACHE_VERSION + '">');</script>
    <script>document.write('<link rel="stylesheet" href="../css/styles.css?v=' + CACHE_VERSION + '">');</script>
    <script>document.write('<script src="../js/theme.js?v=' + CACHE_VERSION + '"><\/script>');</script>
    <script>document.write('<link rel="stylesheet" href="../css/home.css?v=' + CACHE_VERSION + '">');</script>
</head>
<body class="dashboard">
    <nav class="navbar">
        <div class="navbar-brand">
            <a href="home.html">
                <img src="../assets/brand_logo.png" alt="HyperDroid Logo" class="navbar-logo">
            </a>
        </div>
        <div class="navbar-menu">
            <!-- Navigation links rendered by Navigation.init() -->
        </div>
    </nav>

    <div class="home-content">
        <!-- Welcome Section -->
        <div class="welcome-section">
            <p class="welcome-greeting">Good <span id="timeGreeting">morning</span>,</p>
            <h1 class="welcome-title"><span id="userName">User</span></h1>
            <p class="welcome-subtitle">What would you like to do today?</p>
        </div>

        <!-- Futuristic Bento Grid -->
        <div class="bento-grid">
            <!-- Vision Card -->
            <div class="bento-card vision" onclick="navigateToModule('vision')" id="visionCard">
                <div class="card-border"></div>
                <div class="card-content">
                    <div class="card-header">
                        <div class="app-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <polygon points="23 7 16 12 23 17 23 7"/>
                                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                            </svg>
                        </div>
                        <div class="app-status" id="visionStatus">
                            <span class="status-indicator"></span>
                            <span>Checking...</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <h3>Meetings</h3>
                        <p>Video conferencing with screen sharing, chat, and recording</p>
                    </div>
                    <div class="card-footer">
                        <span class="app-action">
                            Launch
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Drive Card -->
            <div class="bento-card drive" onclick="navigateToModule('drive')" id="driveCard">
                <div class="card-border"></div>
                <div class="card-content">
                    <div class="card-header">
                        <div class="app-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                            </svg>
                        </div>
                        <div class="app-status" id="driveStatus">
                            <span class="status-indicator"></span>
                            <span>Checking...</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <h3>Drive</h3>
                        <p>Secure cloud storage with file sharing and organization</p>
                    </div>
                    <div class="card-footer">
                        <span class="app-action">
                            Launch
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Chat Card -->
            <div class="bento-card chat" onclick="navigateToModule('chat')" id="chatCard">
                <div class="card-border"></div>
                <div class="card-content">
                    <div class="card-header">
                        <div class="app-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                        </div>
                        <div class="app-status" id="chatStatus">
                            <span class="status-indicator"></span>
                            <span>Checking...</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <h3>Chat</h3>
                        <p>Real-time messaging with direct and group conversations</p>
                    </div>
                    <div class="card-footer">
                        <span class="app-action">
                            Launch
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </span>
                    </div>
                </div>
            </div>

            <!-- HRMS Card -->
            <div class="bento-card hrms" onclick="navigateToModule('hrms')" id="hrmsCard">
                <div class="card-border"></div>
                <div class="card-content">
                    <div class="card-header">
                        <div class="app-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                        </div>
                        <div class="app-status" id="hrmsStatus">
                            <span class="status-indicator"></span>
                            <span>Checking...</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <h3>HRMS</h3>
                        <p>Human resources with attendance, leave, and payroll</p>
                    </div>
                    <div class="card-footer">
                        <span class="app-action">
                            Launch
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Admin Card (SUPERADMIN only) -->
            <div class="bento-card admin" onclick="navigateToModule('admin')" id="adminCard">
                <div class="card-border"></div>
                <div class="card-content">
                    <div class="card-header">
                        <div class="app-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/>
                            </svg>
                        </div>
                        <div class="app-status admin-badge">
                            <span class="status-indicator"></span>
                            <span>Admin</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <h3>Admin Panel</h3>
                        <p>User management, service monitoring, and configuration</p>
                    </div>
                    <div class="card-footer">
                        <span class="app-action">
                            Launch
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.write('<script src="../js/config.js?v=' + CACHE_VERSION + '"><\/script>');
        document.write('<script src="../js/api.js?v=' + CACHE_VERSION + '"><\/script>');
        document.write('<script src="../js/navigation.js?v=' + CACHE_VERSION + '"><\/script>');
        document.write('<script src="../js/toast.js?v=' + CACHE_VERSION + '"><\/script>');
    </script>
    <script>
        // Check authentication
        document.addEventListener('DOMContentLoaded', () => {
            if (!api.isAuthenticated()) {
                window.location.href = '/index.html';
                return;
            }

            // Initialize navigation
            Navigation.init('home', '');

            initializeUser();
            setTimeGreeting();
            checkModuleStatus();
            showAccessibleModules();
        });

        function setTimeGreeting() {
            const hour = new Date().getHours();
            let greeting;
            if (hour < 12) greeting = 'morning';
            else if (hour < 17) greeting = 'afternoon';
            else greeting = 'evening';
            document.getElementById('timeGreeting').textContent = greeting;
        }

        function initializeUser() {
            const user = api.getUser();
            if (user) {
                document.getElementById('userName').textContent = user.firstName || 'User';
            }
        }

        // Show/hide module cards based on user roles AND licensed services
        function showAccessibleModules() {
            const user = api.getUser();
            if (!user || !user.roles) return;

            const roleMapping = {
                'visionCard': 'VISION_USER',
                'driveCard': 'DRIVE_USER',
                'chatCard': 'CHAT_USER',
                'hrmsCard': 'HRMS_USER',
                'adminCard': 'SUPERADMIN'
            };

            // Service name mapping (matches TenantManager service names)
            const serviceNameMapping = {
                'visionCard': 'Vision',
                'driveCard': 'Drive',
                'chatCard': 'Chat',
                'hrmsCard': 'HRMS'
            };

            // Get licensed services from cached organization info (populated at login from JWT)
            let licensedServices = null;
            const orgInfo = getOrganizationInfo();
            if (orgInfo && orgInfo.licensedServices) {
                licensedServices = orgInfo.licensedServices;
            }

            for (const [cardId, role] of Object.entries(roleMapping)) {
                const card = document.getElementById(cardId);
                if (card) {
                    const hasRole = user.roles.includes('SUPERADMIN') || user.roles.includes(role);

                    // Check if service is licensed (Admin panel is always shown if user has SUPERADMIN role)
                    const serviceName = serviceNameMapping[cardId];
                    const isLicensed = cardId === 'adminCard' ||
                                       !licensedServices ||
                                       licensedServices.includes(serviceName);

                    const hasAccess = hasRole && isLicensed;

                    if (hasAccess) {
                        card.style.display = 'flex';
                        if (cardId === 'adminCard') {
                            card.classList.add('visible');
                        }
                    } else {
                        card.style.display = 'none';
                    }
                }
            }
        }

        async function checkModuleStatus() {
            checkServiceHealth('vision', CONFIG.endpoints.vision);
            checkServiceHealth('drive', CONFIG.endpoints.drive);
            checkServiceHealth('chat', CONFIG.endpoints.chat);
            checkServiceHealth('hrms', CONFIG.endpoints.hrms);
        }

        async function checkServiceHealth(moduleName, endpoint) {
            const statusEl = document.getElementById(`${moduleName}Status`);
            if (!statusEl) return;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(`${endpoint}/health`, {
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (response.ok) {
                    statusEl.className = 'app-status online';
                    statusEl.innerHTML = '<span class="status-indicator"></span><span>Online</span>';
                } else {
                    throw new Error('Service unavailable');
                }
            } catch (error) {
                statusEl.className = 'app-status offline';
                statusEl.innerHTML = '<span class="status-indicator"></span><span>Offline</span>';
            }
        }

        function navigateToModule(module) {
            switch (module) {
                case 'vision':
                    window.location.href = 'vision/dashboard.html';
                    break;
                case 'drive':
                    window.location.href = 'drive/drive.html';
                    break;
                case 'chat':
                    window.location.href = 'chat/chat.html';
                    break;
                case 'hrms':
                    window.location.href = 'hrms/dashboard.html';
                    break;
                case 'admin':
                    window.location.href = 'auth/dashboard.html';
                    break;
            }
        }
    </script>
</body>
</html>
